!function(angular){"use strict";var textViewerDirectives=(angular.module("attTextViewer",["attTextViewerDirectives","infinite-scroll","attTextViewerFilters"]).provider("textViewer",[function(){return{$get:function(){return{}}}}]),angular.module("attTextViewerDirectives",[])),textViewerFilters=angular.module("attTextViewerFilters",[]);textViewerFilters.filter("markRowByCriteria",["$sce",function($sce){return function(row,inputParams){return inputParams.highlightCriteria&&angular.isArray(inputParams.highlightCriteria)&&0!=inputParams.highlightCriteria.length?(row=row.toLocaleString(),angular.forEach(inputParams.highlightCriteria,function(currentCriteria){row.indexOf(currentCriteria.matchExpression)>-1&&(inputParams.pFontSize=inputParams.pFontSize||13,row="<span style='font-size: "+inputParams.pFontSize+"px;' class='"+currentCriteria.cssClassForMatch+"'>"+row+"</span>")}),$sce.trustAsHtml(row)):row}}]),textViewerFilters.filter("markSearchTerm",["$sce",function($sce){return function(text,searchTerm){if(text=text.replaceAll("<","&#60;"),angular.isUndefined(searchTerm)||searchTerm.length<2)return text;for(var lowerCaseText=text.toLowerCase(),lowerCaseSearchTerm=searchTerm.toLowerCase(),counter=0,currentIndex=0,indexOfMatch=lowerCaseText.indexOf(lowerCaseSearchTerm,currentIndex),startTag="<span class='highlightSearchTerm'>",endTag="</span>";indexOfMatch>-1&&50>counter;){counter++;var textBuilder=text.substring(0,indexOfMatch);textBuilder+=startTag+text.substring(indexOfMatch,indexOfMatch+searchTerm.length)+endTag,textBuilder+=text.substring(indexOfMatch+searchTerm.length),text=textBuilder,currentIndex=indexOfMatch+startTag.length+searchTerm.length+endTag.length,lowerCaseText=text.toLowerCase(),indexOfMatch=lowerCaseText.indexOf(lowerCaseSearchTerm,currentIndex)}return $sce.trustAsHtml(text)}}]),textViewerDirectives.directive("attTextViewer",["locale","textViewer","$location","$filter",function(locale,textViewer,$location,$filter){return{restrict:"E",replace:!0,scope:{isDownloadFileEnabled:"=?",textRecords:"=?",hideItemsOnFilter:"=?",getFurtherTextFnc:"&",downloadLogFileFnc:"&",downloadLogFileTooltip:"=?",highlightRowsCriteria:"=?",showSearchBox:"=?",ellipsisTextOverflow:"=?",onRowClickFunc:"&",onRowDblClickFunc:"&",multiSelect:"=?",isFontEffectsEnabled:"=?",subTitle:"=?"},templateUrl:"scripts/angular.common/attTextViewer/textViewerTemplate.html",controller:["$scope","locale",function(){}],compile:function(element){return element.find(".textViewerContent").attr("infinite-scroll-distance",.01),element.find(".textViewerContent").attr("infinite-scroll-immediate-check","false"),element.find(".textViewerContent").attr("infinite-scroll-container","thisScrollArea"),element.find(".textViewerContent").attr("infinite-scroll","pagingFunc()"),function(scope){function onSearchTermKeyUpIntern(){scope.numberTheHits(),scope.scrollToFirstHit(),scope.clearCurrentPrevNextHit(!0)}function scrollToId(itemId){var hitItem=document.querySelector('.textViewerContainer [id="'+itemId+'"]');hitItem&&$(hitItem).get(0).scrollIntoView(!1),hitItem=null}function selectItem(goToNext,clearPrevItem,containerBottom,rowHeight){var item;if(ObjectUtils.isObject(goToNext))item=goToNext;else{var currentItem=$(document.querySelector(".textViewerContainer")).find(".textRecordSelected");item=goToNext?$(currentItem).next():$(currentItem).prev(),currentItem=null}if(0!=item.length){clearPrevItem&&$(".tvRow").removeClass("textRecordSelected"),$(item).focus(),$(item).addClass("textRecordSelected");var itemTop=item.offset().top;itemTop+rowHeight>containerBottom&&scrollToId($(item).attr("id"))}}function getLastVisibleRow(currentRow,containerBottom,rowHeight){var keepLooking=!0,previousRow=currentRow,rowToCheck=$(currentRow).next();if(0==rowToCheck.length)return previousRow;for(;keepLooking;){var rowTop=rowToCheck.offset().top;rowTop+rowHeight>containerBottom?keepLooking=!1:(previousRow=rowToCheck,rowToCheck=rowToCheck.next(),0==rowToCheck.length&&(keepLooking=!1))}return previousRow}function getFirstVisibleRow(currentRow,containerTop){var keepLooking=!0,previousRow=currentRow,rowToCheck=$(currentRow).prev();if(0==rowToCheck.length)return previousRow;for(;keepLooking;){var rowTop=rowToCheck.offset().top;containerTop>rowTop?keepLooking=!1:(previousRow=rowToCheck,rowToCheck=rowToCheck.prev(),0==rowToCheck.length&&(keepLooking=!1))}return previousRow}function pageDownClicked(){var containerElement=$(".textViewerContainer .scrollArea"),containerTop=containerElement.offset().top,containerHeight=containerElement.height(),containerBottom=containerTop+containerHeight,currentRow=$(".textViewerContainer .textRecordSelected"),rowHeight=currentRow.height(),lastVisibleRow=getLastVisibleRow(currentRow,containerBottom,rowHeight);selectItem(lastVisibleRow,!0,containerBottom,rowHeight),angular.equals(currentRow,lastVisibleRow)&&scrollToId($(currentRow)[0].id)}function pageUpClicked(){var containerElement=$(".textViewerContainer .scrollArea"),containerTop=containerElement.offset().top,currentRow=(containerElement.height(),$(".textViewerContainer .textRecordSelected")),firstVisibleRow=(currentRow.height(),getFirstVisibleRow(currentRow,containerTop));if(selectItem(firstVisibleRow,!0),angular.equals(currentRow,firstVisibleRow)){var currentId=$(currentRow)[0].id;currentId=currentId.replace("txtView","");var idToScrollTo=Math.max(currentId-1,0),rowToScrollTo=$("#txtView"+idToScrollTo);selectItem(rowToScrollTo,!0)}}ObjectUtils.isEmpty(scope.highlightRowsCriteria)&&(scope.highlightRowsCriteria=[{matchExpression:"]E:",cssClassForMatch:"rColor"},{matchExpression:"] [ERROR]",cssClassForMatch:"rColor"},{matchExpression:"]W:",cssClassForMatch:"oColor"},{matchExpression:"] [WARN ]",cssClassForMatch:"oColor"}]),scope.auto_scroll=!0,scope.hideItemsOnFilter=null!=scope.hideItemsOnFilter&&0!=scope.hideItemsOnFilter,scope.currentHitByPrevNext=0,scope.filtered_records=scope.textRecords,scope.thisScrollArea=element.find(".scrollArea"),scope.pagingFunc=function(){$location.$$hash!=scope.textRecords.length-1&&scope.getMoreText()},scope.recordsFilter=function(){scope.filtered_records=scope.hideItemsOnFilter?$filter("filter")(scope.textRecords,scope.textSearchTerm):scope.textRecords},scope.$watch("textRecords",function(newV,oldV){scope.recordsFilter(),0==oldV.length&&(scope.textSearchTerm="",scope.clearCurrentPrevNextHit(!0)),scope.numberTheHits()}),scope.isPrevHitDisabled=function(){var searchHits=document.getElementsByClassName("highlightSearchTerm");return searchHits.length<1?!0:scope.currentHitByPrevNext<2?!0:!1},scope.isNextHitDisabled=function(){var searchHits=document.getElementsByClassName("highlightSearchTerm");return searchHits.length<1?!0:scope.currentHitByPrevNext==searchHits.length?!0:!1},scope.stepToHitClicked=function(hitToStepTo){switch(scope.clearCurrentPrevNextHit(),hitToStepTo){case"first":scope.currentHitByPrevNext=1;break;case"last":scope.currentHitByPrevNext=scope.hitsCounter,scope.getMoreText();break;case"previous":scope.currentHitByPrevNext--;break;case"next":scope.currentHitByPrevNext++,scope.currentHitByPrevNext==scope.hitsCounter&&scope.getMoreText()}var nextElementToHighlight=angular.element(document.querySelector('[hitIndex="'+scope.currentHitByPrevNext+'"]'));nextElementToHighlight.addClass("highlightByPrevNext"),nextElementToHighlight=null,scrollToId("hitNum"+scope.currentHitByPrevNext)},scope.onDownloadLogFileFnc=function(){angular.isDefined(scope.downloadLogFileFnc)&&(scope.auto_scroll=!1,scope.downloadLogFileFnc()())},scope.clearCurrentPrevNextHit=function(initCurrentHit){initCurrentHit&&(scope.currentHitByPrevNext=0);var current=document.querySelector(".highlightByPrevNext");current&&angular.element(current).removeClass("highlightByPrevNext"),current=null},scope.textSearchIconClicked=function(){scope.textSearchTerm="",scope.recordsFilter(),scope.numberTheHits(),scope.clearCurrentPrevNextHit(!0)},scope.textSearchTerm="",scope.onSearchTermKeyUp=function(){scope.recordsFilter(),scope.hideItemsOnFilter?setTimeout(function(){onSearchTermKeyUpIntern()},0):onSearchTermKeyUpIntern()},scope.scrollToFirstHit=function(){scrollToId("hitNum1")},scope.numberTheHits=function(){if(scope.hitsCounter=0,""!=scope.textSearchTerm){var searchHits=document.getElementsByClassName("highlightSearchTerm");angular.forEach(searchHits,function(hitItem){scope.hitsCounter++;var hitElement=angular.element(hitItem);hitElement.attr("hitIndex",scope.hitsCounter),hitElement.attr("id","hitNum"+scope.hitsCounter)})}},scope.getMoreText=function(){angular.isDefined(scope.getFurtherTextFnc)&&angular.isDefined(scope.getFurtherTextFnc())&&scope.getFurtherTextFnc()(scope.moreTextRetrieved)},scope.moreTextRetrieved=function(){setTimeout(function(){scope.numberTheHits()},800)},scope.getSelectedItems=function(){var selected_items_el=$(document.querySelector(".textViewerContainer")).find(".textRecordSelected"),selected_items=[];return angular.forEach(selected_items_el,function(item){selected_items.push({name:$(item).text(),id:$(item).attr("id")})}),selected_items_el=null,selected_items},scope.textRecordClicked=function(event){0==event.ctrlKey&&0==event.metaKey||0==scope.multiSelect?selectItem($(event.currentTarget),!0):$(event.currentTarget).hasClass("textRecordSelected")?$(event.currentTarget).removeClass("textRecordSelected"):selectItem($(event.currentTarget),!1),angular.isFunction(scope.onRowClickFunc)&&angular.isFunction(scope.onRowClickFunc())&&scope.onRowClickFunc()(scope.getSelectedItems())},scope.textRecordDblClicked=function(){angular.isFunction(scope.onRowClickFunc)&&angular.isFunction(scope.onRowClickFunc())&&scope.onRowDblClickFunc()(scope.getSelectedItems())},scope.handleOnKeyDown=function(event){var isCtrlC=(event.ctrlKey||event.metaKey)&&event.keyCode==consts.ConstKey.C_char;switch(isCtrlC||event.preventDefault(),$(".tooltip").remove(),event.keyCode){case consts.ConstKey.ArrowDown:selectItem(!0,!0);break;case consts.ConstKey.ArrowUp:selectItem(!1,!0);break;case consts.ConstKey.PageDown:pageDownClicked();break;case consts.ConstKey.PageUp:pageUpClicked()}(event.keyCode==consts.ConstKey.ArrowDown||event.keyCode==consts.ConstKey.ArrowUp)&&angular.isFunction(scope.onRowClickFunc)&&angular.isFunction(scope.onRowClickFunc())&&scope.onRowClickFunc()(scope.getSelectedItems())},scope.setFontSize=function(val){scope.pFontSize=val}}},link:function(scope){scope.$on("$destroy",function(){scope.thisScrollArea=null})}}}])}(angular);
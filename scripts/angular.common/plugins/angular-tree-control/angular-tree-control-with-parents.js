!function(angular){"use strict";angular.module("treeControl",[]).directive("treecontrol",["$compile",function($compile){function classIfDefined(cssClass,addClassProperty){return cssClass?addClassProperty?'class="'+cssClass+'"':cssClass:""}function ensureDefault(obj,prop,value){obj.hasOwnProperty(prop)||(obj[prop]=value)}return{restrict:"EA",require:"treecontrol",transclude:!0,scope:{treeModel:"=",selectedNode:"=?",expandedNodes:"=?",onSelection:"&",onNodeToggle:"&",options:"=?",orderBy:"@",reverseOrder:"@",filterExpression:"=?",filterComparator:"=?"},controller:["$scope","$filter",function($scope,$filter){function defaultIsLeaf(node){var isLeafRes=!node[$scope.options.nodeChildren]||0===node[$scope.options.nodeChildren].length||0==$filter("filter")(node[$scope.options.nodeChildren],$scope.filterExpression).length;return isLeafRes}function defaultEquality(a,b){return void 0===a||void 0===b?!1:(a=angular.copy(a),a[$scope.options.nodeChildren]=[],b=angular.copy(b),b[$scope.options.nodeChildren]=[],angular.equals(a,b))}$scope.options=$scope.options||{},ensureDefault($scope.options,"nodeChildren","children"),ensureDefault($scope.options,"dirSelectable","true"),ensureDefault($scope.options,"injectClasses",{}),ensureDefault($scope.options.injectClasses,"ul",""),ensureDefault($scope.options.injectClasses,"li",""),ensureDefault($scope.options.injectClasses,"liSelected",""),ensureDefault($scope.options.injectClasses,"iExpanded",""),ensureDefault($scope.options.injectClasses,"iCollapsed",""),ensureDefault($scope.options.injectClasses,"iLeaf",""),ensureDefault($scope.options.injectClasses,"label",""),ensureDefault($scope.options.injectClasses,"labelSelected",""),ensureDefault($scope.options,"equality",defaultEquality),ensureDefault($scope.options,"isLeaf",defaultIsLeaf),$scope.expandedNodes=$scope.expandedNodes||[],$scope.expandedNodesMap={};for(var i=0;i<$scope.expandedNodes.length;i++)$scope.expandedNodesMap[""+i]=$scope.expandedNodes[i];$scope.parentScopeOfTree=$scope.$parent,$scope.headClass=function(node){var returnClass="",liSelectionClass=classIfDefined($scope.options.injectClasses.liSelected,!1),injectSelectionClass="";return liSelectionClass&&$scope.options.equality(this.node,$scope.selectedNode)&&(injectSelectionClass=" "+liSelectionClass),returnClass=$scope.options.isLeaf(node)?"tree-leaf"+injectSelectionClass:$scope.expandedNodesMap[this.$id]||this.node[$scope.options.expandedProp]&&!this.touched?"tree-expanded"+injectSelectionClass:"tree-collapsed"+injectSelectionClass},$scope.iBranchClass=function(){return classIfDefined($scope.expandedNodesMap[this.$id]?$scope.options.injectClasses.iExpanded:$scope.options.injectClasses.iCollapsed)},$scope.nodeExpanded=function(){return!!$scope.expandedNodesMap[this.$id]||$scope.options.expandAll&&!this.touched||this.node[$scope.options.expandedProp]},$scope.selectNodeHead=function(){var transcludedScope=this,expanding=void 0===$scope.expandedNodesMap[transcludedScope.$id];if($scope.expandedNodesMap[transcludedScope.$id]=expanding?transcludedScope.node:void 0,expanding)$scope.expandedNodes.push(transcludedScope.node);else{for(var index,i=0;i<$scope.expandedNodes.length&&!index;i++)$scope.options.equality($scope.expandedNodes[i],transcludedScope.node)&&(index=i);void 0!==index&&$scope.expandedNodes.splice(index,1)}if($scope.onNodeToggle){var parentNode=transcludedScope.$parent.node===transcludedScope.synteticRoot?null:transcludedScope.$parent.node;$scope.onNodeToggle({node:transcludedScope.node,$parentNode:parentNode,$index:transcludedScope.$index,$first:transcludedScope.$first,$middle:transcludedScope.$middle,$last:transcludedScope.$last,$odd:transcludedScope.$odd,$even:transcludedScope.$even,expanded:expanding})}},$scope.selectNodeLabel=function(selectedNode){var transcludedScope=this;if(selectedNode[$scope.options.nodeChildren]&&selectedNode[$scope.options.nodeChildren].length>0&&!$scope.options.dirSelectable);else{var selected=!1;if($scope.selectedNode=$scope.selectedNode!=selectedNode?selectedNode:void 0,$scope.onSelection)var parentNode=transcludedScope.$parent.node===transcludedScope.synteticRoot?null:transcludedScope.$parent.node;$scope.onSelection({node:selectedNode,selected:selected,$parentNode:parentNode,$index:transcludedScope.$index,$first:transcludedScope.$first,$middle:transcludedScope.$middle,$last:transcludedScope.$last,$odd:transcludedScope.$odd,$even:transcludedScope.$even})}},$scope.selectedClass=function(){var labelSelectionClass=classIfDefined($scope.options.injectClasses.labelSelected,!1),injectSelectionClass="";return labelSelectionClass&&this.node==$scope.selectedNode&&(injectSelectionClass=" "+labelSelectionClass),this.node==$scope.selectedNode?"tree-selected"+injectSelectionClass:""};var template="<ul "+classIfDefined($scope.options.injectClasses.ul,!0)+'><li ng-repeat="node in node.'+$scope.options.nodeChildren+' | filter:filterExpression:filterComparator | orderBy:orderBy:reverseOrder" ng-class="headClass(node)" '+classIfDefined($scope.options.injectClasses.li,!0)+'><i class="tree-branch-head" ng-class="iBranchClass()" ng-click="selectNodeHead(node)"></i><i class="tree-leaf-head '+classIfDefined($scope.options.injectClasses.iLeaf,!1)+'"></i><div class="tree-label '+classIfDefined($scope.options.injectClasses.label,!1)+'" ng-class="selectedClass()" ng-click="selectNodeLabel(node)" tree-transclude></div><treeitem ng-if="nodeExpanded()"></treeitem></li></ul>';this.template=$compile(template)}],compile:function(element,attrs,childTranscludeFn){return function(scope,element,attrs,treemodelCntr){scope.$watch("treeModel",function(newValue){if(angular.isArray(newValue)){if(angular.isDefined(scope.node)&&angular.equals(scope.node[scope.options.nodeChildren],newValue))return;scope.node={},scope.synteticRoot=scope.node,scope.node[scope.options.nodeChildren]=newValue}else{if(angular.equals(scope.node,newValue))return;scope.node=newValue}}),scope.$treeTransclude=childTranscludeFn,scope.$applyAsync(function(){treemodelCntr.template(scope,function(clone){element.html("").append(clone)})})}}}}]).directive("treeitem",function(){return{restrict:"E",require:"^treecontrol",link:function(scope,element,attrs,treemodelCntr){treemodelCntr.template(scope,function(clone){element.html("").append(clone)})}}}).directive("treeTransclude",function(){return{link:function(scope,element){scope.options.isLeaf(scope.node)||angular.forEach(scope.expandedNodesMap,function(node,id){scope.options.equality(node,scope.node)&&(scope.expandedNodesMap[scope.$id]=scope.node,scope.expandedNodesMap[id]=void 0)}),scope.options.equality(scope.node,scope.selectedNode)&&(scope.selectedNode=scope.node),scope.transcludeScope=scope.parentScopeOfTree.$new(),scope.$evalAsync(function(){scope.transcludeScope.node=scope.node,scope.transcludeScope.$parentNode=scope.$parent.node===scope.synteticRoot?null:scope.$parent.node,scope.transcludeScope.$index=scope.$index,scope.transcludeScope.$first=scope.$first,scope.transcludeScope.$middle=scope.$middle,scope.transcludeScope.$last=scope.$last,scope.transcludeScope.$odd=scope.$odd,scope.transcludeScope.$even=scope.$even,scope.$on("$destroy",function(){scope.transcludeScope.$destroy()}),scope.$treeTransclude(scope.transcludeScope,function(clone){element.empty(),element.append(clone)})})}}})}(angular);
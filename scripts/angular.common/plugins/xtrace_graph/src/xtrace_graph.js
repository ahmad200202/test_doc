function XTraceDAG(attachPoint,GRAPH_DATA,params){function onNodeDoubleClick(d){onEditNode([d])}function onEditNode(nodes){if(nodes){var items=nodes.map(function(it){return it.report});params.onNodeDbClick&&params.onNodeDbClick(items)}}function onAddRelation(entity,referredEntity){params.onMenuAddRelation&&params.onMenuAddRelation(referredEntity.report,entity.report)}function hideNodes(nodes,selectionname){var selectionExists=history.filter(function(hist_item){return hist_item.name==selectionname});1==selectionExists.length&&history.remove(selectionExists[0]);var item=history.addSelection(nodes,selectionname);null!=listSVG&&null!=listSVG.node()&&d3.select(listSVG.node()).attr("style","display:inline;"),params.lightweight||graphSVG.classed("hovering",!1),listSVG.datum(history).call(DAGHistory);var bbox=DAGHistory.bbox().call(DAGHistory.select.call(listSVG.node(),item),item),transform=zoom.getTransform(bbox);DAG.removenode(function(){params.lightweight?d3.select(this).remove():d3.select(this).classed("visible",!1).transition().duration(800).attr("transform",transform).remove()}),dag.draw();var selected={};graphSVG.selectAll(".node.selected").data().forEach(function(d){selected[d.id]=!0}),graphSVG.selectAll(".edge").classed("selected",function(d){return selected[d.source.id]&&selected[d.target.id]})}function listSVGOnClick(d,i){removeNodesFromHistory(!0,d,i)}function removeNodesFromHistory(from_click,d){if(!from_click||d.name!=params.date_model_title){history.remove(d),listSVG.datum(history).call(DAGHistory),0==history.length&&null!=listSVG&&null!=listSVG.node()&&d3.select(listSVG.node()).attr("style","display:none;");var transform=zoom.getTransform(DAGHistory.bbox().call(listSVG.select("svg").node(),d));DAG.newnodetransition(function(){DAG.animate()?d3.select(this).attr("transform",transform).transition().duration(800).attr("transform",DAG.nodeTranslate):d3.select(this).attr("transform",transform).attr("transform",DAG.nodeTranslate)}),dag.draw()}}function attachContextMenus(){params.allow_context_menu&&null!=DAGContextMenu&&(DAGContextMenu.call(graphSVG.node(),graphSVG.selectAll(".node")),DAGContextMenu.on("open",function(){$(".context-menu").remove(),handleTooltip()}).on("hidenodes",hideNodes).on(dag.cMenuParams.actions.edit_node.operation,onEditNode).on(dag.cMenuParams.actions.add_relation_left_and_right.operation,onAddRelation).on("close",function(){params.lightweight||(graphSVG.selectAll(".node").classed("preview",!1),graphSVG.selectAll(".edge").classed("preview",!1))}).on("hovernodes",function(nodes){if(!params.lightweight){graphSVG.selectAll(".node").classed("preview",function(d){return-1!=nodes.indexOf(d)});var previewed={};graphSVG.selectAll(".node.preview").data().forEach(function(d){previewed[d.id]=!0}),graphSVG.selectAll(".edge").classed("preview",function(d){return previewed[d.source.id]&&previewed[d.target.id]})}}).on("selectnodes",function(nodes){var selected={};nodes.forEach(function(d){selected[d.id]=!0}),graphSVG.selectAll(".node").classed("selected",function(d){var selectme=selected[d.id];return(d3.event.ctrlKey||d3.event.metaKey)&&(selectme=selectme||d3.select(this).classed("selected")),selectme}),graphSVG.selectAll(".edge").classed("selected",function(d){var selectme=selected[d.source.id]&&selected[d.target.id];return(d3.event.ctrlKey||d3.event.metaKey)&&(selectme=selectme||d3.select(this).classed("selected")),selectme}),attachContextMenus(),handleTooltip()}).on(dag.cMenuParams.actions.lineage.operation,function(){var d=d3.select(this).data()[0];params.onMenuEntityLineage&&params.onMenuEntityLineage(d.report)}).on(dag.cMenuParams.actions.handle_foreign_keys.operation,function(nodes,show){var d=d3.select(this).data()[0];d.show_foreign_keys=show,dag.draw()}).on(dag.cMenuParams.actions.handle_primary_keys.operation,function(nodes,show){if(null!=nodes&&nodes.length>0){for(var i=0;i<nodes.length;i++)nodes[i].show_primary_keys=show;dag.draw()}}).on(dag.cMenuParams.actions.add_relationship.operation,function(){var d=d3.select(this).data()[0];d3.select(this).classed("selected",!0),params.onMenuAddRelation(d.report,null,function(data){graph=createGraphFromReports(data,params),dag.draw()})}).on("add_relation_by_side",function(left_side){var d=d3.select(this).data()[0];d.is_left_add_relation=left_side;var left_entity=graphSVG.selectAll(".left_selected"),right_referredEntity=null;left_side?(graphSVG.selectAll(".left_selected").classed("left_selected",!1).classed("selected",!1),d3.select(this).classed("selected left_selected",!0)):(graphSVG.selectAll(".right_selected").classed("right_selected",!1).classed("selected",!1),d3.select(this).classed("selected right_selected",!0),right_referredEntity=graphSVG.selectAll(".right_selected")),attachContextMenus(),params.onMenuAddRelation&&left_entity&&right_referredEntity&&1==left_entity.data().length&&1==right_referredEntity.data().length&&params.onMenuAddRelation(left_entity.data()[0].report,right_referredEntity.data()[0].report,function(data){graph=createGraphFromReports(data,params),dag.draw(),graphSVG.selectAll(".left_selected").classed("left_selected",!1),graphSVG.selectAll(".right_selected").classed("right_selected",!1),attachContextMenus()},function(){graphSVG.selectAll(".left_selected").classed("left_selected",!1),graphSVG.selectAll(".right_selected").classed("right_selected",!1),attachContextMenus()})}).on(dag.cMenuParams.actions.delete_relationship.operation,function(d){params.onMenuDeleteRelation(d.source.report,d.target.report,function(data){graph=createGraphFromReports(data,params),dag.draw()})}))}function handleTooltip(){params.show_tooltips&&null!=DAGTooltip&&DAGTooltip.hide()}function setupEvents(){function highlightPath(center){var path=getEntirePathLinks(center),pathnodes={},pathlinks={},immediatenodes={},immediatelinks={};path.forEach(function(p){pathnodes[p.source.id]=!0,pathnodes[p.target.id]=!0,pathlinks[p.source.id+p.target.id]=!0}),edges.classed("hovered",function(d){return pathlinks[d.source.id+d.target.id]}),nodes.classed("hovered",function(d){return pathnodes[d.id]}),immediatenodes[center.id]=!0,center.getVisibleParents().forEach(function(p){immediatenodes[p.id]=!0,immediatelinks[p.id+center.id]=!0}),center.getVisibleChildren().forEach(function(p){immediatenodes[p.id]=!0,immediatelinks[center.id+p.id]=!0}),edges.classed("immediate",function(d){return immediatelinks[d.source.id+d.target.id]}),nodes.classed("immediate",function(d){return immediatenodes[d.id]})}var nodes=graphSVG.selectAll(".node"),edges=graphSVG.selectAll(".edge"),items=listSVG.selectAll(".item"),select=Selectable().getrange(function(a,b){var path=getNodesBetween(a,b).concat(getNodesBetween(b,a));return nodes.data(path,DAG.nodeid())}).on("select",function(){var selected={},nodes=graphSVG.selectAll(".node.selected");nodes.data().forEach(function(d){selected[d.id]=!0}),edges.classed("selected",function(d){return selected[d.source.id]&&selected[d.target.id]}),null!=params.onNodeClick&&params.onNodeClick(null!=nodes.node()&&1==nodes[0].length?nodes.data()[0]:null),attachContextMenus(),handleTooltip()});params.allow_selection&&select(nodes),params.lightweight||nodes.on("mouseover",function(d){graphSVG.classed("hovering",!0),highlightPath(d)}).on("mouseout",function(){graphSVG.classed("hovering",!1),edges.classed("hovered",!1).classed("immediate",!1),nodes.classed("hovered",!1).classed("immediate",!1)}),nodes.on("dblclick",onNodeDoubleClick),items.on("click",listSVGOnClick)}var dag=this;this.cMenuParams={isDateTimeNode:function(node){var ret=!1;return null!=node&&null!=node.report&&null!=params.date_time_node_ids&&(ret=params.date_time_node_ids.indexOf(node.report.time_model_entity_id)>-1),ret},actions:{handle_foreign_keys:{operation:"handle_foreign_keys",display_name:"relationship attributes"},handle_primary_keys:{operation:"handle_primary_keys",display_name:"keys"},add_relationship:{operation:"add_relationship",display_name:"Add relationship..."},select_add_relation_left:{operation:"select_add_relation_left",display_name:"Set as relationship source"},add_relation_left_and_right:{operation:"add_relation_left_and_right",display_name:""},select_add_relation_right:{operation:"select_add_relation_right",display_name:"Relationship target for  "},delete_relationship:{operation:"delete_relationship",display_name:"Delete Relationship"},hide_selected:{operation:"hide_selected",display_name:"Hide selected nodes"},hide_unselected:{operation:"hide_unselected",display_name:"Hide non-selected nodes"},hide_this:{operation:"hide_this",display_name:"Hide this node"},invert_selection:{operation:"invert_selection",display_name:"Invert selection"},select_all:{operation:"select_all",display_name:"Select all"},select_path:{operation:"select_path",display_name:"Select path"},select_and_hide_nodes:{operation:"select_and_hide_nodes",display_name:"Select path and hide all other nodes"},edit_node:{operation:"edit_node",display_name:"Edit"},lineage:{operation:"lineage",display_name:"Lineage"}}},this.show_console_logs=params.show_console_logs,this.is_dragging=!1;var rootSVG=d3.select(attachPoint).append("svg").attr("width","100%").attr("height","100%"),graphSVG=rootSVG.append("svg").attr("width","100%").attr("height","100%").attr("class","graph-attach"),size_factor=50,defs=rootSVG.append("defs"),filter=defs.append("filter").attr("id","drop-shadow").attr("height","150%");filter.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",5).attr("result","blur");var feMerge=(filter.append("feOffset").attr("in","blur").attr("dx",5).attr("dy",5).attr("result","offsetBlur"),filter.append("feMerge"));feMerge.append("feMergeNode").attr("in","offsetBlur"),feMerge.append("feMergeNode").attr("in","SourceGraphic"),graphSVG.node().oncontextmenu=function(){return!1};var minimapSVG=null;params.show_minimap&&(minimapSVG=rootSVG.append("svg").attr("class","minimap-attach"));var listSVG=rootSVG.append("svg").attr("class","history-attach"),graph=createGraphFromReports(GRAPH_DATA,params),history=DirectedAcyclicGraphHistory(),DAG=DirectedAcyclicGraph(params).animate(!params.lightweight),DAGMinimap=params.show_minimap?DirectedAcyclicGraphMinimap(DAG).width("19.5%").height("19.5%").x("80%").y("80%"):null,DAGHistory=List().width("15%").height("99%").x("0.5%").y("0.5%"),DAGTooltip=null,DAGContextMenu=params.allow_context_menu?DirectedAcyclicGraphContextMenu(graph,graphSVG,this.cMenuParams):null,dragDropManager=null,refreshViewport=function(animated){var t=zoom.translate(),scale=zoom.scale(),transform="translate("+t[0]+","+t[1]+") scale ("+scale+")";onZoomStart(),animated?graphSVG.select(".graph").transition().duration(300).attr("transform",transform).each("end",function(){zoom.translate([t[0],t[1]]).scale(scale),graphSVG.selectAll(".node text").attr("opacity",1),onZoomEnd()}):(graphSVG.select(".graph").attr("transform",transform),onZoomEnd()),minimapSVG&&minimapSVG.select(".viewfinder").attr("x",-t[0]/scale).attr("y",-t[1]/scale).attr("width",attachPoint.offsetWidth/scale).attr("height",attachPoint.offsetHeight/scale),params.lightweight||graphSVG.selectAll(".node text").attr("opacity",3*scale-.3)},onZoomStart=function(){params.onZoomStartFunc&&zoom&&params.onZoomStartFunc(zoom.translate(),zoom.scale())},onZoomEnd=function(){params.onZoomEndFunc&&zoom&&params.onZoomEndFunc(zoom.translate(),zoom.scale())},zoom=MinimapZoom(params).scaleExtent([params.minZoomVal||.01,params.maxZoomVal||2]).on("zoom",function(){dag.is_dragging||refreshViewport(!1)});zoom.call(this,rootSVG,minimapSVG);var resetViewport=function(){var curbbox=graphSVG.node().getBBox(),bbox={x:curbbox.x,y:curbbox.y,width:curbbox.width+size_factor,height:curbbox.height+size_factor},scale=Math.min(attachPoint.offsetWidth/bbox.width,attachPoint.offsetHeight/bbox.height),w=attachPoint.offsetWidth/scale,h=attachPoint.offsetHeight/scale,tx=((w-bbox.width)/2-bbox.x+25)*scale,ty=((h-bbox.height)/2-bbox.y+25)*scale;params.max_scale?dag.fnCenterGraph(!0,!0,!1):(zoom.translate([tx,ty]).scale(scale),refreshViewport(!1))};this.draw=function(){var begin=(new Date).getTime(),start=(new Date).getTime();d3.select(graphSVG.node()).selectAll(".edge").remove(),handleTooltip(),this.show_console_logs&&console.log("draw begin"),graphSVG.datum(graph).call(DAG),this.show_console_logs&&console.log("draw graph",(new Date).getTime()-start),start=(new Date).getTime(),params.show_minimap&&minimapSVG.datum(graphSVG.node()).call(DAGMinimap),this.show_console_logs&&console.log("draw minimap",(new Date).getTime()-start),start=(new Date).getTime(),null!=DAGTooltip&&(this.handleToolTips(params.show_tooltips),graphSVG.selectAll(".node").call(DAGTooltip)),this.show_console_logs&&console.log("draw tooltips",(new Date).getTime()-start),start=(new Date).getTime(),setupEvents(),this.show_console_logs&&console.log("draw events",(new Date).getTime()-start),start=(new Date).getTime(),refreshViewport(!1),this.show_console_logs&&console.log("draw viewport",(new Date).getTime()-start),start=(new Date).getTime(),attachContextMenus(),this.show_console_logs&&console.log("draw contextmenus",(new Date).getTime()-start),this.show_console_logs&&console.log("draw complete, total time = ",(new Date).getTime()-begin)},params.allow_drag_drop&&(dragDropManager=function(){function grab(element,event){if(3!=event.which&&null!=event.target.parentNode&&d3.select(event.target.parentNode).classed("node")&&(dragTarget=event.target.parentNode.cloneNode(!0),null!=dragTarget&&(dragTarget.__data__=event.target.parentNode.__data__),dag.is_dragging=null!=dragTarget&&null!=dragTarget.__data__&&void 0!=dragTarget.__data__,dag.is_dragging&&!dag.cMenuParams.isDateTimeNode(dragTarget.__data__))){var transMatrix=null;try{transMatrix=graphSVG.node().getScreenCTM().inverse().multiply(d3.select(event.target).node().getScreenCTM())}catch(err){transMatrix=dragTarget.getCTM()}if(grabPointX=trueCoordX-Number(transMatrix.e),grabPointY=trueCoordY-Number(transMatrix.f),null!=event.target.parentNode.getScreenCTM){var initialMatrix=graphSVG.node().getScreenCTM().inverse().multiply(event.target.parentNode.getScreenCTM());d3.select(dragTarget).attr("class","").attr("class","node dragging"),d3.select(dragTarget).select("rect").attr("width","180").attr("height","30"),d3.select(dragTarget).select("rect").style("filter","url(#drop-shadow)"),d3.select(dragTarget).select("text").attr("y",-5),d3.select(dragTarget).attr("transform","translate("+initialMatrix.e+","+initialMatrix.f+")"),element.appendChild(dragTarget),d3.select(dragTarget).attr("pointer-events","none")}}}function drag(element,event){var newScale=graphSVG.node().currentScale,translation=graphSVG.node().currentTranslate;if(trueCoordX=(event.clientX-translation.x)/newScale,trueCoordY=(event.clientY-translation.y)/newScale,dragTarget){var newX=trueCoordX-grabPointX,newY=trueCoordY-grabPointY;d3.select(dragTarget).attr("transform","translate("+newX+","+newY+")")}}function drop(element,event){if(dag.is_dragging=!1,dragTarget&&!dag.cMenuParams.isDateTimeNode(dragTarget.__data__)){d3.select(dragTarget).attr("pointer-events","all");var targetElement=event.target;$(dragTarget).remove(),targetElement==graphSVG.node()||null==targetElement.__data__||dag.cMenuParams.isDateTimeNode(targetElement.__data__)||null!=dragTarget.__data__.report&&dragTarget.__data__.report.item_id!=targetElement.__data__.report.item_id&&onAddRelation(dragTarget.__data__,targetElement.__data__),dragTarget=null}}this.on("mousedown",function(){grab(this,d3.event)}).on("mousemove",function(){drag(this,d3.event)}).on("mouseup",function(){drop(this,d3.event)});var trueCoordX=null,trueCoordY=null,grabPointX=null,grabPointY=null,dragTarget=null},rootSVG.call(dragDropManager));var self=this;setTimeout(function(){self.draw(),resetViewport()},300),this.reports=GRAPH_DATA,this.graph=graph,this.history=history,this.DAG=DAG,this.DAGMinimap=DAGMinimap,this.DAGHistory=DAGHistory,this.DAGTooltip=DAGTooltip,this.DAGContextMenu=DAGContextMenu;var fnOnZoomGraph=function(X,Y,scale,zoomIn,animated){if(null!=zoom){var scaleExtent=zoom.scaleExtent(),minScale=scaleExtent[0],maxScale=scaleExtent[1],zoom_factor=scale/zoom.scale(),height=parseFloat(attachPoint.clientHeight),width=parseFloat(attachPoint.clientWidth),newScale=zoom.scale()*zoom_factor,newX=(X-width/2)*zoom_factor+width/2,newY=(Y-height/2)*zoom_factor+height/2;newScale>=minScale&&maxScale>=newScale?(zoom.translate([newX,newY]).scale(newScale),refreshViewport(animated)):onZoomEnd()}};this.fnGoToNode=function(node,scale_to){if(null!=node){var x=-node.x,y=-node.y,scale=scale_to||1.5;x=x*scale+$(attachPoint).width()/2,y=y*scale+$(attachPoint).height()/2,zoom.translate([x,y]).scale(scale),refreshViewport(!0)}},this.fnOnZoom=function(zoomIn,scale,animated,callback){var graphSVGBBox=graphSVG.node().getBBox();null!=graphSVGBBox&&fnOnZoomGraph(graphSVGBBox.x,graphSVGBBox.y,scale,zoomIn,animated,callback)},this.fnSetZoomScale=function(zoomIn,scale,animated){refreshViewport(animated)},this.fnCenterGraph=function(resetTranslate,resetScale,animated){var graphCurbbox=graphSVG.select(".graph").node().getBBox(),translate=[0,0],scale=1;if(resetScale){var scaleByWidth=attachPoint.offsetWidth/(graphCurbbox.width+graphCurbbox.x/2+size_factor),scaleByHeight=attachPoint.offsetHeight/(graphCurbbox.height+graphCurbbox.y/2+size_factor);scale=Math.min(scaleByHeight,scaleByWidth),params.max_scale&&(scale=Math.min(params.max_scale,scale))}if(resetTranslate){var tx=((attachPoint.offsetWidth/scale-graphCurbbox.width)/2-graphCurbbox.x)*scale,ty=((attachPoint.offsetHeight/scale-graphCurbbox.height)/2-graphCurbbox.y)*scale;translate=[tx,ty]}zoom.translate(translate).scale(scale),refreshViewport(animated)},this.fnGetScale=function(){return null!=zoom?zoom.scale():1},this.fnSelectNodeNoScale=function(node_name){var self=this;graphSVG.selectAll(".node").each(function(d){d.id.toLowerCase()==node_name.toLowerCase()&&(self.fnGoToNode(d,self.fnGetScale()),d3.select(this).classed("selected",!0))})},this.fnSelectNode=function(node_name,zoom_node,exact_match){var self=this,found_nodes=!1;graphSVG.selectAll(".node").each(function(){d3.select(this).classed("selected",!1)}),graphSVG.selectAll(".node").each(""==node_name?function(){d3.select(this).classed("hovered",!1).classed("immediate",!1)}:function(d){exact_match?(found_nodes=d.id.toLowerCase()==node_name.toLowerCase(),found_nodes&&zoom_node&&self.fnGoToNode(d,null)):found_nodes=d.id.toLowerCase().indexOf(node_name.toLowerCase())>-1,found_nodes?exact_match?d3.select(this).classed("selected",!0):d3.select(this).classed("hovered",!0).classed("immediate",!0):d3.select(this).classed("hovered",!1).classed("immediate",!1)}),graphSVG.classed("hovering",found_nodes)},this.onResize=function(){},this.changeDirection=function(dir){params.direction!=dir&&(params.direction=dir,dag.draw())},this.onDestrory=function(){$(".context-menu").remove()},this.handleToolTips=function(show){params.show_tooltips=show,DAGTooltip.setEnabled(show)},this.handlePkFk=function(show_fk,show_pk){graphSVG.selectAll(".node").data().forEach(function(d){d.show_foreign_keys=show_fk,d.show_primary_keys=show_pk}),dag.draw()},this.onHideItemsByProp=function(show,predicate){if(show){if(null!=history)var d=history.filter(function(item){return item.name==params.date_model_title});d.length>0&&removeNodesFromHistory(!1,d[0])}else{var nodes=graphSVG.selectAll(".node").data().filter(predicate);nodes.length>0&&hideNodes(nodes,params.date_model_title)}},this.updateGraphData=function(data,show_fk,show_pk){if(graph=createGraphFromReports(data,params),null!=graph&&graph.nodelist&&(show_fk||show_pk))for(var i=0;i<graph.nodelist.length;i++)graph.nodelist[i].show_foreign_keys=show_fk,graph.nodelist[i].show_primary_keys=show_pk;dag.draw()}}
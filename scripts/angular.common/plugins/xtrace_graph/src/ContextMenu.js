var DirectedAcyclicGraphContextMenu=function(graph,graphSVG,cMenuParams){var onMenuOpen=function(d){handlers.open.call(this,d)},onMenuClose=function(d){handlers.close.call(this,d)},onMenuClick=function(d){var items=[],fieldname="",value="",name="",node=null;d.operation==cMenuParams.actions.hide_selected.operation&&(items=graphSVG.selectAll(".node.selected").data(),name="Hidden Nodes",handlers.hidenodes.call(this,items,name)),d.operation==cMenuParams.actions.hide_unselected.operation&&(items=graphSVG.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data(),name="Hidden Nodes",handlers.hidenodes.call(this,items,name)),d.operation==cMenuParams.actions.hide_this.operation&&(items=d3.select(this).data(),name="Hidden Nodes",handlers.hidenodes.call(this,items,name)),"hidefield"==d.operation&&(fieldname=d.fieldname,value=d.value,items=graph.getNodes().filter(function(node){return!node.never_visible&&node.report&&node.report[fieldname]&&node.report[fieldname][0]==value}),name=fieldname+": "+value,handlers.hidenodes.call(this,items,name)),d.operation==cMenuParams.actions.invert_selection.operation&&(items=graphSVG.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data(),handlers.selectnodes.call(this,items)),d.operation==cMenuParams.actions.select_all.operation&&(items=graph.getVisibleNodes(),handlers.selectnodes.call(this,items)),d.operation==cMenuParams.actions.select_path.operation&&(items=getEntirePathNodes(d3.select(this).data()[0]),handlers.selectnodes.call(this,items,name)),d.operation==cMenuParams.actions.select_and_hide_nodes.operation&&(items=getEntirePathNodes(d3.select(this).data()[0]),handlers.selectnodes.call(this,items,name),items=graphSVG.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data(),name="Hidden Nodes",handlers.hidenodes.call(this,items,name)),"selectfield"==d.operation&&(fieldname=d.fieldname,value=d.value,items=graph.getVisibleNodes().filter(function(node){return node.report&&node.report[fieldname]&&node.report[fieldname][0]==value}),handlers.selectnodes.call(this,items)),d.operation==cMenuParams.actions.edit_node.operation&&(items=graphSVG.selectAll(".node.selected").data(),node=d3.select(this).data()[0],node&&items.push(node),handlers.edit_node.call(this,items)),d.operation==cMenuParams.actions.lineage.operation&&handlers.lineage.call(this,items),d.operation==cMenuParams.actions.handle_foreign_keys.operation&&(items=graphSVG.selectAll(".node.selected").data(),handlers.handle_foreign_keys.call(this,items,d.show)),d.operation==cMenuParams.actions.handle_primary_keys.operation&&(node=d3.select(this).data()[0],node&&items.push(node),handlers.handle_primary_keys.call(this,items,d.show)),d.operation==cMenuParams.actions.add_relation_left_and_right.operation&&handlers.add_relation_left_and_right.call(this,d.entity,d.referredEntity),d.operation==cMenuParams.actions.add_relationship.operation&&handlers.add_relationship.call(this),d.operation==cMenuParams.actions.select_add_relation_left.operation&&handlers.add_relation_by_side.call(this,!0),d.operation==cMenuParams.actions.select_add_relation_right.operation&&handlers.add_relation_by_side.call(this,!1),d.operation==cMenuParams.actions.delete_relationship.operation&&handlers.delete_relationship.call(this,d3.select(this).data()[0])},onOptionMouseOver=function(d){var items=[];if(d.operation==cMenuParams.actions.hide_selected.operation&&(items=graphSVG.selectAll(".node.selected").data()),d.operation==cMenuParams.actions.hide_unselected.operation&&(items=graphSVG.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data()),d.operation==cMenuParams.actions.hide_this.operation&&(items=d3.select(this).data()),"hidefield"==d.operation||"selectfield"==d.operation){var fieldname=d.fieldname,value=d.value;items=graph.getVisibleNodes().filter(function(node){return node.report&&node.report[fieldname]&&node.report[fieldname][0]==value})}d.operation==cMenuParams.actions.invert_selection.operation&&(items=graphSVG.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data()),d.operation==cMenuParams.actions.select_all.operation&&(items=graph.getVisibleNodes()),d.operation==cMenuParams.actions.select_path.operation&&(items=getEntirePathNodes(d3.select(this).data()[0])),d.operation==cMenuParams.actions.select_and_hide_nodes.operation&&(items=getEntirePathNodes(d3.select(this).data()[0])),handlers.hovernodes.call(this,items)},onOptionMouseOut=function(){handlers.hovernodes.call(this,[])},ctxmenu=ContextMenu(cMenuParams).on("open",onMenuOpen).on("close",onMenuClose).on("click",onMenuClick).on("mouseover",onOptionMouseOver).on("mouseout",onOptionMouseOut),menu=function(selection,selection2){menu.hide.call(this,selection),selection&&selection.each(function(d){var items=[];if(items.push({operation:cMenuParams.actions.handle_foreign_keys.operation,name:String(d.show_foreign_keys?"Hide ":"Show ")+cMenuParams.actions.handle_foreign_keys.display_name,show:!(null!=d.show_foreign_keys&&1==d.show_foreign_keys)}),items.push({operation:cMenuParams.actions.handle_primary_keys.operation,name:String(d.show_primary_keys?"Hide ":"Show ")+cMenuParams.actions.handle_primary_keys.display_name,show:!(null!=d.show_primary_keys&&1==d.show_primary_keys)}),selection.filter(".selected").data().length<2&&items.push({operation:cMenuParams.actions.add_relationship.operation,name:cMenuParams.actions.add_relationship.display_name}),2==selection.filter(".selected").data().length){var node1=selection.filter(".selected").data()[0],node2=selection.filter(".selected").data()[1];items.push({operation:cMenuParams.actions.add_relation_left_and_right.operation,name:node1.report.node_id+" -> "+node2.report.node_id,entity:node1,referredEntity:node2}),items.push({operation:cMenuParams.actions.add_relation_left_and_right.operation,name:node2.report.node_id+" -> "+node1.report.node_id,entity:node2,referredEntity:node1})}if(items.push({operation:cMenuParams.actions.select_add_relation_left.operation,name:cMenuParams.actions.select_add_relation_left.display_name}),1==selection.filter(".left_selected").data().length){var node=selection.filter(".left_selected").data()[0];node&&items.push({operation:cMenuParams.actions.select_add_relation_right.operation,name:cMenuParams.actions.select_add_relation_right.display_name+node.report.node_id})}items.push({operation:cMenuParams.actions.hide_this.operation,name:cMenuParams.actions.hide_this.display_name}),selection.filter(".selected").empty()||(items.push({operation:cMenuParams.actions.hide_selected.operation,name:cMenuParams.actions.hide_selected.display_name}),items.push({operation:cMenuParams.actions.hide_unselected.operation,name:cMenuParams.actions.hide_unselected.display_name})),selection.filter(".selected").empty()||items.push({operation:cMenuParams.actions.invert_selection.operation,name:cMenuParams.actions.invert_selection.display_name}),items.push({operation:cMenuParams.actions.select_all.operation,name:cMenuParams.actions.select_all.display_name}),items.push({operation:cMenuParams.actions.select_path.operation,name:cMenuParams.actions.select_path.display_name}),items.push({operation:cMenuParams.actions.select_and_hide_nodes.operation,name:cMenuParams.actions.select_and_hide_nodes.display_name}),items.push({operation:cMenuParams.actions.edit_node.operation,name:cMenuParams.actions.edit_node.display_name}),items.push({operation:cMenuParams.actions.lineage.operation,name:cMenuParams.actions.lineage.display_name}),ctxmenu.call(this,items),d3.select(this).classed("hascontextmenu",!0)}),selection2&&selection2.each(function(){var items2=[];items2.push({operation:cMenuParams.actions.delete_relationship.operation,name:cMenuParams.actions.delete_relationship.display_name}),ctxmenu.call(this,items2),d3.select(this).classed("hascontextmenu",!0)})};menu.hide=function(){d3.select(this).selectAll(".hascontextmenu").each(function(){$(this).unbind("contextmenu")}),d3.select(this).selectAll(".context-menu").remove()};var handlers={hidenodes:function(){},selectnodes:function(){},hovernodes:function(){},open:function(){},close:function(){},edit_node:function(){},lineage:function(){},handle_foreign_keys:function(){},handle_primary_keys:function(){},add_relation_left_and_right:function(){},add_relationship:function(){},delete_relationship:function(){},add_relation_by_side:function(){}};return menu.on=function(event,_){return handlers.hasOwnProperty(event)?1==arguments.length?handlers[event]:(handlers[event]=_,menu):menu},menu},CompareGraphContextMenu=function(){var onMenuOpen=function(d){handlers.open.call(this,d)},onMenuClick=function(d){if("viewthis"==d.operation&&handlers.view.call(this,d3.select(this).datum()),"removeselected"==d.operation&&handlers.hide.call(this,d3.selectAll(".node.selected").data()),"clusterselected"==d.operation&&handlers.hide.call(this,d3.selectAll(".node").filter(function(){return!d3.select(this).classed("selected")}).data()),"compareselected"==d.operation&&handlers.compare.call(this,d3.selectAll(".node.selected").data()),"comparetoselected"==d.operation){var ds=d3.selectAll(".node.selected").data().concat(d3.select(this).data());handlers.compare.call(this,ds)}},ctxmenu=ContextMenu().on("click",onMenuClick).on("open",onMenuOpen),menu=function(selection){menu.hide.call(this,selection),selection.each(function(){var items=[];items.push({operation:"viewthis",name:"View execution graph"});var selected=selection.filter(".selected");!selected.empty()&&selection[0].length-selected[0].length>1&&items.push({operation:"removeselected",name:"Remove selected from the clustering"}),selected[0].length>1&&items.push({operation:"clusterselected",name:"Re-cluster using selected"}),2==selected[0].length&&items.push({operation:"compareselected",name:"Compare graphs of selected"}),1==selected[0].length&&selected.datum()!=d3.select(this).datum()&&items.push({operation:"comparetoselected",name:"Compare graph of this to selected"}),ctxmenu.call(this,items),d3.select(this).classed("hascontextmenu",!0)})};menu.hide=function(){d3.select(this).selectAll(".hascontextmenu").each(function(){$(this).unbind("contextmenu")}),d3.select(this).selectAll(".context-menu").remove()};var handlers={open:function(){},view:function(){},hide:function(){},compare:function(){}};return menu.on=function(event,_){return handlers.hasOwnProperty(event)?1==arguments.length?handlers[event]:(handlers[event]=_,menu):menu},menu},ContextMenu=function(params){var idseed=0,menu=function(ds){for(var attach=this,date_time_not_allowed_actions_array=[params.actions.handle_foreign_keys.operation,params.actions.handle_primary_keys.operation,params.actions.add_relationship.operation,params.actions.add_relation_left_and_right.operation,params.actions.select_add_relation_left.operation,params.actions.select_add_relation_right.operation,params.actions.delete_relationship.operation,params.actions.select_path.operation,params.actions.select_and_hide_nodes.operation],menu={},i=0;i<ds.length;i++)if(params.isDateTimeNode(d3.select(this).data()[0]))for(var existing_actions=ds.filter(function(it){return date_time_not_allowed_actions_array.indexOf(it.operation)>-1}),k=0;k<existing_actions.length;k++)ds.splice(ds.indexOf(existing_actions[k]),1);for(var j=0;j<ds.length;j++){var item=ds[j],itemname=name.call(this,item);menu[itemname]={click:menuClick(attach,item,j),mouseover:menuMouseOver(attach,item,j),mouseout:menuMouseOut(attach,item,j)}}var options={disable_native_context_menu:!0,showMenu:function(){handlers.open.call(attach,ds)},hideMenu:function(){handlers.close.call(attach,ds)}};$(attach).contextMenu("context-menu"+idseed++,menu,options)},menuClick=function(attach,d,i){return function(){handlers.click.call(attach,d,i)}},menuMouseOver=function(attach,d,i){return function(){handlers.mouseover.call(attach,d,i)}},menuMouseOut=function(attach,d,i){return function(){handlers.mouseout.call(attach,d,i)}},name=function(d){return d.name},handlers={click:function(){},open:function(){},close:function(){},mouseover:function(){},mouseout:function(){}};return menu.name=function(_){return 0==arguments.length?name:(name=_,menu)},menu.on=function(event,_){return handlers[event]?1==arguments.length?handlers[event]:(handlers[event]=_,menu):menu},menu};
function DirectedAcyclicGraph(params){function graph(selection){selection.each(function(data){var svg=d3.select(this).selectAll("svg").data([data]);svg.enter().append("svg").append("g").attr("class","graph").classed("animate",animate),svg.attr("width",width.call(this,data)),svg.attr("height",height.call(this,data));var edges=getedges.call(this,data),nodes=getnodes.call(this,data),existing_edges=svg.select(".graph").selectAll(".edge").data(edges,edgeid),existing_nodes=svg.select(".graph").selectAll(".node").data(nodes,nodeid),removed_edges=existing_edges.exit(),removed_nodes=existing_nodes.exit(),new_edges=existing_edges.enter().insert("path",":first-child").attr("class","edge entering"),new_nodes=existing_nodes.enter().append("g").attr("class","node entering");new_nodes.each(drawnode),existing_nodes.each(drawnode),removed_nodes.each(removenode),animate?removed_edges.classed("visible",!1).transition().duration(500).remove():removed_edges.classed("visible",!1).remove(),existing_nodes.classed("pre-existing",!0),layout.call(svg.select(".graph").node(),nodes,edges),existing_nodes.classed("pre-existing",!1),animate?(svg.select(".graph").selectAll(".edge.visible").transition().duration(800).attrTween("d",graph.edgeTween),existing_nodes.transition().duration(800).attr("transform",graph.nodeTranslate)):(svg.select(".graph").selectAll(".edge.visible").attr("d",graph.splineGenerator),existing_nodes.attr("transform",graph.nodeTranslate)),new_nodes.each(newnodetransition),new_edges.attr("d",graph.splineGenerator).classed("visible",!0),existing_nodes.classed("visible",!0),window.setTimeout(function(){new_edges.classed("entering",!1),new_nodes.classed("entering",!1)},2e3)})}var layout_count=0,animate=!0,shortenNodeName=function(text,maxLength,addDots){var retString="";return retString="string"==typeof text&&null!=text&&text.length>maxLength?addDots?text.substring(0,maxLength).trim()+"...":text.substring(0,maxLength):text},width=d3.functor("100%"),height=d3.functor("100%"),edgeid=function(d){return d.source.id+d.target.id},nodeid=function(d){return d.id},nodeid_short=function(d){var max_string_length=32,name=d.id;return shortenNodeName(name,max_string_length,!0)},nodename=function(d){return d.report.Agent?d.report.Agent[0]:""},getnodes=function(d){return d.getVisibleNodes()},getedges=function(d){return d.getVisibleLinks()},bbox=function(){return d3.select(this).select("rect").node().getBBox()},drawnode=function(d){var max_item_to_display=8,group_height=32,left_padding=14,image_size=20,image_width_with_padding=2*left_padding+image_size,top_padding=15,default_rect_height=50,node_bbox={height:default_rect_height,width:465},rect=d3.select(this).select("rect"),text=d3.select(this).select("text");d3.select(this).selectAll(".fk_group").remove(),d3.select(this).selectAll(".pk_group").remove(),d3.select(this).selectAll(".fk_more_group").remove(),d3.select(this).selectAll(".line_sep").remove(),d3.select(this).selectAll(".tooltipItem").remove(),d3.select(this).selectAll(".self_ref").remove(),d.report.is_self_ref&&d3.select(this).append("image").attr("class","self_ref").attr("xlink:href","shared/images/self_ref.svg").attr("width",20).attr("height",20).attr("x",node_bbox.width/2-25).attr("y",-10);var line_sep=null,ITEMS_TO_DISPLAY=[];d.show_foreign_keys&&d.show_primary_keys?(ITEMS_TO_DISPLAY=d.report.primary_keys.slice(0,max_item_to_display/2),Array.prototype.push.apply(ITEMS_TO_DISPLAY,d.report.foreign_keys.slice(0,max_item_to_display/2))):d.show_foreign_keys?ITEMS_TO_DISPLAY=d.report.foreign_keys||[]:d.show_primary_keys&&(ITEMS_TO_DISPLAY=d.report.primary_keys||[]),ITEMS_TO_DISPLAY.length>0&&(max_item_to_display=Math.min(max_item_to_display,ITEMS_TO_DISPLAY.length),ITEMS_TO_DISPLAY.length>max_item_to_display-1&&(node_bbox.height=(max_item_to_display+1)*group_height+default_rect_height)),null==rect.node()&&(rect=d3.select(this).append("rect")),rect.attr("x",-node_bbox.width/2).attr("y",-node_bbox.height/2),rect.attr("width",node_bbox.width).attr("height",node_bbox.height),null==text.node()&&(text=d3.select(this).append("text")),text.attr("x",-node_bbox.width/2+left_padding).attr("y",-node_bbox.height/2+default_rect_height-top_padding),text.text(nodeid_short).attr("style","font-size:21px"),text.append("title").attr("class","tooltipItem").attr("x",0).attr("dy","26").text(nodeid);var line_pos_y=-node_bbox.height/2+default_rect_height;if(ITEMS_TO_DISPLAY.length>0){line_sep=d3.select(this).append("line").attr("class","line_sep").attr("x1",-node_bbox.width/2).attr("x2",node_bbox.width/2).attr("y1",line_pos_y).attr("y2",line_pos_y).attr("stroke","silver").style("stroke-width","2").style("stroke-dasharray","5, 5");for(var i=0;max_item_to_display>=i;i++){var x_pos_i=-node_bbox.width/2,y_pos_i=line_pos_y+group_height*(i+1);if(max_item_to_display>i){var fk_group=d3.select(this).append("g").attr("class","fk_group").attr("transform","translate("+x_pos_i+","+y_pos_i+")"),img_src1=ITEMS_TO_DISPLAY[i].is_primary?"shared/images/primary_key.png":null,img_src2=ITEMS_TO_DISPLAY[i].is_fk?"shared/images/foreign_key.svg":null,pos_x=left_padding,pos_y=-image_size+5;null!=img_src1&&null!=img_src2&&(pos_x=2*left_padding),img_src1&&fk_group.append("image").attr("class","fk_image").attr("x",pos_x).attr("y",pos_y).attr("xlink:href",img_src1).attr("style","width: "+image_size+"px; height: "+image_size+"px;").attr("width",image_size+"px").attr("height",image_size+"px"),img_src2&&fk_group.append("image").attr("class","fk_image").attr("x",left_padding).attr("y",-image_size+5).attr("xlink:href",img_src2).attr("style","width: "+image_size+"px; height: "+image_size+"px;").attr("width",image_size+"px").attr("height",image_size+"px");var name=ITEMS_TO_DISPLAY[i][composeConsts.UI_PROPS_FOR_DISPLAY.ui_prop_attribute_with_prefix_display_name],node=fk_group.append("text").attr("x",image_width_with_padding).attr("class","fk_text").text(function(){return shortenNodeName(name,32,!0)}).attr("style","font-size:20px");node.append("title").attr("class","tooltipItem").attr("x",0).attr("dy","26").text(name)}else if(i==max_item_to_display&&ITEMS_TO_DISPLAY.length>max_item_to_display){var fk_more_group=d3.select(this).append("g").attr("class","fk_more_group").attr("transform","translate("+x_pos_i+","+(y_pos_i-6)+")"),fk_more_text=fk_more_group.append("text").attr("x",image_width_with_padding).attr("class","fk_text").text("More...").attr("style","font-size:16px;fill: #337ab7;");fk_more_text.on("click",function(d){null!=params.onNodeDbClick&&params.onNodeDbClick(d.report)})}}}},removenode=function(){animate?d3.select(this).classed("visible",!1).transition().duration(200).remove():d3.select(this).classed("visible",!1).remove()},newnodetransition=function(){d3.select(this).classed("visible",!0).attr("transform",graph.nodeTranslate)},layout=function(nodes_d,edges_d){var start=(new Date).getTime();d3.select(this).selectAll(".node").each(function(d){d.bbox=bbox.call(this,d),d.width=d.bbox.width,d.height=d.bbox.height,d.dagre_prev=d.dagre_id==layout_count?d.dagre:null,d.dagre_id=layout_count+1}),layout_count++,params.show_console_logs&&console.log("layout:bbox",(new Date).getTime()-start),start=(new Date).getTime();var opts={nodeSep:10,edgeSep:12,rankSep:210,rankDir:params.direction,multigraph:!0},graphObj=new dagreD3.dagre.graphlib.Graph(opts);graphObj.setGraph(opts);var nextId=0;nodes_d.forEach(function(u){var id="id"in u?u.id:"_N"+nextId++;u.dagre={id:id,width:u.width,height:u.height},graphObj.setNode(id,u)}),edges_d.forEach(function(e){var source=e.source.dagre.id;if(!graphObj.hasNode(source))throw new Error("Source node for '"+e+"' not in node list");var target=e.target.dagre.id;if(!graphObj.hasNode(target))throw new Error("Target node for '"+e+"' not in node list");if(e.dagre={points:[]},source!==target){var id="id"in e?e.id:"_E"+nextId++;e.dagre.id=id,e.dagre.minLen=e.minLen||1,e.dagre.width=e.width||0,e.dagre.height=e.height||0,graphObj.setEdge({v:source,w:target},e)}}),dagreD3.dagre.layout(graphObj),params.show_console_logs&&console.log("layout:dagre",(new Date).getTime()-start),d3.select(this).selectAll(".edge").each(function(d){var p=d.dagre.points;p.push(dagreD3.intersect.rect(d.target.dagre,p.length>0?p[p.length-1]:d.source.dagre)),p.splice(0,0,dagreD3.intersect.rect(d.source.dagre,p[0])),p[0].y-=.5,p[p.length-1].y+=.5});var count=0,x=0,y=0;d3.select(this).selectAll(".node.pre-existing").each(function(d){d.dagre_prev&&(count++,x+=d.dagre_prev.x-d.dagre.x,y+=d.dagre_prev.y-d.dagre.y)}),count>0&&(x/=count,y/=count,d3.select(this).selectAll(".node").each(function(d){d.dagre.x+=x,d.dagre.y+=y}),d3.select(this).selectAll(".edge").each(function(d){d.dagre.points.forEach(function(p){p.x+=x,p.y+=y})}))},nodepos=function(d){return{x:d.x,y:d.y}},edgepos=function(d){return d.points};return graph.splineGenerator=function(d){var baseWidthMarker=3.5,baseLengthMarker=10,deg90=Math.PI/2;null==d.points&&(d.points=[],d.points.push(nodepos(d.source)),d.points.push(nodepos(d.target)));var sourceX=d.points[1].x-95,sourceY=d.points[1].y,targetX=d.points[0].x,targetY=d.points[0].y,dx=targetX-sourceX,dy=targetY-sourceY,theta=Math.atan2(dy,dx),dtxs=targetX-6*Math.cos(theta),dtys=targetY-6*Math.sin(theta),d90Theta=deg90-theta,arrowHead=" M "+dtxs+", "+dtys+" l"+(baseWidthMarker*Math.cos(d90Theta)-baseLengthMarker*Math.cos(theta))+", "+(-baseWidthMarker*Math.sin(d90Theta)-baseLengthMarker*Math.sin(theta))+" L"+(dtxs-baseWidthMarker*Math.cos(d90Theta)-baseLengthMarker*Math.cos(theta))+", "+(dtys+baseWidthMarker*Math.sin(d90Theta)-baseLengthMarker*Math.sin(theta))+"z";return arrowHead+d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y}).interpolate("basis")(edgepos.call(this,d))},graph.edgeTween=function(d){for(var d1=graph.splineGenerator.call(this,d),path0=this,path1=path0.cloneNode(),n0=path0.getTotalLength(),n1=(path1.setAttribute("d",d1),path1).getTotalLength(),distances=[0],i=0,dt=Math.max(1/8,4/Math.max(n0,n1));(i+=dt)<1;)distances.push(i);distances.push(1);var points=distances.map(function(t){var p0=path0.getPointAtLength(t*n0),p1=path1.getPointAtLength(t*n1);return d3.interpolate([p0.x,p0.y],[p1.x,p1.y])}),line=d3.svg.line().interpolate("basis");return function(t){return line(points.map(function(p){return p(t)}))}},graph.nodeTranslate=function(d){var pos=nodepos.call(this,d);return"translate("+pos.x+","+pos.y+")"},graph.width=function(_){return arguments.length?(width=d3.functor(_),graph):width},graph.height=function(_){return arguments.length?(height=d3.functor(_),graph):height},graph.edgeid=function(_){return arguments.length?(edgeid=_,graph):edgeid},graph.nodeid=function(_){return arguments.length?(nodeid=_,graph):nodeid},graph.nodeid_full=function(_){return arguments.length?(nodeid_full=_,graph):nodeid_full},graph.nodename=function(_){return arguments.length?(nodename=_,graph):nodename},graph.nodes=function(_){return arguments.length?(getnodes=d3.functor(_),graph):getnodes},graph.edges=function(_){return arguments.length?(getedges=d3.functor(_),graph):getedges},graph.bbox=function(_){return arguments.length?(bbox=d3.functor(_),graph):bbox},graph.drawnode=function(_){return arguments.length?(drawnode=_,graph):drawnode},graph.removenode=function(_){return arguments.length?(removenode=_,graph):removenode},graph.newnodetransition=function(_){return arguments.length?(newnodetransition=_,graph):newnodetransition},graph.layout=function(_){return arguments.length?(layout=_,graph):layout},graph.nodepos=function(_){return arguments.length?(nodepos=_,graph):nodepos},graph.edgepos=function(_){return arguments.length?(edgepos=_,graph):edgepos},graph.animate=function(_){return arguments.length?(animate=_,graph):animate},graph}
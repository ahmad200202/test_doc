!function(angular){"use strict";var attMessageCenterModule=angular.module("attMessageCenter",["attServices.common"]);attMessageCenterModule.factory("attMessageCenterService",["InvokerService","locale","$filter","UserPreferencesService","$timeout","DataFormatCommonService","attUtilsService","TimeFrameService","$q",function(InvokerService,locale,$filter,UserPreferencesService,$timeout,DataFormatCommonService,attUtilsService,TimeFrameService,$q){var _MaxRecords=2e4,_ShowLoaderAfterMiliSec=800,_timeoutHandler=null,_onTheWay=!1,_lastSelectedTimeFrame=null,AUDIT_PREFIX="AUDIT:",messageCenterService={data:{ctx:null,lastPosition:"",lastAuditTime:"0",searchText:"",filteredDisplayMessages:[],baseMessagesObjectByType:{errors:[],warnings:[],infos:[],notifications:[]},mcUserPrefs:null,timeFrameList:[],mcShowLoaderBool:!0,waitForApplyFilters:!1,events:{onBeforeGetMessages:null,onAfterGetMessages:null},counters:{allFilters:0,errors:0,warnings:0,infos:0,notifications:0},systemSelection:{list:[],filtersArray:[],displayText:"",displayTextToolTip:"",messagePropToFilter:"",appPerspective:""},closedViewSeverityColor:angular.copy(consts.MCDO.AuditSeverity.INFO),closedViewSeverityColorNotification:"",currentSelectedMessage:null,useApiFunctions:{isAllowToGetMessages:null,onViewMessageLogBool:!1,onOpenTaskTabBool:!1,onViewServerBool:!1},showFilteredMcCount:!1,aclConf:{callerRole:null,taskLogMethodName:null}},getEmptyMcUserPrefsObject:function(){return{allMessagesFilterBool:!0,errorsFilterBool:!0,warningsFilterBool:!0,infoFilterBool:!0,notificationFilterBool:!0,wrapMessageBool:!1,mode:"",timeFrame:"",messagesContext:"",previousMessagesContext:"",hideIsActive:!1,lastPositionForHide:"",lastAuditTimeForHide:"",hideMessagesByUserTime:""}},getMessagesEmptyParams:function(){return{putData:null,max_count:_MaxRecords,start:0,end:"",direction:angular.copy(consts.MCDO.Direction.NEWER_ITEMS)}},getMsgCenterUserPreferences:function(){if(ObjectUtils.isEmpty(messageCenterService.data.mcUserPrefs)){var messagesCenterUserPrefs=UserPreferencesService.getValueByKey("MessagesCenterUserPrefs");null!=messagesCenterUserPrefs&&(messageCenterService.data.mcUserPrefs=messagesCenterUserPrefs)}},setMsgCenterUserPreferences:function(){UserPreferencesService.setValueByKey("MessagesCenterUserPrefs",messageCenterService.data.mcUserPrefs),messageCenterService.saveUserPrefs()},checkInitialUserPrefsData:function(){if(messageCenterService.getMsgCenterUserPreferences(),ObjectUtils.isEmpty(messageCenterService.data.mcUserPrefs)){var mcUserPrefs=messageCenterService.getEmptyMcUserPrefsObject();mcUserPrefs.mode=angular.copy(consts.MessagesCenter.mode.CLOSED),mcUserPrefs.messagesContext=angular.copy(consts.MessagesCenter.messagesContext.All),messageCenterService.data.timeFrameList.length>0&&(mcUserPrefs.timeFrame=messageCenterService.data.timeFrameList[1]),messageCenterService.data.mcUserPrefs=mcUserPrefs,messageCenterService.setMessagesContext(mcUserPrefs.messagesContext)}},clearSeverityCounters:function(){messageCenterService.data.counters.allFilters=0,messageCenterService.data.counters.errors=0,messageCenterService.data.counters.warnings=0,messageCenterService.data.counters.infos=0,messageCenterService.data.counters.notifications=0},emptyFilteredDisplayMessagesArray:function(){messageCenterService.data.filteredDisplayMessages=[]},setContext:function(ctx){messageCenterService.data.ctx=ctx},setMessagesContext:function(context){ObjectUtils.isEmpty(context)===!1&&(messageCenterService.data.mcUserPrefs.previousMessagesContext=messageCenterService.data.mcUserPrefs.messagesContext,messageCenterService.data.mcUserPrefs.messagesContext=context)},setMessagesContextWithoutChangingPrevious:function(context){ObjectUtils.isEmpty(context)===!1&&(messageCenterService.data.mcUserPrefs.messagesContext=context)},restoreContext:function(){ObjectUtils.isEmpty(messageCenterService.data.mcUserPrefs.previousMessagesContext)===!1&&(messageCenterService.data.mcUserPrefs.messagesContext=angular.copy(messageCenterService.data.mcUserPrefs.previousMessagesContext))},setDisplayTextForSelectedSystemObject:function(namesList,itemsCounter){var _SepValue=", ";if(ObjectUtils.isEmpty(namesList)||ObjectUtils.isEmpty(namesList[0]))messageCenterService.data.systemSelection.displayText="",messageCenterService.data.systemSelection.displayTextToolTip="";else{if(ObjectUtils.isObject(namesList[0])){var tText="",sep="";ArrayUtils.each(namesList,function(item){var objAsArr=Object.keys(item).map(function(key){return item[key]});tText=tText+sep+objAsArr.join(":"),0==sep.length&&(sep=angular.copy(_SepValue))}),messageCenterService.data.systemSelection.displayTextToolTip=tText}else messageCenterService.data.systemSelection.displayTextToolTip=namesList.join(_SepValue);null==itemsCounter&&0!==itemsCounter&&(itemsCounter=namesList.length);var innerText=1==itemsCounter?namesList[0]:itemsCounter;messageCenterService.data.systemSelection.displayText="("+innerText+")"}},handleSpecificContext:function(applyCallBack){if(messageCenterService.isMessagesContextSpecific())if(0==messageCenterService.data.systemSelection.list.length)messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters(),messageCenterService.applyFiltersOnCurrentRecords(),applyCallBack&&applyCallBack();else{messageCenterService.isMessageCenterModeIsClosed()&&(messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters());var forceCall=!0;messageCenterService.getMessages(function(){messageCenterService.isMessageCenterModeIsClosed()?(messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters()):(messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.applyFiltersOnCurrentRecords()),applyCallBack&&applyCallBack()},null,function(){messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters(),applyCallBack&&applyCallBack()},forceCall)}},getEmptyFilterFiledObject:function(){return{field_name:"",value:"",condition:"EQUALS"}},getAllFiltersSeverityAsString:function(){return consts.MCDO.AuditSeverity.ERROR+consts.MessagesCenter.Delimiter+consts.MCDO.AuditSeverity.WARNING+consts.MessagesCenter.Delimiter+consts.MCDO.AuditSeverity.INFO},getFiltersSeverityAsString:function(){var joinSeverity="";return null==messageCenterService.data.mcUserPrefs||1==messageCenterService.data.mcUserPrefs.allMessagesFilterBool?joinSeverity=messageCenterService.getAllFiltersSeverityAsString():(1==messageCenterService.data.mcUserPrefs.errorsFilterBool&&(joinSeverity+=consts.MCDO.AuditSeverity.ERROR),1==messageCenterService.data.mcUserPrefs.warningsFilterBool&&(joinSeverity+=0==joinSeverity.length?consts.MCDO.AuditSeverity.WARNING:consts.MessagesCenter.Delimiter+consts.MCDO.AuditSeverity.WARNING),1==messageCenterService.data.mcUserPrefs.infoFilterBool&&(joinSeverity+=0==joinSeverity.length?consts.MCDO.AuditSeverity.INFO:consts.MessagesCenter.Delimiter+consts.MCDO.AuditSeverity.INFO),1==messageCenterService.data.mcUserPrefs.notificationFilterBool&&(joinSeverity+=0==joinSeverity.length?consts.MessagesCenter.event.NOTIFICATION:consts.MessagesCenter.Delimiter+consts.MessagesCenter.event.NOTIFICATION)),joinSeverity},getSeverityFilterField:function(){var field=messageCenterService.getEmptyFilterFiledObject();field[consts.MCDO.FieldCondition.field_name]=angular.copy(consts.MCDO.ReplicateAuditRecord.severity),field[consts.MCDO.FieldCondition.condition]=angular.copy(consts.MCDO.Comparison.IN);var fieldValue=messageCenterService.getAllFiltersSeverityAsString();return field[consts.MCDO.FieldCondition.value]=fieldValue,field},clearSystemSelectionFiltersArray:function(){ArrayUtils.emptyArray(messageCenterService.data.systemSelection.filtersArray)},clearSystemSelectionList:function(){ArrayUtils.emptyArray(messageCenterService.data.systemSelection.list)},getFilters:function(useFilterAndCondition){var filters=[];if(useFilterAndCondition===!0){var severityField=messageCenterService.getSeverityFilterField();filters.push(severityField)}return messageCenterService.isMessagesContextSpecific()&&messageCenterService.data.systemSelection.filtersArray.length>0&&(filters=filters.concat(messageCenterService.data.systemSelection.filtersArray)),filters},getParsedDisplayDate:function(originalTime){var parsedTimeVal="-";return originalTime>0&&(parsedTimeVal=DataFormatCommonService.getDateLocalFormat(originalTime,consts.DateToLocaleFilterFormats.ticks,!0,!1)),parsedTimeVal},setInitialValuesForTimeFrameList:function(){messageCenterService.data.timeFrameList=TimeFrameService.getBaseValuesTimeFrameList()},getStartRangeToTimeFrame:function(){if(null==messageCenterService.data.mcUserPrefs.timeFrame)return angular.copy(consts.MessagesCenter.timeFrameValues.last12Hours);var startRange=angular.copy(consts.MessagesCenter.timeFrameValues[messageCenterService.data.mcUserPrefs.timeFrame.name]);if(null!=startRange)return startRange;var _getLastWeekInTicks=function(){var today=new Date,lastWeek=new Date(today.getFullYear(),today.getMonth(),today.getDate()-7);return Utils.ConvertDateToTicks(lastWeek)};return startRange=_getLastWeekInTicks()},setSelectedTimeFrame:function(timeFrameObj){messageCenterService.data.mcUserPrefs.timeFrame=timeFrameObj},checkTimeFrameChangeAndUpdate:function(item){angular.equals(_lastSelectedTimeFrame,item)!==!0&&(messageCenterService.setSelectedTimeFrame(item),messageCenterService.disableNoMsgFoundBaseCond(),messageCenterService.applyUserChangeDisplayParams())},clearBaseMessagesArray:function(){ArrayUtils.emptyArray(messageCenterService.data.baseMessagesObjectByType.errors),ArrayUtils.emptyArray(messageCenterService.data.baseMessagesObjectByType.warnings),ArrayUtils.emptyArray(messageCenterService.data.baseMessagesObjectByType.infos),ArrayUtils.emptyArray(messageCenterService.data.baseMessagesObjectByType.notifications)},clearLastAuditTime:function(){messageCenterService.data.lastAuditTime="0"},getLastAuditTime:function(){return null!=messageCenterService.data.mcUserPrefs&&null!=messageCenterService.data.mcUserPrefs.lastAuditTimeForHide&&"0"==messageCenterService.data.lastAuditTime&&""!=messageCenterService.data.mcUserPrefs.lastAuditTimeForHide&&"0"!=messageCenterService.data.mcUserPrefs.lastAuditTimeForHide&&(messageCenterService.data.lastAuditTime=angular.copy(messageCenterService.data.mcUserPrefs.lastAuditTimeForHide)),messageCenterService.data.lastAuditTime},checkForLastAuditTime:function(auditTime){auditTime>messageCenterService.getLastAuditTime()&&messageCenterService.setLastAuditTime(auditTime)},setLastAuditTime:function(auditTime){messageCenterService.data.lastAuditTime=auditTime},getMaxAuditTimeFromRecords:function(recordsArr){var maxItem=ArrayUtils.max(recordsArr,function(item){return item[consts.MCDO.MessageCenterRecord.audit_time]});return maxItem[consts.MCDO.MessageCenterRecord.audit_time]},getLastAuditTimeFromRecords:function(recordsArr){var maxAuditTime="0";if(recordsArr.length>0){var deltaTimeFrameTicks=null,timeFrameInTicks=-1;if(!ObjectUtils.isEmpty(messageCenterService.data.mcUserPrefs)){if(messageCenterService.data.mcUserPrefs.timeFrame.name!=consts.MessagesCenter.timeFrameNames.lastWeek&&messageCenterService.data.mcUserPrefs.timeFrame.name!=consts.MessagesCenter.timeFrameNames.fromStartDate)deltaTimeFrameTicks=consts.MessagesCenter.timeFrameTicksDelta[messageCenterService.data.mcUserPrefs.timeFrame.name],deltaTimeFrameTicks=1e4*deltaTimeFrameTicks;else{var _getLastWeekInTicks=function(){var today=new Date,lastWeek=new Date(today.getFullYear(),today.getMonth(),today.getDate()-7,today.getHours(),today.getMinutes(),today.getSeconds());return Utils.ConvertDateToTicks(lastWeek)};deltaTimeFrameTicks=_getLastWeekInTicks()}"number"!=typeof deltaTimeFrameTicks&&(deltaTimeFrameTicks=null),timeFrameInTicks=Utils.ConvertDateToTicks(new Date)-deltaTimeFrameTicks}for(var idx=recordsArr.length-1;idx>=0;idx--)if(null!=recordsArr[idx]&&(null!=recordsArr[idx][consts.MCDO.MessageCenterRecord.audit_time]&&recordsArr[idx][consts.MCDO.MessageCenterRecord.audit_time]>maxAuditTime&&(maxAuditTime=recordsArr[idx][consts.MCDO.MessageCenterRecord.audit_time]),null!=deltaTimeFrameTicks&&timeFrameInTicks>-1)){var msgTime=recordsArr[idx][consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.original_time];timeFrameInTicks>=msgTime&&recordsArr.splice(idx,1)}}return messageCenterService.checkForLastAuditTime(maxAuditTime),recordsArr},clearLastPosition:function(){messageCenterService.data.lastPosition="",messageCenterService.clearBaseMessagesArray(),messageCenterService.clearLastAuditTime()},getLastPosition:function(){return angular.copy(messageCenterService.data.lastPosition)},setLastPosition:function(records,minRange,maxRange){var posToSet="",posZero="",posLast="";if(null!=records&&records.length>0&&(posZero=records[0][consts.MCDO.MessageCenterRecord.position],posLast=records[records.length-1][consts.MCDO.MessageCenterRecord.position],posToSet=posZero>posLast?posZero:posLast),null!=maxRange&&""!=maxRange){var indexOfAudit=maxRange.indexOf(AUDIT_PREFIX);if(indexOfAudit>-1){var maxAudit=maxRange.substr(AUDIT_PREFIX.length);messageCenterService.checkForLastAuditTime(maxAudit)}}posToSet.length>0&&(0==messageCenterService.data.lastPosition.length||posToSet>messageCenterService.data.lastPosition)&&(messageCenterService.data.lastPosition=posToSet)},cancelMcShowLoaderTimeout:function(){null!=_timeoutHandler&&($timeout.cancel(_timeoutHandler),_timeoutHandler=null)},mcShowLoader:function(){messageCenterService.cancelMcShowLoaderTimeout(),_timeoutHandler=$timeout(function(){messageCenterService.data.mcShowLoaderBool=!0},_ShowLoaderAfterMiliSec)},mcHideLoader:function(){messageCenterService.cancelMcShowLoaderTimeout(),messageCenterService.data.mcShowLoaderBool=!1,messageCenterService.enableNoMsgFoundBaseCond()},enableNoMsgFoundBaseCond:function(){messageCenterService.data.waitForApplyFilters=!0},disableNoMsgFoundBaseCond:function(){messageCenterService.data.waitForApplyFilters=!1},updateCountersArray:function(){messageCenterService.data.counters.errors=messageCenterService.data.baseMessagesObjectByType.errors.length,messageCenterService.data.counters.warnings=messageCenterService.data.baseMessagesObjectByType.warnings.length,messageCenterService.data.counters.infos=messageCenterService.data.baseMessagesObjectByType.infos.length,messageCenterService.data.counters.notifications=messageCenterService.data.baseMessagesObjectByType.notifications.length,messageCenterService.data.counters.allFilters=messageCenterService.data.counters.errors+messageCenterService.data.counters.warnings+messageCenterService.data.counters.infos+messageCenterService.data.counters.notifications},removeOldMessagesFromSplitArrayByCount:function(numberToRemove){var lastAuditArr=[],_getArrLastOriginalTime=function(lastPosArray,msgArray,numToRemove,arrayName){if(msgArray.length>0)for(var _tDeleteCount=0,itemIndex=msgArray.length-1;numToRemove>_tDeleteCount&&itemIndex>=0;itemIndex--){var tItem=ObjectUtils.deepClone(msgArray[itemIndex]);tItem.arrayType=arrayName,tItem.itemIndex=itemIndex,lastPosArray.push(tItem),_tDeleteCount++}};_getArrLastOriginalTime(lastAuditArr,messageCenterService.data.baseMessagesObjectByType.errors,numberToRemove,"errors"),_getArrLastOriginalTime(lastAuditArr,messageCenterService.data.baseMessagesObjectByType.warnings,numberToRemove,"warnings"),_getArrLastOriginalTime(lastAuditArr,messageCenterService.data.baseMessagesObjectByType.infos,numberToRemove,"infos"),_getArrLastOriginalTime(lastAuditArr,messageCenterService.data.baseMessagesObjectByType.notifications,numberToRemove,"notifications"),messageCenterService.sortMessagesArrayByOriginalTimeFromNewToOld(lastAuditArr);var deleteMessagesArray=[],startIndex=lastAuditArr.length==numberToRemove?0:lastAuditArr.length-numberToRemove;deleteMessagesArray=lastAuditArr.splice(startIndex,numberToRemove),deleteMessagesArray.sort(function(obj1,obj2){return obj2.itemIndex-obj1.itemIndex});for(var deleteObject={errors:0,warnings:0,infos:0,notifications:0},deleteCount=0,idx=deleteMessagesArray.length-1;idx>=0&&numberToRemove>deleteCount;idx--){var tItem=deleteMessagesArray[idx],calcIndex=tItem.itemIndex-deleteObject[tItem.arrayType];tItem[consts.MCDO.MessageCenterRecord.position]==messageCenterService.data.baseMessagesObjectByType[tItem.arrayType][calcIndex][consts.MCDO.MessageCenterRecord.position]&&(messageCenterService.data.baseMessagesObjectByType[tItem.arrayType].splice(calcIndex,1),deleteCount++,deleteObject[tItem.arrayType]++)}},checkIfBaseMsgArrIsMoreThenMax:function(newMessagesLength){if(newMessagesLength>=_MaxRecords-1)messageCenterService.clearBaseMessagesArray(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters();else{var totalNum=newMessagesLength+messageCenterService.data.baseMessagesObjectByType.errors.length+messageCenterService.data.baseMessagesObjectByType.warnings.length+messageCenterService.data.baseMessagesObjectByType.infos.length+messageCenterService.data.baseMessagesObjectByType.notifications.length,toRemoveNum=totalNum-_MaxRecords;toRemoveNum>=1&&(_MaxRecords>toRemoveNum?messageCenterService.removeOldMessagesFromSplitArrayByCount(toRemoveNum):messageCenterService.clearBaseMessagesArray(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters())}},sortBaseMessagesArraysByOriginalTime:function(){messageCenterService.data.baseMessagesObjectByType.errors.length>0&&messageCenterService.sortMessagesArrayByOriginalTimeFromNewToOld(messageCenterService.data.baseMessagesObjectByType.errors),messageCenterService.data.baseMessagesObjectByType.warnings.length>0&&messageCenterService.sortMessagesArrayByOriginalTimeFromNewToOld(messageCenterService.data.baseMessagesObjectByType.warnings),messageCenterService.data.baseMessagesObjectByType.infos.length>0&&messageCenterService.sortMessagesArrayByOriginalTimeFromNewToOld(messageCenterService.data.baseMessagesObjectByType.infos),messageCenterService.data.baseMessagesObjectByType.notifications.length>0&&messageCenterService.sortMessagesArrayByOriginalTimeFromNewToOld(messageCenterService.data.baseMessagesObjectByType.notifications)},isTextHaveNOTIFICATION:function(text){return text.indexOf(consts.MessagesCenter.event.NOTIFICATION)>-1},addMessageToBaseArrayByType:function(auditFullRecord){switch(auditFullRecord[consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.severity]){case consts.MCDO.AuditSeverity.ERROR:messageCenterService.data.baseMessagesObjectByType.errors.unshift(auditFullRecord);break;case consts.MCDO.AuditSeverity.WARNING:messageCenterService.data.baseMessagesObjectByType.warnings.unshift(auditFullRecord);break;case consts.MCDO.AuditSeverity.INFO:messageCenterService.isTextHaveNOTIFICATION(auditFullRecord[consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.event])?messageCenterService.data.baseMessagesObjectByType.notifications.unshift(auditFullRecord):messageCenterService.data.baseMessagesObjectByType.infos.unshift(auditFullRecord)}},calcUiMessages:function(records){if(null!=records&&records.length>0){var maxAuditTime="0";ArrayUtils.each(records,function(auditFullRecord){var originalTime=auditFullRecord[consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.original_time];auditFullRecord.displayTime=messageCenterService.getParsedDisplayDate(originalTime),null!=auditFullRecord[consts.MCDO.MessageCenterRecord.audit_time]&&auditFullRecord[consts.MCDO.MessageCenterRecord.audit_time]>maxAuditTime&&(maxAuditTime=auditFullRecord[consts.MCDO.MessageCenterRecord.audit_time]),auditFullRecord.displaySeverity=messageCenterService.isTextHaveNOTIFICATION(auditFullRecord.audit.event)?consts.MCDO.AuditSeverity.NOTIFICATION:auditFullRecord.audit.severity,auditFullRecord.displaySeverityToolTip=Utils.capitalizeFirstLowerOthers(auditFullRecord.displaySeverity),messageCenterService.addMessageToBaseArrayByType(auditFullRecord)}),messageCenterService.checkForLastAuditTime(maxAuditTime)}return records},checkMcMsgColor:function(){messageCenterService.data.baseMessagesObjectByType.infos.length>0&&(messageCenterService.data.closedViewSeverityColor=angular.copy(consts.MCDO.AuditSeverity.INFO)),messageCenterService.data.baseMessagesObjectByType.warnings.length>0&&(messageCenterService.data.closedViewSeverityColor=angular.copy(consts.MCDO.AuditSeverity.WARNING)),messageCenterService.data.baseMessagesObjectByType.errors.length>0&&(messageCenterService.data.closedViewSeverityColor=angular.copy(consts.MCDO.AuditSeverity.ERROR))},applyFiltersOnCurrentRecords:function(){messageCenterService.innerCalcApplyFiltersOnDisplayRecords(!1,null)},innerCalcApplyFiltersOnDisplayRecords:function(){var isServerAndTaskUpdated=!1;if(messageCenterService.data.systemSelection.list.length>0&&messageCenterService.data.systemSelection.messagePropToFilter.length>0&&(isServerAndTaskUpdated=!0),!messageCenterService.isMessagesContextSpecific()||isServerAndTaskUpdated){var tempFilteredArray=[];1==messageCenterService.data.mcUserPrefs.errorsFilterBool&&(tempFilteredArray=[].concat(messageCenterService.data.baseMessagesObjectByType.errors,tempFilteredArray)),1==messageCenterService.data.mcUserPrefs.warningsFilterBool&&(tempFilteredArray=[].concat(messageCenterService.data.baseMessagesObjectByType.warnings,tempFilteredArray)),1==messageCenterService.data.mcUserPrefs.infoFilterBool&&(tempFilteredArray=[].concat(messageCenterService.data.baseMessagesObjectByType.infos,tempFilteredArray)),1==messageCenterService.data.mcUserPrefs.notificationFilterBool&&(tempFilteredArray=[].concat(messageCenterService.data.baseMessagesObjectByType.notifications,tempFilteredArray)),messageCenterService.updateCountersArray(),messageCenterService.data.filteredDisplayMessages=tempFilteredArray,messageCenterService.checkMcMsgColor()}},sortMessagesArrayByOriginalTimeFromNewToOld:function(messagesArray){messagesArray.sort(function(obj1,obj2){return obj2[consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.original_time]-obj1[consts.MCDO.MessageCenterRecord.audit][consts.MCDO.ReplicateAuditRecord.original_time]})},prepUiMessages:function(data,successCallback,beforeApplyDataCallback){var records=data[consts.MCDO.MessageCenterGetMessagesResp.records],minRange=data[consts.MCDO.MessageCenterGetMessagesResp.min_range],maxRange=data[consts.MCDO.MessageCenterGetMessagesResp.max_range];null!=beforeApplyDataCallback&&beforeApplyDataCallback(),messageCenterService.setLastPosition(records,minRange,maxRange),null!=records&&records.length>0&&(messageCenterService.checkIfBaseMsgArrIsMoreThenMax(records.length),messageCenterService.calcUiMessages(records),messageCenterService.applyFiltersOnCurrentRecords()),successCallback&&successCallback(),messageCenterService.mcHideLoader()},isBaseMessagesArraysAreEmpty:function(){return 0==messageCenterService.data.baseMessagesObjectByType.errors.length&&0==messageCenterService.data.baseMessagesObjectByType.warnings.length&&0==messageCenterService.data.baseMessagesObjectByType.infos.length&&0==messageCenterService.data.baseMessagesObjectByType.notifications.length},getParamsActionData:function(useFilterAndCondition){return{fields:messageCenterService.getFilters(useFilterAndCondition)}},addFilterByTimeFrameBiggerOriginalTime:function(ctxParams){var field=messageCenterService.getEmptyFilterFiledObject();field[consts.MCDO.FieldCondition.field_name]=angular.copy(consts.MCDO.ReplicateAuditRecord.original_time),field[consts.MCDO.FieldCondition.condition]=angular.copy(consts.MCDO.Comparison.BIGGER);var today=new Date,deltaTimeFrameTicks=1e4*consts.MessagesCenter.timeFrameTicksDelta[messageCenterService.data.mcUserPrefs.timeFrame.name],ticks=Utils.ConvertDateToTicks(today)-deltaTimeFrameTicks;field[consts.MCDO.FieldCondition.value]=ticks,ctxParams[consts.MCDO.GetMcMessagesParams_MethodAction_putData].fields.push(field)},getParamsToCtx:function(useFilterAndCondition){var ctxParams=messageCenterService.getMessagesEmptyParams();ctxParams[consts.MCDO.GetMcMessagesParams_MethodAction_putData]=messageCenterService.getParamsActionData(useFilterAndCondition);var startRange=messageCenterService.getLastAuditTime();return"0"===startRange?(startRange=messageCenterService.getStartRangeToTimeFrame(),messageCenterService.isBaseMessagesArraysAreEmpty()&&messageCenterService.data.mcUserPrefs&&0==messageCenterService.data.mcUserPrefs.hideIsActive&&(ctxParams[consts.MCDO.GetMcMessagesParams.direction]=angular.copy(consts.MCDO.Direction.OLDER_ITEMS),ctxParams[consts.MCDO.GetMcMessagesParams.end]=startRange,ctxParams[consts.MCDO.GetMcMessagesParams.start]="")):(startRange=consts.MessagesCenter.auditPreFix+startRange,ctxParams[consts.MCDO.GetMcMessagesParams.start]=startRange,messageCenterService.addFilterByTimeFrameBiggerOriginalTime(ctxParams)),ctxParams},isMessagesContextSpecific:function(){return null!=messageCenterService.data.mcUserPrefs&&messageCenterService.data.mcUserPrefs.messagesContext==consts.MessagesCenter.messagesContext.Specific},isMessageCenterModeIsClosed:function(){return null!=messageCenterService.data.mcUserPrefs&&messageCenterService.data.mcUserPrefs.mode==consts.MessagesCenter.mode.CLOSED},getMessages:function(successCallback,errorCallback,beforeApplyDataCallback,forceCall){if(null==messageCenterService.data.useApiFunctions.isAllowToGetMessages||messageCenterService.data.useApiFunctions.isAllowToGetMessages()){var MCGetMessagesDefer=$q.defer(),MCGetMessagesPromise=MCGetMessagesDefer.promise;if(!_onTheWay||forceCall){var _WorkOnClosed=!1;if(messageCenterService.isMessageCenterModeIsClosed()){if(!messageCenterService.isBaseMessagesArraysAreEmpty())return;_WorkOnClosed=!0}return messageCenterService.isMessagesContextSpecific()&&0==messageCenterService.data.systemSelection.list.length?void messageCenterService.mcHideLoader():(messageCenterService.data.ctx[consts.MessagesCenter.Methods.GetMcMessages].params=messageCenterService.getParamsToCtx(!1),messageCenterService.mcShowLoader(),_onTheWay=!0,InvokerService.invokeServiceMethod(messageCenterService.data.ctx,consts.MessagesCenter.Methods.GetMcMessages,function(data){MCGetMessagesDefer.resolve(),_WorkOnClosed&&messageCenterService.isBaseMessagesArraysAreEmpty()?messageCenterService.prepUiMessages(data):messageCenterService.prepUiMessages(data,successCallback,beforeApplyDataCallback),_onTheWay=!1},function(message,detailed){MCGetMessagesDefer.resolve(),messageCenterService.mcHideLoader(),errorCallback&&errorCallback(message,detailed),_onTheWay=!1}),MCGetMessagesPromise)}}},checkIfDisplayOldMessages:function(){},getMessageCountParams:function(){var timeLimit=messageCenterService.getStartRangeToTimeFrame();return{time_limit:timeLimit}},activateHideOldMessagesState:function(){messageCenterService.data.mcUserPrefs.hideIsActive=!0,messageCenterService.data.mcUserPrefs.lastPositionForHide=angular.copy(messageCenterService.data.lastPosition),messageCenterService.data.mcUserPrefs.lastAuditTimeForHide=angular.copy(messageCenterService.data.lastAuditTime)},disableHideOldMessagesState:function(){messageCenterService.data.mcUserPrefs.hideIsActive=!1,messageCenterService.data.mcUserPrefs.lastPositionForHide="",messageCenterService.data.mcUserPrefs.lastAuditTimeForHide=""},hideOldMessagesGetNew:function(){var currentTime=DataFormatCommonService.getDateLocalFormat(new Date,consts.DateToLocaleFilterFormats.dateObj,!0,!1);messageCenterService.data.mcUserPrefs.hideMessagesByUserTime=locale.getString("common.messageCenter.HideMessagesIndication",[currentTime]),messageCenterService.activateHideOldMessagesState(),messageCenterService.setMsgCenterUserPreferences(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters(),messageCenterService.getMessages(null,null,function(){messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearBaseMessagesArray()})},showAllMessagesClearLastPosition:function(forceCall){messageCenterService.disableHideOldMessagesState(),messageCenterService.clearLastPosition(),messageCenterService.clearSeverityCounters(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.getMessages(function(){messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters(),messageCenterService.applyFiltersOnCurrentRecords()},null,function(){forceCall&&messageCenterService.clearLastPosition(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearBaseMessagesArray(),messageCenterService.clearSeverityCounters()},forceCall)},applyFiltersOnMessages:function(){messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.applyFiltersOnCurrentRecords(),messageCenterService.mcHideLoader()},updateFiltersBooleansByChangedInMain:function(){messageCenterService.data.mcUserPrefs.allMessagesFilterBool?(messageCenterService.data.mcUserPrefs.errorsFilterBool=!0,messageCenterService.data.mcUserPrefs.warningsFilterBool=!0,messageCenterService.data.mcUserPrefs.infoFilterBool=!0,messageCenterService.data.mcUserPrefs.notificationFilterBool=!0):(messageCenterService.data.mcUserPrefs.errorsFilterBool=!1,messageCenterService.data.mcUserPrefs.warningsFilterBool=!1,messageCenterService.data.mcUserPrefs.infoFilterBool=!1,messageCenterService.data.mcUserPrefs.notificationFilterBool=!1)},updateFiltersBooleans:function(){messageCenterService.data.mcUserPrefs.allMessagesFilterBool=messageCenterService.data.mcUserPrefs.errorsFilterBool&&messageCenterService.data.mcUserPrefs.warningsFilterBool&&messageCenterService.data.mcUserPrefs.infoFilterBool&&messageCenterService.data.mcUserPrefs.notificationFilterBool?!0:!1},setCurrentSelectedMessage:function(msgData){messageCenterService.data.currentSelectedMessage=msgData},getCurrentSelectedMessage:function(){return messageCenterService.data.currentSelectedMessage},mcRemoveItemsByPropFromBothLists:function(prop,value){var removeAllElementsFromArrayWithProperty=function(array,prop,value){for(var idx=array.length-1;idx>=0;idx--)null!=array[idx]&&null!=ObjectUtils.get(array[idx],prop)&&ObjectUtils.get(array[idx],prop)==value&&array.splice(idx,1)};removeAllElementsFromArrayWithProperty(messageCenterService.data.baseMessagesObjectByType.errors,prop,value),removeAllElementsFromArrayWithProperty(messageCenterService.data.baseMessagesObjectByType.warnings,prop,value),removeAllElementsFromArrayWithProperty(messageCenterService.data.baseMessagesObjectByType.infos,prop,value),removeAllElementsFromArrayWithProperty(messageCenterService.data.baseMessagesObjectByType.notifications,prop,value),removeAllElementsFromArrayWithProperty(messageCenterService.data.filteredDisplayMessages,prop,value)},mcNewMonitoringObjectGetAllMessages:function(){messageCenterService.showAllMessagesClearLastPosition()},refreshMessagesByCurrentParams:function(){messageCenterService.clearLastPosition(),messageCenterService.clearSeverityCounters(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.getMessages(null,null,function(){messageCenterService.emptyFilteredDisplayMessagesArray()})},checkHidePositionAndClear:function(){""!=messageCenterService.data.mcUserPrefs.lastAuditTimeForHide&&(messageCenterService.data.lastAuditTime=angular.copy(messageCenterService.data.mcUserPrefs.lastAuditTimeForHide),messageCenterService.clearBaseMessagesArray(),messageCenterService.emptyFilteredDisplayMessagesArray(),messageCenterService.clearSeverityCounters())},saveUserPrefs:function(){UserPreferencesService.saveAllUserPreferences()},isShowFilteredMessagesCount:function(){messageCenterService.data.showFilteredMcCount=messageCenterService.data.mcUserPrefs&&0==messageCenterService.isMessageCenterModeIsClosed()&&0==messageCenterService.isMessagesContextSpecific()&&0==messageCenterService.data.mcUserPrefs.hideIsActive?!0:!1},addRemoveClassFooterOpen:function(){var classToRemove="footerOpen mcMid mcFull";$(".appMainContent, .appFooter").removeClass(classToRemove);
var footerModeClass="";if(null!=messageCenterService.data.mcUserPrefs&&null!=messageCenterService.data.mcUserPrefs.mode)switch(messageCenterService.data.mcUserPrefs.mode){case consts.MessagesCenter.mode.FULL:case consts.MessagesCenter.mode.OPEN:footerModeClass="mcFull",_selectAndFocusOnSearch();break;case consts.MessagesCenter.mode.MID:footerModeClass="mcMid",_selectAndFocusOnSearch();break;case consts.MessagesCenter.mode.CLOSED:footerModeClass="",_clearTimeoutsOnClosePanel()}""!=footerModeClass&&$(".appMainContent, .appFooter").addClass(footerModeClass),messageCenterService.isShowFilteredMessagesCount()},onOutSideCtrlLoad:function(){setTimeout(function(){messageCenterService.addRemoveClassFooterOpen()},0)},toggleMcView:function(){if(null==messageCenterService.data.mcUserPrefs)messageCenterService.checkInitialUserPrefsData(),messageCenterService.data.mcUserPrefs.mode=consts.MessagesCenter.mode.CLOSED,messageCenterService.data.searchText="";else switch(messageCenterService.data.mcUserPrefs.mode){case consts.MessagesCenter.mode.FULL:case consts.MessagesCenter.mode.MID:case consts.MessagesCenter.mode.OPEN:messageCenterService.data.mcUserPrefs.mode=consts.MessagesCenter.mode.CLOSED,messageCenterService.data.searchText="";break;case consts.MessagesCenter.mode.CLOSED:messageCenterService.data.mcUserPrefs.mode=consts.MessagesCenter.mode.MID}messageCenterService.setMsgCenterUserPreferences(),messageCenterService.addRemoveClassFooterOpen(),messageCenterService.isShowFilteredMessagesCount()},applyUserChangeDisplayParams:function(){_userChangeDisplayParamsClear(),_userChangeDisplayParamsHandler=setTimeout(function(){if(0==messageCenterService.data.mcUserPrefs.hideIsActive){var forceCall=!0;messageCenterService.clearSeverityCounters(),messageCenterService.showAllMessagesClearLastPosition(forceCall)}messageCenterService.setMsgCenterUserPreferences(),messageCenterService.isShowFilteredMessagesCount()},_userChangeDisplayParamsMilisec)}},_focusOnSearchTimeoutHandle=null,_userChangeDisplayParamsMilisec=850,_focusOnSearchTimeoutHandleClear=function(){null!=_focusOnSearchTimeoutHandle&&(clearTimeout(_focusOnSearchTimeoutHandle),_focusOnSearchTimeoutHandle=null)},_selectAndFocusOnSearch=function(){_focusOnSearchTimeoutHandle=setTimeout(function(){$(".messagesCenterActionsPanel .mcGridSearch input").focus().select()},150)},_clearTimeoutsOnClosePanel=function(){messageCenterService.cancelMcShowLoaderTimeout(),_focusOnSearchTimeoutHandleClear(),_userChangeDisplayParamsClear()},_userChangeDisplayParamsHandler=null,_userChangeDisplayParamsClear=function(){null!=_userChangeDisplayParamsHandler&&(clearTimeout(_userChangeDisplayParamsHandler),_userChangeDisplayParamsHandler=null)};return locale.ready("common.messageCenter").then(function(){messageCenterService.setInitialValuesForTimeFrameList()}),messageCenterService}]),attMessageCenterModule.controller("attMessageCenterCtrl",["$scope","attMessageCenterService","locale","AclService",function($scope,attMessageCenterService,locale,AclService){$scope.MessagesCenterConstants=consts.MessagesCenter,$scope.mcData=attMessageCenterService.data,attMessageCenterService.setInitialValuesForTimeFrameList(),attMessageCenterService.checkInitialUserPrefsData(),$scope.gridConfigattGridConfig={isImmutableSource:!0},$scope.gridConfigattGridConfig.headerCtxMenuActions={sorting:!0,freezeColumn:!1,quickColumnSelection:!1,exportToCSV:!1,exportToTSV:!0,exportToHTML:!1,columnSettings:!0,hideColumn:!0,valuesFilter:!1},$scope.MCcolumnsInSearch=["audit.reporting_node","audit.server_name","audit.task_name","audit.message","audit.status_code","position","displaySeverity"],$scope.viewLogToolTip="",$scope.isViewLogBtnDisabled=!0,$scope.isViewTaskBtnDisabled=!0,$scope.isViewServerBtnDisabled=!0;var _checkForDisabledContextMenuOptions=function(msgRowData,callback){$scope.isViewLogBtnDisabled=!0,$scope.isViewTaskBtnDisabled=!0,$scope.isViewServerBtnDisabled=!0,null!=msgRowData&&null!=$scope.MessageCenterApi.checkForDisabledContextMenuOptions&&"function"==typeof $scope.MessageCenterApi.checkForDisabledContextMenuOptions?$scope.MessageCenterApi.checkForDisabledContextMenuOptions(msgRowData,function(disabledStateObj){null!=disabledStateObj&&null!=$scope.mcData.currentSelectedMessage&&$scope.mcGridApi.info.displayedItemsLength>0&&($scope.isViewLogBtnDisabled=disabledStateObj.disableLog,$scope.isViewTaskBtnDisabled=disabledStateObj.disableViewTask,$scope.isViewServerBtnDisabled=disabledStateObj.disableViewServer,$scope.viewLogToolTip=disabledStateObj.viewLogToolTip),callback&&callback()}):callback&&callback()};$scope.mainSeverityCheckBoxChanged=function(){attMessageCenterService.mcShowLoader(),attMessageCenterService.updateFiltersBooleansByChangedInMain(),attMessageCenterService.applyFiltersOnMessages(),attMessageCenterService.setMsgCenterUserPreferences(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.onSeverityCheckBoxChanged=function(){attMessageCenterService.mcShowLoader(),attMessageCenterService.updateFiltersBooleans(),attMessageCenterService.applyFiltersOnMessages(),attMessageCenterService.setMsgCenterUserPreferences(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.messagesContextRadioBtnChanged=function(){attMessageCenterService.setMessagesContext($scope.mcData.mcUserPrefs.messagesContext),attMessageCenterService.checkHidePositionAndClear(),attMessageCenterService.applyUserChangeDisplayParams()},$scope.timeFrameSelected=function(item){attMessageCenterService.checkTimeFrameChangeAndUpdate(item)},$scope.hideMessagesClicked=function(){attMessageCenterService.hideOldMessagesGetNew(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.showMessagesClicked=function(){attMessageCenterService.showAllMessagesClearLastPosition(),attMessageCenterService.setMsgCenterUserPreferences(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.wrapMessagesCBChanged=function(){attMessageCenterService.setMsgCenterUserPreferences(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.mcChangeViewMode=function(mode){null!=attMessageCenterService.data.mcUserPrefs?attMessageCenterService.data.mcUserPrefs.mode=mode:(null==attMessageCenterService.data.mcUserPrefs&&attMessageCenterService.checkInitialUserPrefsData(),attMessageCenterService.data.mcUserPrefs.mode=consts.MessagesCenter.mode.CLOSED),attMessageCenterService.isMessageCenterModeIsClosed()&&(attMessageCenterService.data.searchText=""),attMessageCenterService.setMsgCenterUserPreferences(),attMessageCenterService.addRemoveClassFooterOpen(),attMessageCenterService.isShowFilteredMessagesCount()},$scope.onMcColumnSelection=function(){$scope.mcGridApi.internalViews.openColumnSettings()},$scope.onMC_ApiViewMessageLog=function(rowData){AclService.isUserAllowToDoAction(attMessageCenterService.data.aclConf.taskLogMethodName,attMessageCenterService.data.aclConf.callerRole)&&attMessageCenterService.data.useApiFunctions.onViewMessageLogBool&&0==$scope.isViewLogBtnDisabled&&(ObjectUtils.isEmpty(rowData)&&(rowData=$scope.mcGridApi.selectedItems[0]),_checkForDisabledContextMenuOptions(rowData,function(){0==$scope.isViewLogBtnDisabled&&$scope.MessageCenterApi.onViewMessageLog(rowData)}))},$scope.onMC_ApiOpenTaskTab=function(rowData){attMessageCenterService.data.useApiFunctions.onOpenTaskTabBool&&0==$scope.isViewTaskBtnDisabled&&($scope.mcChangeViewMode(consts.MessagesCenter.mode.MID),ObjectUtils.isEmpty(rowData)&&(rowData=$scope.mcGridApi.selectedItems[0]),_checkForDisabledContextMenuOptions(rowData,function(){0==$scope.isViewTaskBtnDisabled&&$scope.MessageCenterApi.onOpenTaskTab(rowData)}))},$scope.onMC_ApiViewServer=function(rowData){attMessageCenterService.data.useApiFunctions.onViewServerBool&&0==$scope.isViewServerBtnDisabled&&($scope.mcChangeViewMode(consts.MessagesCenter.mode.MID),ObjectUtils.isEmpty(rowData)&&(rowData=$scope.mcGridApi.selectedItems[0]),_checkForDisabledContextMenuOptions(rowData,function(){0==$scope.isViewServerBtnDisabled&&$scope.MessageCenterApi.onViewServer(rowData)}))},$scope.onMC_ApiExportToTSV=function(){$scope.mcGridApi.exportGrid(window.attGridConfig.exportFormats.TSV.type)},$scope.mcGridApi={onRowClick:function(rowData){_checkForDisabledContextMenuOptions(rowData,null)},onRowDblClick:function(rowData){$scope.onMC_ApiViewMessageLog(rowData)},onSelectionChanged:function(selectedItems){attMessageCenterService.setCurrentSelectedMessage(selectedItems[0]),_checkForDisabledContextMenuOptions(selectedItems[0],null)},rowContextMenu:function(event,rowData){if(rowData){var selectedRowPosition=rowData.position;$scope.mcGridApi.selectAndGoToItem({position:selectedRowPosition})}var menu=[];return _checkForDisabledContextMenuOptions(rowData,null),attMessageCenterService.data.useApiFunctions.onViewMessageLogBool&&AclService.isUserAllowToDoAction(attMessageCenterService.data.aclConf.taskLogMethodName,attMessageCenterService.data.aclConf.callerRole)&&menu.push({id:menu.length+1,disabled:$scope.isViewLogBtnDisabled,name:locale.getString("common.base.ViewLogs"),clickFunc:function($event,menuItem,rowData){$scope.onMC_ApiViewMessageLog(rowData)}}),attMessageCenterService.data.useApiFunctions.onOpenTaskTabBool&&menu.push({id:menu.length+1,disabled:$scope.isViewTaskBtnDisabled,name:locale.getString("common.messageCenter.ViewTask"),clickFunc:function($event,menuItem,rowData){$scope.onMC_ApiOpenTaskTab(rowData)}}),attMessageCenterService.data.useApiFunctions.onViewServerBool&&menu.push({id:menu.length+1,disabled:$scope.isViewServerBtnDisabled,name:locale.getString("common.messageCenter.ViewServer"),clickFunc:function($event,menuItem,rowData){$scope.onMC_ApiViewServer(rowData)}}),menu}},$scope.mcIsSpecific=!1,$scope.isSpecificMode=function(){var isSpecific=attMessageCenterService.isMessagesContextSpecific();return $scope.mcIsSpecific!==isSpecific&&($scope.mcIsSpecific=isSpecific),isSpecific};var _isNoSpecificItemSelected=function(){return 0===$scope.mcData.filteredDisplayMessages.length&&$scope.mcData.waitForApplyFilters===!0&&0===$scope.mcData.searchText.length?!0:!1};$scope.showNoSpecificItemSelected=function(){return _isNoSpecificItemSelected()&&$scope.isSpecificMode()&&0===$scope.mcData.systemSelection.list.length},$scope.showNoMessagesToShowForTimeframe=function(){return _isNoSpecificItemSelected()&&($scope.isSpecificMode()===!1||$scope.mcData.systemSelection.list.length>0)},$scope.$on("$locationChangeStart",function(){$scope.mcGridApi.internalViews.closeColumnSettings()})}])}(angular);
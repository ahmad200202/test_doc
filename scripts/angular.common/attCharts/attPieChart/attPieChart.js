!function(angular){"use strict";var pieChartModule=angular.module("attPieChart",[]);pieChartModule.directive("attPieChart",["attChartSelectionService","attChartOverlayService",function(AttChartSelectionService,AttChartOverlayService){return{restrict:"E",scope:{config:"=",data:"="},templateUrl:"scripts/angular.common/attCharts/attPieChart/attPieChart.html",link:function(scope,element){window.onresize=function(){return scope.$apply()};var self=this;scope.attPieRender=function(data,config){var configObj=self.getDefaultConfig();$.extend(configObj,config),self.validateConfig(configObj);var width=parseInt(configObj.width),height=parseInt(configObj.height),the_id=configObj.id,selector=configObj.selector,selectedColor=configObj.selectedColor,pieColors=configObj.colorScheme,radius=Math.min(width,height)/2,radiusOffset=7,pathCount=0;width+=2*radiusOffset+5,height+=2*radiusOffset+5;var chart=d3.selectAll(selector+" .attPieChartChart");chart.selectAll("*").remove(),AttChartOverlayService.removeOverlay(scope,element);var svg=chart.append("svg:svg").attr("width",width).attr("height",height);self.overrideLibs(svg,width,height);var titleHeight=AttChartUtils.addChartTitle(configObj,svg,height,width);if(!data||data.length<1)return void AttChartOverlayService.addOverlay(scope,element,width,height);if(AttChartUtils.sortArrayByObjectField(data,"value","descending",configObj.aggregateName),self.removePhantomPie(svg),self.isAllZeroesData(data))return void self.addPhantomPie(svg,radius,width,height+2*titleHeight);svg.data([data]).on("mouseout",function(){AttChartUtils.hideAllPowertips()});var group=svg.append("svg:g").attr("transform","translate("+width/2+","+(height/2+titleHeight)+")"),arc=d3.svg.arc().outerRadius(radius),arcHover=d3.svg.arc().outerRadius(radius+radiusOffset),pie=d3.layout.pie().value(function(d){return d.value}),arcs=group.selectAll(".slice").data(pie(data)).enter().append("svg:g").attr("label",function(d){return d.data.label}).attr("chartid",function(){return the_id});(data.length>1||1==data.length&&!isNaN(data[0].value))&&arcs.append("svg:path").attr("d",arc).attr("selected",0).attr("pivotSelected",0).attr("selectColor",selectedColor).attr("selector",configObj.selector).attr("label",function(d){return d.data.label}).attr("deselectColor",function(d,i){return pieColors[i]}).attr("fill",function(d,i){return pieColors[i]}).attr("id",function(){return the_id+"-path-"+pathCount++}).attr("class",function(){return"slice-fill "}).on("click",function(){var selected=0==d3.select(this).attr("selected")?1:0;d3.select(this).attr("selected",selected).attr("pivotSelected",selected).style("stroke",function(){return 1===selected?selectedColor:d3.select(this.parentNode).attr("fill")}).style("stroke-width",function(){return 1===selected?"3px":"1px"}),AttChartSelectionService.notifyChartsSelected("attPieChart; wedge selection")}).on("mouseover",function(d){var id="#"+d3.select(this).attr("id");AttChartUtils.getPowertip(id,[d.data.label,AttChartUtils.commaSeparateNumber(parseFloat(d.data.value),1)+"%",d.data.description]),self.toggleWedgePopout(this,!0,arc,arcHover)}).on("mouseout",function(){AttChartUtils.hideAllPowertips(),self.toggleWedgePopout(this,!1,arc,arcHover)}).on("wedge-popout",function(){self.toggleWedgePopout(this,!0,arc,arcHover)}).on("wedge-popin",function(){self.toggleWedgePopout(this,!1,arc,arcHover)}).attr("class",function(d,i){return"interactive-slice slice slice_"+i+" slice_"+d.data.label}).attr("chartid",function(){return the_id}),self.addWedgeLabels(configObj,arcs,radius),self.addLegend(configObj,data,group,titleHeight,width)},scope.$watchGroup(["data","config"],function(newVals){return!newVals||newVals.length<1?scope.attPieRender(newVals):scope.attPieRender(newVals[0],newVals.length>1?newVals[1]:void 0)})},getDefaultConfig:function(){return{id:"att-pie-chart",selector:"",title:"",width:"300",height:"300",legendRect:18,legendPad:4,useLabel:!1,addLegend:!0,syncLegend:!0,handleClicks:!0,label:"",selectedColor:AttChartUtils.getAttunityChartSelectionColor(),colorScheme:AttChartUtils.getAttunityColorScheme()}},validateConfig:function(configObj){return configObj?void(configObj.selector=(configObj.selector&&"string"==typeof configObj.selector?configObj.selector:"")+" .attPieChartContainer"):void console.log("Error reading pie chart configuration.")},isAllZeroesData:function(data){var MIN_VAL=1e-4;return data[0].value<MIN_VAL&&data[data.length-1].value<MIN_VAL},addPhantomPie:function(svg,radius,width,height){var gradient=svg.append("defs").append("radialGradient").attr("cx","50%").attr("cy","50%").attr("id","attPieChartRadialGradient");gradient.append("stop").attr("offset","0%").attr("stop-color","#FFFFFF"),gradient.append("stop").attr("offset","100%").attr("stop-color","#CCCCCC");svg.append("circle").attr("cx",width/2).attr("cy",height/2).attr("r",radius).attr("class","phantomPie").style("fill","url(#attPieChartRadialGradient)")},removePhantomPie:function(svg){var $svg=$(svg.node());$svg.find("[class=phantomPie]").remove(),$svg.find("defs").remove()},toggleWedgePopout:function(element,doPopout,arc,arcHover){var toggledArc;toggledArc=doPopout?arcHover:arc,d3.select(element).transition().duration(80).attr("d",toggledArc)},addWedgeLabels:function(configObj,arcs,radius){configObj.useLabel&&arcs.append("svg:text").attr("class","attPieChartLabel").attr("transform",function(d){return d.innerRadius=0,d.outerRadius=radius,"translate("+arc.centroid(d)+")"}).attr("text-anchor","middle").text(function(d,i){return data[i].label})},addLegend:function(configObj,data,group,titleHeight,width){if(configObj.addLegend){var legendContainer=d3.selectAll(configObj.selector+" .attPieChartLegend"),linePad=parseInt(configObj.legendPad),lineHeight=parseInt(configObj.legendRect),totalHeight=data.length*(lineHeight+linePad),legendHeight=($(legendContainer).parent().height(),Math.max(configObj.height,totalHeight)),legendWidth=AttChartUtils.getChartsLegendSize(),legend=legendContainer.append("svg:svg").attr("width",legendWidth).attr("height",legendHeight+titleHeight);this.overrideLibs(legend,legendWidth,legendHeight+titleHeight);var legendTransform;legendHeight>configObj.height?(legendTransform=function(){return"translate(0,0)"},group.attr("transform","translate("+width/2+","+(legendHeight/2+titleHeight)+")"),$(group.node()).parent().parent().height(legendHeight+titleHeight)):legendTransform=function(){return"translate(0,"+(configObj.height/2-totalHeight/2+titleHeight)+")"};var legendGroup=legend.append("g").attr("transform",legendTransform).selectAll("g").data(data).enter().append("g").attr("transform",function(d,i){return"translate(0,"+i*(lineHeight+linePad)+")"});if(legendGroup.append("svg:rect").attr("width",lineHeight).attr("height",lineHeight).attr("x",legendWidth-lineHeight).style("fill",function(d,i){return 1==d3.select(this).attr("selected")?configObj.selectedColor:configObj.colorScheme[i]}).style("cursor",function(){return"pointer"}),configObj.handleClicks&&legend.selectAll("rect").on("click",function(d){var $slices=$(group.node()).find("g");$slices.each(function(index,slice){return $(slice).attr("label")===d.label?void $(slice).find("path").d3Click():void 0}),AttChartSelectionService.notifyChartsSelected("attPieChart; legend selection")}),configObj.syncLegend){var $rects=$(legend.node()).find("rect"),self=this;$rects.mouseover(function(d){self.addWedgeTrigger(d.target,group,"wedge-popout")}),$rects.mouseout(function(d){self.addWedgeTrigger(d.target,group,"wedge-popin")})}{AttChartUtils.getChartsMaxTextLength()}legendGroup.append("svg:text").attr("x",legendWidth-lineHeight-linePad).attr("y",13).attr("dy",".12em").style("text-anchor","end").text(function(d){return Utils.shortenText(d.label,AttChartUtils.getChartsMaxTextLength(),!0)}).append("svg:title").text(function(d){return d.label})}},addWedgeTrigger:function(legendRect,pie,eventName){var label=$(legendRect).parent().find("title").text(),$slice=$(pie.node()).find('path[label="'+label+'"]');$slice&&$slice.d3Trigger(eventName)},overrideLibs:function(d3Object,width,height){AttChartUtils.setD3Size(d3Object,width,height,!0),$(d3Object.node()).parent().css("display","inline-block")}}}])}(angular);
!function(angular){"use strict";var bubbleChartModule=angular.module("attBubbleChart",[]);bubbleChartModule.directive("attBubbleChart",["attChartSelectionService","attChartOverlayService",function(AttChartSelectionService,AttChartOverlayService){return{restrict:"E",scope:{config:"=",data:"=",api:"=?"},templateUrl:"scripts/angular.common/attCharts/attBubbleChart/attBubbleChart.html",link:function(scope,element){window.onresize=function(){return scope.$apply()},scope.attBubbleRender=function(data,config){var configObj=scope.getDefaultConfig();$.extend(configObj,config),scope.validateConfig(configObj),scope.configObj=configObj;var width=parseInt(configObj.width),height=parseInt(configObj.height),selector=configObj.selector,pad=configObj.padding,chart=d3.selectAll(selector+" .attBubbleChartChart");chart.selectAll("*").remove(),AttChartOverlayService.removeOverlay(scope,element);{var svg=chart.append("svg:svg").attr("width",width).attr("height",height).append("svg:g");AttChartUtils.addChartTitle(configObj,svg,height,width)}if(!data||data.length<1)return scope.overrideLibs(svg,width,height),void AttChartOverlayService.addOverlay(scope,element,width,height);var bubbleCompare=function(a,b){return+a[configObj.zElement]<+b[configObj.zElement]?1:+a[configObj.zElement]>+b[configObj.zElement]?-1:0};data.sort(bubbleCompare);var yreturn=scope.doYAxis(configObj,data,width,height,pad,svg);pad=yreturn.pad;var xreturn=scope.doXAxis(configObj,data,width,height,pad,svg,yreturn.scaley);height=xreturn.height,scope.doShapes(configObj,data,width,height,yreturn.scaley,xreturn.scalex,svg,xreturn.xDateFormatter,yreturn.yDateFormatter),scope.overrideLibs(svg,width,height)},scope.$watchGroup(["data","config"],function(newVals){return!newVals||newVals.length<1?scope.attBubbleRender(newVals):scope.attBubbleRender(newVals[0],newVals.length>1?newVals[1]:void 0)}),scope.getDefaultConfig=function(){return{id:"att-bubble-chart",selector:"",width:"950",height:"450",title:"",showHorizontalRules:!0,showVerticalRules:!0,singleSelect:!1,xAxisTitle:"",yAxisTitle:"",zAxisTitle:"",xIsInt:!1,xIsDate:!1,xIsTime:!1,yIsInt:!1,yIsDate:!1,yIsTime:!1,addLegend:!1,legend:[],bubbleColor:AttChartUtils.getAttunityChartUnselectedColor(),selectedColor:AttChartUtils.getAttunityChartSelectionColor(),handleSelections:!0,xTooltipFormatter:function(x){return Utils.formatNumber(x)},yTooltipFormatter:function(y){return Utils.formatNumber(y)},zTooltipFormatter:function(z){return Utils.formatNumber(z)},displayName:"",specialLabel:"bubble-chart",shadedArea:"",shadedAreaHoverText:"",pivotField:"",padding:[30,30,45,50],synchData:""}},scope.validateConfig=function(configObj){return configObj?(configObj.nameElement=configObj.nameElement&&"string"==typeof configObj.nameElement?configObj.nameElement:configObj.zElement,void(configObj.selector=(configObj.selector&&"string"==typeof configObj.selector?configObj.selector:"")+" .attBubbleChartContainer")):void console.log("Error reading bubble chart configuration.")},scope.overrideLibs=function(svg,width,height){var $node=$(svg.node());AttChartUtils.setD3Size(svg,width,height,!0),$node.parent().css("display","inline-block")},scope.timeFormat=function(formats){return function(date){for(var i=formats.length-1,f=formats[i];!f[1](date);)f=formats[--i];return f[0](date)}},scope.customTimeFormat=function(){scope.timeFormat([[d3.time.format("%Y"),function(){return!0}],[d3.time.format("%b"),function(d){return d.getMonth()}],[d3.time.format("%b %d"),function(d){return 1!=d.getDate()}],[d3.time.format("%a %d"),function(d){return d.getDay()&&1!=d.getDate()}],[d3.time.format("%H:%M"),function(d){return d.getHours()}],[d3.time.format("%H:%M"),function(d){return d.getMinutes()}],[d3.time.format(":%S"),function(d){return d.getSeconds()}],[d3.time.format(".%L"),function(d){return d.getMilliseconds()}]])},scope.tooltipFormat=function(text){var str=text.toString();return $.isNumeric(str)?str.indexOf(".")<0?str.comify():parseFloat(str).toFixed(2).comify():str},scope.doXAxis=function(configObj,data,width,height,pad,svg,scaley){var xDateFormatter;configObj.xIsDate&&(xDateFormatter=Utils.autoSelectDateFormatter(data[0][configObj.xElement]));var xticks,bottomLabelFormatter,scalex=AttChartUtils.autoSelectScale(data,configObj.xElement,pad[0],width-pad[2],configObj.xIsDate,configObj.xIsTime,configObj.id,xDateFormatter),xmin=scalex.min,xmax=scalex.max,xfactor=scalex.factor,xscale=scalex.scale;configObj.xIsDate?(xticks=xscale.ticks(scalex.tick_freq,scalex.tick_jump),bottomLabelFormatter=scope.customTimeFormat):(xticks=xscale.ticks(configObj.xIsInt&&1==xfactor&&10>xmax-xmin?xmax-xmin:10),bottomLabelFormatter=AttChartUtils.formatTicks(xticks));var rotationInfo=AttChartUtils.getLabelRotationInfo(xticks,xscale,bottomLabelFormatter,void 0,configObj.selector),rotateLabels=rotationInfo.shouldRotate,xLabelHeight=(rotateLabels?rotationInfo.rotatedPixelHeight+5:15)+10;height+=xLabelHeight,configObj.xAxisTitle&&AttChartUtils.drawXAxisTitle(svg,configObj.xAxisTitle,xfactor,pad[0]+(width-pad[0]-pad[2])/2,height,scaley.scale(scaley.min)+xLabelHeight,configObj.xIsTime);var xrule=svg.selectAll("g.xrule").data(xticks).enter().append("svg:g").attr("class","xrule").attr("transform",function(d){return"translate("+xscale(d)+",0)"}),vertLines=xrule.append("svg:line").attr("y1",scaley.scale(scaley.min)).attr("y2",scaley.scale(scaley.max));return configObj.showVerticalRules&&vertLines.style("stroke",function(){return"#000"}).style("stroke-opacity",function(d){return d?.3:null}),xrule.append("svg:text").attr("text-anchor",rotateLabels?"end":"middle").attr("dx",rotateLabels?"-.28em":"0").attr("dy",rotateLabels?".25em":".71em").attr("transform",function(){return"translate(0, "+(scaley.scale(scaley.min)+6)+") rotate("+(rotateLabels?-65:0)+",0,0)"}).attr("class","att-axis-ticks").text(function(d){return bottomLabelFormatter(d)}),{scalex:scalex,height:height,xDateFormatter:xDateFormatter}},scope.doYAxis=function(configObj,data,width,height,pad,svg){var yDateFormatter;configObj.yIsDate&&(yDateFormatter=Utils.autoSelectDateFormatter(data[0][configObj.yElement]));var scaley=AttChartUtils.autoSelectScale(data,configObj.yElement,height-pad[3],pad[1],configObj.yIsDate,configObj.yIsTime,configObj.id,yDateFormatter),ymin=scaley.min,ymax=scaley.max,yfactor=scaley.factor,yscale=scaley.scale;configObj.yAxisTitle&&AttChartUtils.drawYAxisTitle(svg,configObj.yAxisTitle,void 0,yfactor,height,pad,configObj.yIsTime);var yticks,yLabelFormatter;configObj.yIsDate?(yticks=yscale.ticks(scaley.tick_freq,scaley.tick_jump),yLabelFormatter=scope.customTimeFormat):(yticks=yscale.ticks(configObj.yIsInt&&1==yfactor&&10>ymax-ymin?ymax-ymin:10),yLabelFormatter=AttChartUtils.formatTicks(yticks)),pad[0]+=AttChartUtils.getPaddingSpaceForAxis(yticks,yLabelFormatter);var yrule=svg.selectAll("g.yrule").data(yticks).enter().append("svg:g").attr("class","yrule").attr("transform",function(d){return"translate(0,"+yscale(d)+")"}),horizLines=yrule.append("svg:line").attr("x1",pad[0]).attr("x2",width-pad[2]);return configObj.showHorizontalRules&&horizLines.style("stroke",function(){return"#000"}).style("stroke-opacity",function(d){return d?.3:null}),yrule.append("svg:text").attr("x",pad[0]-10).attr("dy",".35em").attr("text-anchor","end").text(function(d){return yLabelFormatter(d)}),{scaley:scaley,pad:pad,yDateFormatter:yDateFormatter}},scope.dolegend=function(configObj,bubbles,pad,scaley){if(configObj.addLegend){pad[0]+=140;var theLegend=svg.selectAll(".legend").data(configObj.legend).enter().append("g").attr("class","legend").attr("transform",function(d,i){return"translate(0,"+(scaley.scale(scaley.min)+20*(i+1))+")"});theLegend.append("rect").attr("x",p[0]-20).attr("width",18).attr("height",18).attr("bubbleSelected",0).attr("category",function(d){return d.level}).style("data-fill",function(d){return d.color}).style("fill",function(d){return d.color}).on("click",function(){var bubbleSelected=0==d3.select(this).attr("bubbleSelected")?1:0;d3.select(this).attr("bubbleSelected",bubbleSelected);var category=d3.select(this).attr("category");bubbles.selectAll("[category='"+category+"']").style("fill",function(){return 1==bubbleSelected?"gold":scope.getCircleColor(configObj,category)}).attr("bubbleSelected",bubbleSelected),AttChartSelectionService.notifyChartsSelected("attBubbleChart; bubble selection")}),theLegend.append("text").attr("x",pad[0]-25).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(d){return d.level})}return pad},scope.doPolygon=function(configObj,scalex,scaley){var polygon,ymin=scaley.min,ymax=scaley.max,yfactor=scaley.factor,yscale=scaley.scale,xmin=scalex.min,xmax=scalex.max,xfactor=scalex.factor,xscale=scalex.scale;if(configObj.shadedArea)if("upperRightRectangle"==configObj.shadedArea){for(var points=[[xscale((xmax+xmin)/2),yscale(ymax)],[xscale((xmax+xmin)/2),yscale((ymax+ymin)/2)],[xscale(xmax),yscale((ymax+ymin)/2)],[xscale(xmax),yscale(ymax)]],pointsStr="",i=0;i<points.length;i++)pointsStr+=points[i][0]+","+points[i][1]+" ";polygon=svg.append("polygon").attr("class","shaded").attr("points",pointsStr).style("fill","orange").style("fill-opacity","0.25")}else if("upperLeftTriangle"==configObj.shadedArea){var pointsULT=[];pointsULT.push([xscale(xmin),yscale(ymax)]);var xminReal=xmin*xfactor,xmaxReal=xmax*xfactor,yminReal=ymin*yfactor,ymaxReal=ymax*yfactor;if(yminReal>xmaxReal?(pointsULT.push([xscale(xmin),yscale(ymin)]),pointsULT.push([xscale(xmax),yscale(ymin)]),pointsULT.push([xscale(xmax),yscale(ymax)])):(yminReal>xminReal?(pointsULT.push([xscale(xmin),yscale(ymin)]),pointsULT.push([xscale(yminReal/xfactor),yscale(ymin)])):pointsULT.push([xscale(xmin),yscale(xminReal/yfactor)]),ymaxReal>xmaxReal?(pointsULT.push([xscale(xmax),yscale(xmaxReal/yfactor)]),pointsULT.push([xscale(xmax),yscale(ymax)])):pointsULT.push([xscale(ymaxReal/xfactor),yscale(ymax)])),ymaxReal>xminReal){for(var pointsStr="",i=0;i<pointsULT.length;i++)pointsStr+=pointsULT[i][0]+","+pointsULT[i][1]+" ";polygon=svg.append("polygon").attr("class","shaded").attr("points",pointsStr).style("fill","orange").style("fill-opacity","0.25")}}else if("20PercentDifference"==configObj.shadedArea){var xminReal=xmin*xfactor,xmaxReal=xmax*xfactor,yminReal=ymin*yfactor,ymaxReal=ymax*yfactor,pointsLR=[];pointsLR.push([xscale(xmax),yscale(ymin)]);var xLR=yminReal/.8/xfactor,xUR=ymaxReal/.8/xfactor,yLR=.8*xminReal/yfactor,yUR=.8*xmaxReal/yfactor;xmin>xUR?xUR=xmin:xUR>xmax&&(xUR=xmax),ymin>yLR?yLR=ymin:yLR>ymax&&(yLR=ymax),yUR>ymax?(pointsLR.push([xscale(xmax),yscale(ymax)]),pointsLR.push([xscale(xUR),yscale(ymax)])):yUR>ymin&&pointsLR.push([xscale(xmax),yscale(yUR)]),xmin>xLR?(pointsLR.push([xscale(xmin),yscale(yLR)]),pointsLR.push([xscale(xmin),yscale(ymin)])):xmax>xLR&&pointsLR.push([xscale(xLR),yscale(ymin)]);for(var pointsStr="",i=0;i<pointsLR.length;i++)pointsStr+=pointsLR[i][0]+","+pointsLR[i][1]+" ";polygon=svg.append("polygon").attr("class","shaded").attr("points",pointsStr).style("fill","orange").style("fill-opacity","0.25")}void 0!=polygon&&polygon.on("mouseover",function(d,i){for(var lines=[],i=0;i<configObj.shadedAreaHoverText.length;i++)lines.push(configObj.shadedAreaHoverText[i]);AttChartUtils.getPowertip(this,lines)}).on("mouseout",function(){AttChartUtils.hideAllPowertips()})},scope.getCircleColor=function(configObj){return configObj.addLegend?void 0:configObj.bubbleColor},scope.doShapes=function(configObj,data,width,height,scaley,scalex,svg,xDateFormatter,yDateFormatter){var zscale=0;if(void 0!=configObj.zElement){var zmin=d3.min(data,function(d){return+d[configObj.zElement]}),zmax=d3.max(data,function(d){return+d[configObj.zElement]});zscale=zmin/50,zmax/zscale>2e3&&(zscale=zmax/2e3)}var radius,shapes,elem=svg.selectAll("g.circle").data(data),bubbles=elem.enter().append("g").attr("transform",function(d){return"translate("+scalex.scale(configObj.xIsDate?new Date(xDateFormatter(d[configObj.xElement])):d[configObj.xElement]/scalex.factor)+","+scaley.scale(configObj.yIsDate?new Date(yDateFormatter(d[configObj.yElement])):d[configObj.yElement]/scaley.factor)+")"}),bubbleCount=0;void 0==configObj.zElement?(radius=function(){return 5},shapes=bubbles.append("svg:polygon").attr("points",function(d){var len=radius(d);return"-"+len+",0 0,"+len+" "+len+",0 0,-"+len})):(radius=function(d){return 0==zscale?2:Math.max(Math.sqrt(d[configObj.zElement]/zscale),5)},shapes=bubbles.append("svg:circle").attr("r",function(d){return radius(d)})),shapes.attr("class",function(){return"bubble"}).attr("selector",configObj.selector).attr("selection-id",function(){return"attBubbleChart-shape-"+bubbleCount++}).attr("bubbleId",function(d){var bubbleId=d[configObj.nameElement];return"string"==typeof bubbleId&&(bubbleId=AttChartUtils.escapeChartObjectId(bubbleId)),bubbleId}).attr("pivotData",function(d){if(configObj.pivotField){var pivotPoint={};return pivotPoint[configObj.pivotField]=d[configObj.pivotField],AttChartUtils.buildChartPivots(pivotPoint)}return""}).attr("synchData",function(d){return d[configObj.synchData]}).attr("bubbleSelected",0).attr("pivotSelected",0).attr("selector",configObj.selector).attr("category",function(d){return configObj.addLegend?d.level:""}).style("fill",function(d){return configObj.addLegend?scope.getCircleColor(configObj,d.level):configObj.bubbleColor}).attr("data-fill",function(d){return configObj.addLegend?scope.getCircleColor(configObj,d.level):configObj.bubbleColor}).attr("opacity","0.8").on("click",function(){var scope=angular.element(this).scope(),synchData=d3.select(this).attr("synchData");scope.api.onBubbleSelectionChanged?(scope.api.onBubbleSelectionChanged(synchData),AttChartSelectionService.notifyChartsSelected("attBubbleChart; bubble selection")):scope.api.selectItem(this)}).on("mouseover",function(d){var lines=[],line="",nameElement=configObj.nameElement;line="Key"===nameElement?d[nameElement]:""!=configObj.displayName?configObj.displayName:nameElement,line=line+": "+Utils.formatNumber(d[nameElement]),lines.push(line);var originalValue=d[nameElement+" - Original"];void 0!==originalValue&&originalValue!==d[nameElement]&&lines.push(Utils.formatNumber("["+originalValue+"]")),void 0!=configObj.zElement&&lines.push((""!=configObj.zAxisTitle?configObj.zAxisTitle:configObj.zElement)+": "+configObj.zTooltipFormatter(d[configObj.zElement],0)),lines.push(configObj.xAxisTitle+": "+(configObj.xIsDate?d[configObj.xElement]:configObj.xTooltipFormatter(d[configObj.xElement],0))),lines.push(configObj.yAxisTitle+": "+(configObj.yIsDate?d[configObj.yElement]:configObj.yTooltipFormatter(d[configObj.yElement],0))),AttChartUtils.getPowertip(this,lines)}).on("mouseout",function(){AttChartUtils.hideAllPowertips()}),d3.select(configObj.selector+" svg").attr("width",width).attr("height",height)},scope.api||(scope.api={}),scope.api.selectItem=function(item){var configObj=scope.configObj;if(!configObj.linkedTable)if(configObj.singleSelect)d3.select(configObj.selector).selectAll("circle[bubbleSelected='1'], polygon[bubbleSelected='1']").each(function(){d3.select(item).attr("bubbleSelected",0).attr("pivotSelected",0).style("stroke",function(){return scope.getCircleColor(configObj,d3.select(item).attr("category"))}).style("stroke-width",function(){return"3px"})});else{var isSelect=0==d3.select(item).attr("bubbleSelected");d3.select(item).attr("bubbleSelected",isSelect?1:0).attr("pivotSelected",isSelect?1:0).style("stroke",function(){return isSelect?configObj.selectedColor:scope.getCircleColor(configObj,d3.select(this).attr("category"))}).style("stroke-width",function(){return isSelect?"3px":"1px"})}AttChartSelectionService.notifyChartsSelected("attBubbleChart; bubble selection")},scope.api.clearBubbleSelections=function(skipBubbleOpacity){scope.configObj&&(d3.selectAll('.bubble[bubbleSelected="1"]').each(function(){d3.select(this).style("fill",d3.select(this).attr("data-fill")).attr("bubbleSelected","0").style("stroke",function(){return scope.getCircleColor(scope.configObj,d3.select(this).attr("category"))})}),skipBubbleOpacity||d3.selectAll(".bubble[opacity]").each(function(){d3.select(this).attr("opacity","0.01").attr("selected","0").attr("pivotSelected","0")}),d3.selectAll('circle[pivotData][pivotSelected="1"][data-fill]').each(function(){d3.select(this).style("fill",d3.select(this).attr("data-fill")).attr("pivotSelected","0").attr("selected","0")}),AttChartSelectionService.notifyChartsSelected("attBubbleChart; bubble selection"))}}}}])}(angular);
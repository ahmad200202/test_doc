!function(angular){"use strict";var lineChartModule=angular.module("attLineChart",[]);lineChartModule.directive("attLineChart",["attChartSelectionService","attChartOverlayService","GlobalEvents",function(AttChartSelectionService,AttChartOverlayService,GlobalEvents){return{restrict:"E",scope:{config:"=",data:"=",rightData:"="},templateUrl:"scripts/angular.common/attCharts/attLineChart/attLineChart.html",link:function(scope,element){window.onresize=function(){return scope.$apply()};var self=this;scope.attLineRender=function(data,config,dataRight){angular.forEach(data,function(metric){if(metric.length>0&&void 0!=metric[0].size){var length=config.yAxisTitle.indexOf("(");config.yAxisTitle=config.yAxisTitle.substring(0,length)+"("+metric[0].size+")"}});var configObj=self.getDefaultConfig();$.extend(configObj,ObjectUtils.deepClone(config)),self.validateConfig(configObj);var width=parseInt(configObj.width),height=parseInt(configObj.height),pad=configObj.padding,chart=d3.selectAll(configObj.selector+" .attLineChartChart");chart.selectAll("*").remove(),AttChartOverlayService.removeOverlay(scope,element);var svg=chart.append("svg:svg").attr("width",width).attr("height",height).append("svg:g");$(svg.node()).parent().width(width);AttChartUtils.addChartTitle(configObj,svg,height,width);if(self.isEmptyDataset(data,dataRight))return void AttChartOverlayService.addOverlay(scope,element,width,height);angular.forEach(data,function(metric){AttChartUtils.sortArrayByAggregationLevel(metric,"x","ascending")}),dataRight&&angular.forEach(dataRight,function(metric){AttChartUtils.sortArrayByAggregationLevel(metric,"x","ascending")});var entries=d3.entries(data),entriesRight=dataRight?d3.entries(dataRight):void 0,keys=d3.keys(data),keysRight=d3.keys(dataRight),pivotLabel=configObj.pivotLabel,maxStringLength=AttChartUtils.getChartsMaxTextLength(),colorScheme=configObj.colorScheme;(!entriesRight&&entries.length<5||entriesRight&&entriesRight.length+entries.length<5)&&(colorScheme=AttChartUtils.getAttunityDistinctColorScheme());var scaleyRight,yminRight,ymaxRight,yfactorRight,yscaleRight,scaley=AttChartUtils.autoSelectScale(entries,"y",height-pad[3],pad[1],!1,configObj.yIsTime,configObj.specialLabel),ymin=scaley.min,ymax=scaley.max,yfactor=scaley.factor,yscale=scaley.scale;if(dataRight&&(scaleyRight=AttChartUtils.autoSelectScale(entriesRight,"y",height-pad[3],pad[1],!1,configObj.yRightIsTime,configObj.specialLabel),yminRight=scaleyRight.min,ymaxRight=scaleyRight.max,yfactorRight=scaleyRight.factor,yscaleRight=scaleyRight.scale),configObj.addLegend){pad[0]+=AttChartUtils.getChartsLegendSize();var theLegend=svg.selectAll(".legend").data(keys).enter().append("g").attr("class","legend").attr("transform",function(d,i){return"translate(0,"+(yscale(ymin)+-20*(i+1))+")"}),legendRects=theLegend.append("rect").attr("x",pad[0]-30).attr("width",18).attr("height",18).attr("selected",0).attr("legend","1").attr("category",function(d,i){return keys[i]}).style("fill",function(d,i){return colorScheme[i]}).style("cursor",function(){return configObj.legendClickable?"pointer":"default"});self.addLegendClickMethod(configObj,legendRects,!1);var maxStringLength=AttChartUtils.getChartsMaxTextLength();theLegend.append("text").attr("x",pad[0]-35).attr("y",9).attr("dy",".35em").attr("legend","1").style("text-anchor","end").text(function(d,i){var hasMeta=keys[i].indexOf(configObj.metaDelimiter)>-1,text=keys[i];if(hasMeta){var parts=text.split(configObj.metaDelimiter);parts.length>1&&(text=parts[1])}return Utils.shortenText(text,maxStringLength,!0)}).on("mouseover",function(d,i){var hasMeta=keys[i].indexOf(configObj.metaDelimiter)>-1,text=keys[i];if(hasMeta){var parts=text.split(configObj.metaDelimiter);parts.length>1&&(text=parts[1]+" ("+configObj.metaPreposition+" "+parts[0]+")")}AttChartUtils.getPowertip(this,[text])})}if(dataRight&&configObj.addLegendRight){pad[2]+=AttChartUtils.getChartsLegendSize();var chartWidth=width-pad[2],theLegendRight=svg.selectAll(".legendRight").data(keysRight).enter().append("g").attr("class","legendRight").attr("transform",function(d,i){return"translate(0,"+(yscaleRight(yminRight)+-20*(i+1))+")"}),legendRectsRight=theLegendRight.append("rect").attr("x",chartWidth+10).attr("width",18).attr("height",18).attr("selected",0).attr("category",function(d,i){return keysRight[i]}).style("fill",function(d,i){return colorScheme[i+entries.length]}).style("cursor",function(){return configObj.legendClickable?"pointer":"default"});self.addLegendClickMethod(configObj,legendRectsRight,!0),theLegendRight.append("text").attr("x",chartWidth+33).attr("y",9).attr("dy",".35em").style("text-anchor","start").text(function(d,i){return Utils.shortenText(keysRight[i],maxStringLength,!0)}).append("svg:title").text(function(d){return d.length>maxStringLength?d:""})}var yAxisColor=configObj.addLegend?void 0:colorScheme[0];if(AttChartUtils.drawYAxisTitle(svg,configObj.yAxisTitle,yAxisColor,yfactor,height,pad,configObj.yIsTime),dataRight){var yAxisColorRight=configObj.addLegend?void 0:colorScheme[1];AttChartUtils.drawYAxisRightTitle(svg,configObj.yAxisRightTitle,yAxisColorRight,yfactorRight,width,height,pad,configObj.yRightIsTime)}var yTicks=yscale.ticks(configObj.yIsInt&&1==yfactor&&10>ymax-ymin?ymax-ymin:10),yLabelFormatter=AttChartUtils.formatTicks(yTicks);if(pad[0]+=AttChartUtils.getPaddingSpaceForAxis(yTicks,yLabelFormatter),dataRight){var yTicksRight=yscaleRight.ticks(configObj.yRightIsInt&&10>ymaxRight-yminRight?ymaxRight-yminRight:10),yLabelFormatterRight=AttChartUtils.formatTicks(yTicksRight);pad[2]+=AttChartUtils.getPaddingSpaceForAxis(yTicksRight)}var yrule=svg.selectAll("g.rule").data(yTicks).enter().append("svg:g").attr("class","rule").attr("text-anchor","end").attr("transform",function(d){return"translate(0,"+yscale(d)+")"}),chartWidth=width-pad[2],horizLines=yrule.append("svg:line").attr("x1",pad[0]).attr("x2",chartWidth);if(configObj.showHorizontalRules&&horizLines.style("stroke",function(){return"#000"}).style("stroke-opacity",function(d){return d!=ymin?.3:null}),yrule.append("svg:text").attr("x",pad[0]-10).attr("dy",".35em").attr("text-anchor","end").text(function(d){return yLabelFormatter(d)}),dataRight){var yRuleRight=svg.selectAll("g.ruleRight").data(yTicksRight).enter().append("svg:g").attr("class","ruleRight").attr("transform",function(d){return"translate(0,"+yscaleRight(d)+")"});yRuleRight.append("svg:text").attr("x",chartWidth+10).attr("dy",".35em").text(function(d){return yLabelFormatterRight(d)})}var xDomainValues=d3.values(data)[0].map(function(c){return c.x}),xscale=d3.scale.ordinal().rangeRoundBands([pad[0],chartWidth],1);xscale.domain(xDomainValues);var rotationInfo=AttChartUtils.getLabelRotationInfo(xDomainValues,xscale,void 0,void 0,configObj.selector),rotateLabels=rotationInfo.shouldRotate,xLabelHeight=rotateLabels?rotationInfo.rotatedPixelHeight+10:15;configObj.xAxisTitle&&configObj.xAxisTitle.length>0&&(xLabelHeight+=20),height+=xLabelHeight,height=AttChartUtils.drawXAxisTitle(svg,configObj.xAxisTitle,1,pad[0]+(chartWidth-pad[0])/2,height,yscale(ymin)+xLabelHeight,!1);var labelValues=AttChartUtils.clearExtraLabels(configObj.selector,xDomainValues,chartWidth-pad[0]),xfunc=function(x1,x2,dataLength){return 1==dataLength?function(){return x1+(x2-x1)/2}:function(d){return xscale(d)}}(pad[0],chartWidth,labelValues.length);svg.selectAll("g.text").data(labelValues).enter().append("svg:text").attr("text-anchor",rotateLabels?"end":"middle").attr("dx",rotateLabels?"-.28em":"0").attr("dy",rotateLabels?".25em":".71em").attr("selected",0).attr("xvertex",configObj.bottomLabelFormatter).attr("transform",function(d){return 0===d||d?"translate("+xfunc(d)+", "+(yscale(ymin)+10)+") rotate("+(rotateLabels?-65:0)+",0,0)":void 0}).text(configObj.bottomLabelFormatter).style("cursor","pointer").on("click",function(){var xvertex=d3.select(this).attr("xvertex"),circle=d3.select(configObj.selector).selectAll("circle[xvertex='"+xvertex+"']"),xNum=circle.attr("xvertex-num"),selected=d3.select(configObj.selector).selectAll("circle[xvertex='"+xvertex+"'][selected='1']").empty()?1:0;if(selected){circle.attr("selected",1).attr("pivotSelected",1);var selectedAdjacents=d3.select(configObj.selector).selectAll("circle[selected='1']"),minNum=xNum,maxNum=xNum;selectedAdjacents[0].length>1&&configObj.xContiguous&&(minNum=d3.min(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")}),maxNum=d3.max(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")})),self.clearSelections(configObj);for(var j=parseInt(minNum);j<=parseInt(maxNum);j++)d3.select(configObj.selector).selectAll("circle[xvertex-num='"+j+"']").attr("selected","1").attr("pivotSelected","1").attr("opacity",configObj.selectedOpacity)}else d3.select(configObj.selector).selectAll("circle[selected='1']").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity);AttChartSelectionService.notifyChartsSelected("attLineChart; text selection")});var cause=svg.selectAll("g."+configObj.specialLabel+"-attribute").data(entries).enter().append("svg:g").attr("class",function(d,i){return configObj.specialLabel+"-attribute "+configObj.specialLabel+" "+configObj.specialLabel+"-"+keys[i]}),line=d3.svg.line().x(function(d){return xscale(d.x)}).y(function(d){return yscale(d.y/yfactor)});cause.append("path").attr("class","line").attr("d",function(d){return line(d.value)}).attr("category",function(d,i){return keys[i]}).attr("stroke-width",2).style("fill","none").style("stroke",function(d,i){return colorScheme[i]}).on("mouseover",function(){AttChartUtils.getPowertip(this,[d3.select(this).attr("category")])}).on("mouseout",function(){AttChartUtils.hideAllPowertips()}),self.addLineClickMethod(configObj,cause);for(var i=0;i<entries.length;i++)if(1==entries[i].value.length&&void 0!=entries[i].value[0].y){svg.append("svg:circle").attr("class",function(){return"singlePoint"}).attr("selected",0).attr("pivotSelected",0).attr("selector",configObj.selector).attr("pivotData",function(){var pivotPoint={};return pivotPoint[pivotLabel]=entries[i].value.x,encodeURIComponent(JSON.stringify(pivotPoint))}).attr("data-fill",colorScheme[i]).style("fill",colorScheme[i]).style("cursor","pointer").attr("opacity",.8).attr("cx",pad[0]+(chartWidth-pad[0])/2).attr("cy",yscale(+entries[i].value[0].y/yfactor)).attr("r",4)}if(dataRight){var causeRight=svg.selectAll("g."+configObj.specialLabel+"-attribute-overlay").data(entriesRight).enter().append("svg:g").attr("class",function(d,i){return configObj.specialLabel+"-attribute-overlay "+configObj.specialLabel+" "+configObj.specialLabel+"-"+keysRight[i]}),lineRight=d3.svg.line().x(function(d){return xscale(d.x)}).y(function(d){return yscaleRight(d.y/yfactorRight)});causeRight.append("path").attr("class","line").attr("d",function(d){return lineRight(d.value)}).attr("category",function(d,i){return keysRight[i]}).attr("stroke-width",2).style("fill","none").style("stroke",function(d,i){return colorScheme[i+entries.length]}).on("mouseover",function(){AttChartUtils.getPowertip(this,[d3.select(this).attr("category")])}).on("mouseout",function(){AttChartUtils.hideAllPowertips()}),self.addLineClickMethod(configObj,causeRight);for(var i=0;i<entriesRight.length;i++)1==entriesRight[i].value.length&&void 0!=entriesRight[i].value[0].y&&svg.append("svg:circle").attr("class",function(){return"singlePoint"}).attr("selected",0).attr("pivotSelected",0).attr("selector",configObj.selector).attr("pivotData",function(){var pivotPoint={};return pivotPoint[pivotLabel]=entriesRight[i].value.x,encodeURIComponent(JSON.stringify(pivotPoint))}).attr("data-fill",colorScheme[i+entries.length]).style("fill",colorScheme[i+entries.length]).style("cursor","pointer").attr("opacity",.8).attr("cx",pad[0]+(chartWidth-pad[0])/2).attr("cy",yscaleRight(+entriesRight[i].value[0].y/yfactorRight)).attr("r",4)}self.selectVertices(configObj,svg,entries,scaley,xscale,configObj.tooltipFormatInfo,!1),dataRight&&self.selectVertices(configObj,svg,entriesRight,scaleyRight,xscale,configObj.tooltipFormatInfoRight,!0),d3.selectAll(configObj.selector+" svg").attr("width",width).attr("height",height).style("height",height+"px").style("width",width),d3.selectAll(configObj.selector+" svg g").attr("width",width).attr("height",height).style("height",height+"px").style("width",width),configObj.lineGroups&&$.each(configObj.lineGroups,function(index,value){$.each(value,function(index,value){if(index>0){var categorySelector="circle[category='"+value+"']";d3.select(configObj.selector).selectAll(categorySelector).attr("pivotData","")}})}),!configObj.addLegend||configObj.addLegendRight&&dataRight||AttChartUtils.adjustChartTitle(svg),self.overrideLibs(svg,width,height),AttChartUtils.adjustResolutionSelector(element[0].parentElement.id,width,GlobalEvents)},scope.$watchGroup(["data","config","rightData"],function(newVals){return!newVals||newVals.length<1?scope.attLineRender(newVals):void scope.attLineRender(newVals[0],newVals.length>1?newVals[1]:void 0,newVals.length>2?newVals[2]:void 0)})},getDefaultConfig:function(){return{id:"att-line-chart",selector:"",title:"",width:"300",height:"300",addLegend:!0,addLegendRight:!1,legendClickable:!0,legend:[],xAxisTitle:"",yAxisTitle:"",yAxisRightTitle:"",yIsInt:!1,yIsTime:!1,yRightIsInt:!1,yRightIsTime:!1,specialLabel:"att-line-chart",showHorizontalRules:!1,xContiguous:!1,yContiguous:!1,pivotLabel:"x-factors",pivotField:"",pivotAttribute:"",xPivotFilterName:"",yPivotFilterName:"",yRightPivotFilterName:"",yTooltipFormatter:function(y){return Utils.formatNumber(y)},yRightTooltipFormatter:function(y){return Utils.formatNumber(y)},bottomLabelFormatter:function(x){return x},selectedColor:AttChartUtils.getAttunityChartSelectionColor(),colorScheme:AttChartUtils.getAttunityColorScheme(),selectedOpacity:AttChartUtils.getAttunityChartSelectedOpacity(),unselectedOpacity:AttChartUtils.getAttunityChartUnselectedOpacity(),tooltipFormatInfo:{yValueType:"",yValueDecorator:"",zVerbOrPreposition:"for",xVerbOrPreposition:"in"},tooltipFormatInfoRight:{yValueType:"",yValueDecorator:"",zVerbOrPreposition:"for",xVerbOrPreposition:"in"},metaDelimiter:"::",metaPreposition:"for"}},isEmptyDataset:function(data,dataRight){return dataRight?AttChartUtils.isEmptyData(data)&&AttChartUtils.isEmptyData(dataRight):AttChartUtils.isEmptyData(data)},overrideLibs:function(svg,width,height){var $node=$(svg.node());AttChartUtils.setD3Size(svg,width,height,!0),$node.parent().css("display","inline-block")},validateConfig:function(configObj){return configObj?(configObj.padding=configObj.padding&&Array.isArray(configObj.padding)&&4===configObj.padding.length?configObj.padding:[30,30,10,50],void(configObj.selector=(configObj.selector&&"string"==typeof configObj.selector?configObj.selector:"")+" .attLineChartContainer")):void console.log("Error reading line chart configuration.")},addLineClickMethod:function(configObj,line){line.on("click",function(){AttChartSelectionService.notifyChartsSelected("attLineChart; line selection")})},addLegendClickMethod:function(configObj,legendRects,isRightLegend){var clickMethod=function(){if(configObj.legendClickable){var category=d3.select(this).attr("category"),elements=d3.select(configObj.selector).selectAll("circle[category='"+category+"']");if(!elements||elements.empty())return;var selected=0==elements.attr("selected")?1:0;if(configObj.lineGroups&&configObj.lineGroups.length>0){var selectedLineGroup=[category];$.each(configObj.lineGroups,function(index,value){-1!=$.inArray(category,value)&&(selectedLineGroup=value)}),$.each(selectedLineGroup,function(index,value){var categorySelector="circle[category='"+value+"']";d3.select(configObj.selector).selectAll(categorySelector).attr("opacity",1==selected?configObj.selectedOpacity:configObj.unselectedOpacity).attr("selected",selected).attr("pivotSelected",selected)})}else elements.attr("opacity",1==selected?configObj.selectedOpacity:configObj.unselectedOpacity).attr("selected",selected).attr("pivotSelected",selected);elements.attr("pivotData",function(d){var pivotPoint={};return configObj.xPivotFilterName&&(pivotPoint[configObj.xPivotFilterName]=d3.select(this).attr("xvertex")),isRightLegend?configObj.yRightPivotFilterName&&(pivotPoint[configObj.yRightPivotFilterName]=d3.select(this).attr("yvertex")):configObj.yPivotFilterName&&(pivotPoint[configObj.yPivotFilterName]=d3.select(this).attr("yvertex")),configObj.pivotField&&(pivotPoint[configObj.pivotField]=configObj.pivotAttribute?d[configObj.pivotAttribute]:category),AttChartUtils.buildChartPivots(pivotPoint)}),AttChartSelectionService.notifyChartsSelected("attLineChart; legend selection")}};legendRects.on("click",clickMethod)},addVertexClickMethod:function(configObj,vertices){var self=this,clickMethod=function(d,i){var selected=0==d3.select(this).attr("selected")?1:0,category=d3.select(this).attr("category"),selectedLineGroup=(d3.select(this).attr("xvertex"),[category]);if(configObj.lineGroups&&configObj.lineGroups.length>0&&$.each(configObj.lineGroups,function(index,value){-1!=$.inArray(category,value)&&(selectedLineGroup=value)}),self.selectItems(configObj,1==selected?d3.select(this):d3.select(configObj.selector).selectAll("circle[selected='1']"),selected),1===selected)for(var selectionsCleared=!1,axisVars=["xvertex","category"],axisVarsReverse=["category","xvertex"],contiguousAxis=["yContiguous","xContiguous"],i=0;i<axisVars.length;i++){var axisVar=axisVars[i],axisVarValue=d3.select(this).attr(axisVar),axisVarRev=axisVarsReverse[i],selectedAdjacents=d3.select(configObj.selector).selectAll("circle[selected='1']["+axisVar+"='"+axisVarValue+"']");if(selectedAdjacents[0].length>1&&configObj[contiguousAxis[i]]){var minNum=d3.min(selectedAdjacents[0],function(d){return+d3.select(d).attr(axisVarRev+"-num")}),maxNum=d3.max(selectedAdjacents[0],function(d){return+d3.select(d).attr(axisVarRev+"-num")});selectionsCleared=!0;for(var j=parseInt(minNum);j<=parseInt(maxNum);j++)$.each(selectedLineGroup,function(index,value){self.selectItems(configObj,d3.select(configObj.selector).select("circle["+axisVarRev+"-num='"+j+"']["+axisVar+"='"+value+"']"),1)})}}AttChartSelectionService.notifyChartsSelected("attLineChart; line vertex selection")};vertices.on("click",clickMethod)},selectVertices:function(configObj,svg,vertices,scaley,xscale,tooltipFormatInfo,isDataRight){for(var yyscale=scaley.scale,yyfactor=scaley.factor,self=this,vertexCount=0,i=0;i<vertices.length;i++){var elem=svg.selectAll("g.circle").data(vertices[i].value),bubbles=elem.enter().append("g").attr("transform",function(d){return"translate("+xscale(d.x)+","+yyscale(d.y/yyfactor)+")"}),circles=bubbles.append("svg:circle").attr("class",function(){return"bubble "+vertices[i].key}).attr("selected",0).attr("pivotSelected",0).attr("category",vertices[i].key).attr("selector",configObj.selector).attr("selection-id",function(){return"attLineChart-vertex-"+vertexCount++}).attr("xvertex",function(d){return d.x}).attr("xvertex-num",function(d,i){return i}).attr("yvertex",function(d){return d.y}).attr("pivotData",function(d){var pivotPoint={};if(configObj.xPivotFilterName&&(pivotPoint[configObj.xPivotFilterName]=d3.select(this).attr("xvertex")),isDataRight?configObj.yRightPivotFilterName&&(pivotPoint[configObj.yRightPivotFilterName]=d3.select(this).attr("yvertex")):configObj.yPivotFilterName&&(pivotPoint[configObj.yPivotFilterName]=d3.select(this).attr("yvertex")),configObj.pivotField)if(configObj.pivotAttribute)pivotPoint[configObj.pivotField]=d[configObj.pivotAttribute];else{var category=d3.select(this).attr("category");pivotPoint[configObj.pivotField]=category}return AttChartUtils.buildChartPivots(pivotPoint)}).attr("opacity",configObj.unselectedOpacity).attr("r",4).style("fill",configObj.selectedColor).style("cursor","pointer").on("mouseover",function(d){d3.select(this).attr("opacity",configObj.selectedOpacity),d.yAxisTitle=isDataRight?configObj.yAxisRightTitle:configObj.yAxisTitle,d.xAxisTitle=configObj.xAxisTitle,d.category=d3.select(this).attr("category"),AttChartUtils.getPowertip(this,AttChartUtils.getTooltipLines(d,tooltipFormatInfo,"y"))}).on("mouseout",function(){d3.select(this).attr("selected");d3.select(this).attr("opacity",0==d3.select(this).attr("selected")?configObj.unselectedOpacity:configObj.selectedOpacity),AttChartUtils.hideAllPowertips()});self.addVertexClickMethod(configObj,circles)}},clearSelections:function(configObj){d3.select(configObj.selector).selectAll("text").attr("selected",0).attr("pivotSelected",0),d3.select(configObj.selector).selectAll("g g circle").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity),d3.select(configObj.selector).selectAll("line").attr("selected",0).attr("pivotSelected",0)},selectItems:function(configObj,items,selected){items.attr("opacity",1==selected?configObj.selectedOpacity:configObj.unselectedOpacity).attr("selected",selected).attr("pivotSelected",selected)}}}])}(angular);
!function(angular){"use strict";var areaChartModule=angular.module("attAreaChart",[]);areaChartModule.directive("attAreaChart",["attChartSelectionService","attChartOverlayService","GlobalEvents",function(AttChartSelectionService,AttChartOverlayService,GlobalEvents){return{restrict:"E",scope:{config:"=",data:"=",lineData:"="},templateUrl:"scripts/angular.common/attCharts/attAreaChart/attAreaChart.html",link:function(scope,element){window.onresize=function(){return scope.$apply()};var self=this;scope.attAreaChartRender=function(data,config,lineData){if(data.length>0&&void 0!=data[0].size){var length=config.yAxisTitle.indexOf("(");config.yAxisTitle=config.yAxisTitle.substring(0,length)+"("+data[0].size+")"}var configObj=self.getDefaultConfig();$.extend(configObj,ObjectUtils.deepClone(config)),self.validateConfig(configObj);var width=parseInt(configObj.width),height=parseInt(configObj.height),selector=configObj.selector,pad=configObj.padding,chart=d3.selectAll(selector+" .attAreaChartChart");chart.selectAll("*").remove(),AttChartOverlayService.removeOverlay(scope,element);var hasLineData=self.hasLineData(lineData);if(hasLineData){var legendSize=AttChartUtils.getChartsLegendSize();pad[0]+=legendSize/2,width+=legendSize}var svg=chart.append("svg:svg").attr("width",width).attr("height",height).append("svg:g");$(svg.node()).parent().width(width);AttChartUtils.addChartTitle(configObj,svg,height,width);if(!data||data.length<1)return void AttChartOverlayService.addOverlay(scope,element,width,height);AttChartUtils.sortArrayByAggregationLevel(data,"label","ascending"),angular.forEach(lineData,function(metric){AttChartUtils.sortArrayByAggregationLevel(metric,"x","ascending")});var scaley=AttChartUtils.autoSelectScale(data,configObj.yElement,height-pad[3],pad[1],!1,configObj.yIsTime,"area-chart"),ymin=scaley.min,ymax=scaley.max,yfactor=scaley.factor,yscale=scaley.scale;AttChartUtils.drawYAxisTitle(svg,configObj.yAxisTitle,void 0,yfactor,height,pad,configObj.yIsTime,configObj.multi,configObj.forcedNumberOfLines);var nticks=10,yticks=yscale.ticks(configObj.yIsInt&&1==yfactor&&nticks>ymax-ymin?ymax-ymin:nticks),yLabelFormatter=AttChartUtils.formatTicks(yticks);pad[0]+=AttChartUtils.getPaddingSpaceForAxis(yticks,yLabelFormatter);var lineDataEntries,lineDataYScale,lineDataYTicks,lineDataYFormatter;hasLineData&&(lineDataEntries=d3.entries(lineData),lineDataYScale=AttChartUtils.autoSelectScale(lineDataEntries,"y",height-pad[3],pad[1],!1,configObj.yRightIsTime,"att-line-chart"),lineDataYTicks=lineDataYScale.scale.ticks(configObj.yRightIsInt&&lineDataYScale.max-lineDataYScale.min<10?lineDataYScale.max-lineDataYScale.min:10),lineDataYFormatter=AttChartUtils.formatTicks(lineDataYTicks),AttChartUtils.drawYAxisRightTitle(svg,configObj.yAxisRightTitle,void 0,lineDataYScale.factor,width,height,pad,configObj.yRightIsTime),pad[2]+=AttChartUtils.getChartsLegendSize());var yrule=svg.selectAll("g.rule").data(yticks).enter().append("svg:g").attr("class","rule").attr("text-anchor","end").attr("transform",function(d){return"translate(0,"+yscale(d)+")"}),chartWidth=width-pad[2],horizLines=yrule.append("svg:line").attr("x1",pad[0]).attr("x2",chartWidth);configObj.showHorizontalRules&&horizLines.style("stroke",function(){return"#000"}).style("stroke-opacity",function(d){return d?.3:null}),yrule.append("svg:text").attr("x",pad[0]-10).attr("dy",".35em").attr("text-anchor","end").text(function(d){return yLabelFormatter(d)});var xDomainValues=data.map(function(c){return c[configObj.xElement]});if(hasLineData){var xLineDomainValues=d3.values(lineData)[0].map(function(c){return c.x});xDomainValues=_.union(xLineDomainValues,xDomainValues)}var xscale=d3.scale.ordinal().rangeRoundBands([pad[0],chartWidth],1).domain(xDomainValues),rotationInfo=AttChartUtils.getLabelRotationInfo(data,xscale,void 0,configObj.xElement,configObj.selector),rotateLabels=rotationInfo.shouldRotate,xLabelHeight=rotateLabels?rotationInfo.rotatedPixelHeight+10:15;configObj.xAxisTitle&&configObj.xAxisTitle.length>0&&(xLabelHeight+=20),height+=xLabelHeight,height=AttChartUtils.drawXAxisTitle(svg,configObj.xAxisTitle,1,pad[0]+(chartWidth-pad[0])/2,height,yscale(ymin)+xLabelHeight,!1);var labelValues=AttChartUtils.clearExtraLabels(selector,xDomainValues,chartWidth-pad[0]),xfunc=function(x1,x2,dataLength){return 1==dataLength?function(){return x1+(x2-x1)/2}:function(d){return xscale(d)}}(pad[0],chartWidth,labelValues.length);svg.selectAll("g.text").data(labelValues).enter().append("svg:text").attr("text-anchor",rotateLabels?"end":"middle").attr("dx",rotateLabels?"-.28em":"0").attr("dy",rotateLabels?".25em":".71em").attr("xvertex",configObj.bottomLabelFormatter).attr("xvertex-num",function(d,i){return i}).attr("transform",function(d){return"translate("+xfunc(d)+", "+(yscale(ymin)+6)+") rotate("+(rotateLabels?-65:0)+",0,0)"}).attr("selected",0).attr("class","xAxis").style("cursor","pointer").text(function(d){return d}).on("click",function(){var clickedLabel=d3.select(this),xNum=clickedLabel.attr("xvertex-num"),selected=0==clickedLabel.attr("selected")?1:0;if(selected){d3.select(selector).selectAll("circle[xvertex-num='"+xNum+"']").attr("selected",1).attr("pivotSelected",1).attr("opacity",configObj.selectedOpacity);var selectedAdjacents=d3.select(selector).selectAll('circle[selected="1"]'),minNum=xNum,maxNum=xNum;selectedAdjacents[0].length&&(minNum=d3.min(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")}),maxNum=d3.max(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")})),self.clearSelections(configObj,!1),self.clearSelections(configObj,!0);for(var j=parseInt(minNum);j<=parseInt(maxNum);j++)d3.select(selector).selectAll("circle[xvertex-num='"+j+"']").attr("selected",1).attr("pivotSelected",1).attr("opacity",configObj.selectedOpacity),d3.select(selector).selectAll("text[xvertex-num='"+j+"']").attr("selected",1)}else d3.select(selector).selectAll("circle").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity),d3.select(selector).selectAll("text").attr("selected",0);AttChartSelectionService.notifyChartsSelected("attAreaChart; text selection")});var area=d3.svg.area().x(function(d){return xscale(d[configObj.xElement])}).y0(yscale(yticks[0])).y1(function(d){return yscale(d[configObj.yElement]/yfactor)});if(svg.append("path").datum(data).attr("class","area").attr("d",area).style("fill",configObj.areaColor),1==data.length){svg.append("svg:circle").data(data).attr("class",function(){return"single-point"}).attr("selected",0).attr("pivotSelected",0).attr("selector",selector).attr("pivotData",function(d){var pivotPoint={};return configObj.xPivotFilterName&&configObj.xElement&&(pivotPoint[configObj.xPivotFilterName]=d[configObj.xElement]),encodeURIComponent(JSON.stringify(pivotPoint))}).style("fill",configObj.areaColor).style("cursor","pointer").attr("opacity",.8).attr("cx",pad[0]+(width-pad[2]-pad[0])/2).attr("cy",yscale(+data[0][configObj.yElement]/yfactor)).attr("r",4)}var elem=svg.selectAll("g.circle").data(data),bubbles=elem.enter().append("g").attr("transform",function(d){return"translate("+xscale(d[configObj.xElement])+","+yscale(d[configObj.yElement]/yfactor)+")"}),circles=bubbles.append("svg:circle").attr("class","area-bubble").attr("selected",0).attr("pivotSelected",0).attr("selector",selector).attr("xvertex",function(d){return d[configObj.xElement]}).attr("yvertex",function(d){return d[configObj.yElement]}).attr("opacity",configObj.unselectedOpacity).attr("r",4).attr("pivotData",function(d){var pivotPoint={};return configObj.xPivotFilterName&&configObj.xElement&&(pivotPoint[configObj.xPivotFilterName]=d[configObj.xElement]),encodeURIComponent(JSON.stringify(pivotPoint))}).style("fill",configObj.selectedColor).style("cursor","pointer").on("click",function(){var clickedCircle=d3.select(this),xNum=clickedCircle.attr("xvertex-num"),selected=0==clickedCircle.attr("selected")?1:0;if(selected){clickedCircle.attr("selected",1);var selectedAdjacents=d3.select(selector).selectAll('circle.area-bubble[selected="1"]'),minNum=xNum,maxNum=xNum;selectedAdjacents[0].length&&(minNum=d3.min(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")}),maxNum=d3.max(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")})),self.clearSelections(configObj,!1);for(var j=parseInt(minNum);j<=parseInt(maxNum);j++)d3.select(selector).selectAll("circle.area-bubble[xvertex-num='"+j+"']").attr("selected",1).attr("pivotSelected",1).attr("opacity",configObj.selectedOpacity),d3.select(selector).selectAll("text[xvertex-num='"+j+"']").attr("selected",1)}else d3.select(selector).selectAll("circle.area-bubble").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity),d3.select(selector).selectAll("text").attr("selected",0);AttChartSelectionService.notifyChartsSelected("attAreaChart; vertex selection")}).on("mouseover",function(d){d3.select(this).attr("opacity",configObj.selectedOpacity),d.yAxisTitle=configObj.yAxisTitle,d.xAxisTitle=configObj.xAxisTitle,d.category=d3.select(this).attr("category"),d.x=d[configObj.xElement],d.y=d[configObj.yElement],AttChartUtils.getPowertip(this,AttChartUtils.getTooltipLines(d,configObj.tooltipFormatInfo))}).on("mouseout",function(){d3.select(this).attr("opacity",0==d3.select(this).attr("selected")?configObj.unselectedOpacity:configObj.selectedOpacity),AttChartUtils.hideAllPowertips()});hasLineData?(circles.each(function(){var value=d3.select(this).attr("xvertex"),index=labelValues.indexOf(value);index>-1&&d3.select(this).attr("xvertex-num",index)}),self.drawLineData(configObj,svg,lineData,xscale,width,height-xLabelHeight,pad,lineDataEntries,lineDataYScale,lineDataYTicks,lineDataYFormatter,labelValues)):circles.attr("xvertex-num",function(d,i){return i}),d3.select(selector).attr("width",width).attr("height",height),d3.selectAll(selector+" svg").attr("width",width).attr("height",height).style("height",height+"px").style("width",width),d3.selectAll(selector+" svg g").attr("width",width).attr("height",height).style("height",height+"px").style("width",width),AttChartUtils.adjustChartTitle(svg),AttChartUtils.setD3Size(svg,width,height,!0),AttChartUtils.adjustResolutionSelector(element[0].parentElement.id,width,GlobalEvents)},scope.$watchGroup(["data","config","lineData"],function(newVals){return!newVals||newVals.length<1?scope.attAreaChartRender(newVals):scope.attAreaChartRender(newVals[0],newVals.length>1?newVals[1]:void 0,newVals.length>2?newVals[2]:void 0)})},getDefaultConfig:function(){return{id:"att-area-chart",selector:"",title:"",width:"500",height:"300",xAxisTitle:"",yAxisTitle:"",yAxisRightTitle:"",xElement:"label",yElement:"value",padding:[30,30,10,50],showHorizontalRules:!1,yIsInt:!1,yIsTime:!1,yRightIsInt:!1,yRightIsTime:!1,xContiguous:!1,yContiguous:!1,selectAllY:!0,forcedNumberOfLines:0,selectedColor:AttChartUtils.getAttunityChartSelectionColor(),areaColor:AttChartUtils.getAttunityChartUnselectedColor(),trendLineColor:AttChartUtils.getAttunityChartTrendLineColor(),colorScheme:AttChartUtils.getAttunityColorScheme(),selectedOpacity:AttChartUtils.getAttunityChartSelectedOpacity(),unselectedOpacity:AttChartUtils.getAttunityChartUnselectedOpacity(),bottomLabelFormatter:function(x){return x},tooltipFormatInfo:{yValueType:"",yValueDecorator:"",zVerbOrPreposition:"for",xVerbOrPreposition:"in"},tooltipFormatInfoRight:{yValueType:"",yValueDecorator:"",zVerbOrPreposition:"for",xVerbOrPreposition:"in"}}},validateConfig:function(configObj){return configObj?void(configObj.selector=(configObj.selector&&"string"==typeof configObj.selector?configObj.selector:"")+" .attAreaChartContainer"):void console.log("Error reading area chart configuration.")},clearSelections:function(configObj,isLine){d3.select(configObj.selector).selectAll("text").attr("selected",0).attr("pivotSelected",0),d3.select(configObj.selector).selectAll("circle."+(isLine?"line":"area")+"-bubble").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity),d3.select(configObj.selector).selectAll(isLine?"line":"area").attr("selected",0).attr("pivotSelected",0)},hasLineData:function(lineData){return lineData&&!$.isEmptyObject(lineData)},drawLineData:function(configObj,svg,lineData,xscale,width,height,pad,entries,scaleyRight,yTicksRight,yLabelFormatter,xLabelValues){var maxStringLength=AttChartUtils.getChartsMaxTextLength(),colorScheme=AttChartUtils.getAttunityLineOverlayScheme(),singleColor=configObj.trendLineColor,isSingleLine=1===Object.keys(lineData).length,keys=d3.keys(lineData),specialLabel="att-line-chart",self=this,yRuleRight=svg.selectAll("g.ruleRight").data(yTicksRight).enter().append("svg:g").attr("class","ruleRight").attr("transform",function(d){return"translate(0,"+scaleyRight.scale(d)+")"});yRuleRight.append("svg:text").attr("x",width-pad[2]+10).attr("dy",".35em").text(function(d){return yLabelFormatter(d)});{var chartWidth=width-pad[2],theLegendRight=svg.selectAll(".legendRight").data(keys).enter().append("g").attr("class","legendRight").attr("transform",function(d,i){return"translate(0,"+(scaleyRight.scale(scaleyRight.min)+-20*(i+1))+")"});theLegendRight.append("rect").attr("x",chartWidth+50).attr("width",18).attr("height",18).attr("selected",0).attr("category",function(d,i){return keys[i]}).style("fill",function(d,i){return isSingleLine?singleColor:colorScheme[i]}).style("cursor","pointer").on("click",function(){var category=d3.select(this).attr("category"),elements=d3.select(configObj.selector).selectAll("circle.line-bubble[category='"+category+"']");if(elements&&!elements.empty()){var selected=0==elements.attr("selected")?1:0;self.clearSelections(configObj,!0),self.clearSelections(configObj,!1),elements.attr("opacity",1==selected?configObj.selectedOpacity:configObj.unselectedOpacity).attr("selected",selected).attr("pivotSelected",selected)}}).on("mouseout",function(){AttChartUtils.hideAllPowertips()})}theLegendRight.append("text").attr("x",chartWidth+73).attr("y",9).attr("dy",".35em").style("text-anchor","start").text(function(d,i){return Utils.shortenText(keys[i],maxStringLength,!0)}).append("svg:title").text(function(d){return d.length>maxStringLength?d:""});var cause=svg.selectAll("g."+specialLabel+"-attribute").data(entries).enter().append("svg:g").attr("class",function(d,i){return specialLabel+"-attribute "+specialLabel+" "+specialLabel+"-"+keys[i]}),line=d3.svg.line().x(function(d){return xscale(d.x)}).y(function(d){return scaleyRight.scale(d.y/scaleyRight.factor)});cause.append("path").attr("class","line").attr("d",function(d){return line(d.value)}).attr("category",function(d,i){return keys[i]}).attr("stroke-width",2).style("fill","none").style("stroke",function(d,i){return isSingleLine?singleColor:colorScheme[i]}).on("mouseover",function(){AttChartUtils.getPowertip(this,[d3.select(this).attr("category")])}).on("mouseout",function(){AttChartUtils.hideAllPowertips()}),this.selectLineVertices(configObj,svg,entries,scaleyRight,xscale,configObj.tooltipFormatInfoRight,xLabelValues)},selectLineVertices:function(configObj,svg,vertices,scaley,xscale,tooltipFormatInfo,xLabelValues){for(var yyscale=scaley.scale,yyfactor=scaley.factor,self=this,vertexCount=0,i=0;i<vertices.length;i++){var elem=svg.selectAll("g.circle").data(vertices[i].value),bubbles=elem.enter().append("g").attr("transform",function(d){return"translate("+xscale(d.x)+","+yyscale(d.y/yyfactor)+")"}),circles=bubbles.append("svg:circle").attr("class",function(){return"line-bubble "+vertices[i].key}).attr("selected",0).attr("pivotSelected",0).attr("category",vertices[i].key).attr("selector",configObj.selector).attr("selection-id",function(){return"attLineChart-vertex-"+vertexCount++}).attr("xvertex",function(d){return d.x}).attr("yvertex",function(d){return d.y}).attr("opacity",configObj.unselectedOpacity).attr("r",4).style("fill",configObj.selectedColor).style("cursor","pointer").on("mouseover",function(d){d3.select(this).attr("opacity",configObj.selectedOpacity),d.yAxisTitle=configObj.yAxisTitle,d.xAxisTitle=configObj.xAxisTitle,d.category=d3.select(this).attr("category"),AttChartUtils.getPowertip(this,AttChartUtils.getTooltipLines(d,tooltipFormatInfo,"y"))}).on("mouseout",function(){d3.select(this).attr("selected");d3.select(this).attr("opacity",0==d3.select(this).attr("selected")?configObj.unselectedOpacity:configObj.selectedOpacity),AttChartUtils.hideAllPowertips()}).on("click",function(){var clickedCircle=d3.select(this),xNum=clickedCircle.attr("xvertex-num"),selected=0==clickedCircle.attr("selected")?1:0;if(selected){var category=clickedCircle.attr("category");clickedCircle.attr("selected",1);var selectedAdjacents=d3.select(configObj.selector).selectAll('circle.line-bubble[selected="1"][category="'+category+'"]'),minNum=xNum,maxNum=xNum;selectedAdjacents[0].length&&(minNum=d3.min(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")}),maxNum=d3.max(selectedAdjacents[0],function(d){return+d3.select(d).attr("xvertex-num")})),self.clearSelections(configObj,!1);for(var j=parseInt(minNum);j<=parseInt(maxNum);j++)d3.select(configObj.selector).selectAll('circle.line-bubble[xvertex-num="'+j+'"][category="'+category+'"]').attr("selected",1).attr("pivotSelected",1).attr("opacity",configObj.selectedOpacity),d3.select(configObj.selector).selectAll("text[xvertex-num='"+j+"']").attr("selected",1)}else d3.select(configObj.selector).selectAll("circle.line-bubble").attr("selected",0).attr("pivotSelected",0).attr("opacity",configObj.unselectedOpacity),d3.select(configObj.selector).selectAll("text").attr("selected",0);AttChartSelectionService.notifyChartsSelected("attAreaChart; line vertex selection")});circles.each(function(){var value=d3.select(this).attr("xvertex"),index=xLabelValues.indexOf(value);index>-1&&d3.select(this).attr("xvertex-num",index)})}}}}])}(angular);
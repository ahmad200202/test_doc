(function(){var callWithJQuery,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1},slice=[].slice,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},hasProp={}.hasOwnProperty;(callWithJQuery=function(pivotModule){return"object"==typeof exports&&"object"==typeof module?pivotModule(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],pivotModule):pivotModule(jQuery)})(function($){var PivotData,addSeparators,aggregatorTemplates,aggregators,dayNamesEn,derivers,getSort,locales,mthNamesEn,naturalSort,numberFormat,pivotTableRenderer,rd,renderers,rx,rz,sortAs,usFmt,usFmtInt,usFmtPct,zeroPad;return addSeparators=function(nStr,thousandsSep,decimalSep){var rgx,x,x1,x2;for(nStr+="",x=nStr.split("."),x1=x[0],x2=x.length>1?decimalSep+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1"+thousandsSep+"$2");return x1+x2},numberFormat=function(opts){var defaults;return defaults={digitsAfterDecimal:2,scaler:1,thousandsSep:",",decimalSep:".",prefix:"",suffix:""},opts=$.extend({},defaults,opts),function(x){var result;return isNaN(x)||!isFinite(x)?"":(result=addSeparators((opts.scaler*x).toFixed(opts.digitsAfterDecimal),opts.thousandsSep,opts.decimalSep),""+opts.prefix+result+opts.suffix)}},usFmt=numberFormat(),usFmtInt=numberFormat({digitsAfterDecimal:0}),usFmtPct=numberFormat({digitsAfterDecimal:1,scaler:100,suffix:"%"}),aggregatorTemplates={count:function(formatter){return null==formatter&&(formatter=usFmtInt),function(){return function(){return{count:0,push:function(){return this.count++},value:function(){return this.count},format:formatter}}}},uniques:function(fn,formatter){return null==formatter&&(formatter=usFmtInt),function(arg){var attr;return attr=arg[0],function(){return{uniq:[],push:function(record){var ref;return ref=record[attr],indexOf.call(this.uniq,ref)<0?this.uniq.push(record[attr]):void 0},value:function(){return fn(this.uniq)},format:formatter,numInputs:null!=attr?0:1}}}},sum:function(formatter){return null==formatter&&(formatter=usFmt),function(arg){var attr;return attr=arg[0],function(){return{sum:0,push:function(record){return isNaN(parseFloat(record[attr]))?void 0:this.sum+=parseFloat(record[attr])},value:function(){return this.sum},format:formatter,numInputs:null!=attr?0:1}}}},extremes:function(mode,formatter){return null==formatter&&(formatter=usFmt),function(arg){var attr;return attr=arg[0],function(data){return{val:null,sorter:getSort(null!=data?data.sorters:void 0,attr),push:function(record){var ref,ref1,ref2,x;return x=record[attr],("min"===mode||"max"===mode)&&(x=parseFloat(x),isNaN(x)||(this.val=Math[mode](x,null!=(ref=this.val)?ref:x))),"first"===mode&&this.sorter(x,null!=(ref1=this.val)?ref1:x)<=0&&(this.val=x),"last"===mode&&this.sorter(x,null!=(ref2=this.val)?ref2:x)>=0?this.val=x:void 0},value:function(){return this.val},format:function(x){return isNaN(x)?x:formatter(x)},numInputs:null!=attr?0:1}}}},quantile:function(q,formatter){return null==formatter&&(formatter=usFmt),function(arg){var attr;return attr=arg[0],function(){return{vals:[],push:function(record){var x;return x=parseFloat(record[attr]),isNaN(x)?void 0:this.vals.push(x)},value:function(){var i;return 0===this.vals.length?null:(this.vals.sort(function(a,b){return a-b}),i=(this.vals.length-1)*q,(this.vals[Math.floor(i)]+this.vals[Math.ceil(i)])/2)},format:formatter,numInputs:null!=attr?0:1}}}},runningStat:function(mode,ddof,formatter){return null==mode&&(mode="mean"),null==ddof&&(ddof=1),null==formatter&&(formatter=usFmt),function(arg){var attr;return attr=arg[0],function(){return{n:0,m:0,s:0,push:function(record){var m_new,x;return x=parseFloat(record[attr]),isNaN(x)?void 0:(this.n+=1,1===this.n?this.m=x:(m_new=this.m+(x-this.m)/this.n,this.s=this.s+(x-this.m)*(x-m_new),this.m=m_new))},value:function(){if("mean"===mode)return 0===this.n?0/0:this.m;if(this.n<=ddof)return 0;switch(mode){case"var":return this.s/(this.n-ddof);case"stdev":return Math.sqrt(this.s/(this.n-ddof))}},format:formatter,numInputs:null!=attr?0:1}}}},sumOverSum:function(formatter){return null==formatter&&(formatter=usFmt),function(arg){var denom,num;return num=arg[0],denom=arg[1],function(){return{sumNum:0,sumDenom:0,push:function(record){return isNaN(parseFloat(record[num]))||(this.sumNum+=parseFloat(record[num])),isNaN(parseFloat(record[denom]))?void 0:this.sumDenom+=parseFloat(record[denom])},value:function(){return this.sumNum/this.sumDenom},format:formatter,numInputs:null!=num&&null!=denom?0:2}}}},sumOverSumBound80:function(upper,formatter){return null==upper&&(upper=!0),null==formatter&&(formatter=usFmt),function(arg){var denom,num;return num=arg[0],denom=arg[1],function(){return{sumNum:0,sumDenom:0,push:function(record){return isNaN(parseFloat(record[num]))||(this.sumNum+=parseFloat(record[num])),isNaN(parseFloat(record[denom]))?void 0:this.sumDenom+=parseFloat(record[denom])},value:function(){var sign;return sign=upper?1:-1,(.821187207574908/this.sumDenom+this.sumNum/this.sumDenom+1.2815515655446004*sign*Math.sqrt(.410593603787454/(this.sumDenom*this.sumDenom)+this.sumNum*(1-this.sumNum/this.sumDenom)/(this.sumDenom*this.sumDenom)))/(1+1.642374415149816/this.sumDenom)},format:formatter,numInputs:null!=num&&null!=denom?0:2}}}},fractionOf:function(wrapped,type,formatter){return null==type&&(type="total"),null==formatter&&(formatter=usFmtPct),function(){var x;return x=1<=arguments.length?slice.call(arguments,0):[],function(data,rowKey,colKey){return{selector:{total:[[],[]],row:[rowKey,[]],col:[[],colKey]}[type],inner:wrapped.apply(null,x)(data,rowKey,colKey),push:function(record){return this.inner.push(record)},format:formatter,value:function(){return this.inner.value()/data.getAggregator.apply(data,this.selector).inner.value()},numInputs:wrapped.apply(null,x)().numInputs}}}}},aggregatorTemplates.countUnique=function(f){return aggregatorTemplates.uniques(function(x){return x.length},f)},aggregatorTemplates.listUnique=function(s){return aggregatorTemplates.uniques(function(x){return x.sort(naturalSort).join(s)},function(x){return x})},aggregatorTemplates.max=function(f){return aggregatorTemplates.extremes("max",f)},aggregatorTemplates.min=function(f){return aggregatorTemplates.extremes("min",f)},aggregatorTemplates.first=function(f){return aggregatorTemplates.extremes("first",f)},aggregatorTemplates.last=function(f){return aggregatorTemplates.extremes("last",f)},aggregatorTemplates.median=function(f){return aggregatorTemplates.quantile(.5,f)},aggregatorTemplates.average=function(f){return aggregatorTemplates.runningStat("mean",1,f)},aggregatorTemplates["var"]=function(ddof,f){return aggregatorTemplates.runningStat("var",ddof,f)},aggregatorTemplates.stdev=function(ddof,f){return aggregatorTemplates.runningStat("stdev",ddof,f)},aggregators=function(tpl){return{Count:tpl.count(usFmtInt),"Count Unique Values":tpl.countUnique(usFmtInt),"List Unique Values":tpl.listUnique(", "),Sum:tpl.sum(usFmt),"Integer Sum":tpl.sum(usFmtInt),Average:tpl.average(usFmt),Median:tpl.median(usFmt),"Sample Variance":tpl["var"](1,usFmt),"Sample Standard Deviation":tpl.stdev(1,usFmt),Minimum:tpl.min(usFmt),Maximum:tpl.max(usFmt),First:tpl.first(usFmt),Last:tpl.last(usFmt),"Sum over Sum":tpl.sumOverSum(usFmt),"80% Upper Bound":tpl.sumOverSumBound80(!0,usFmt),"80% Lower Bound":tpl.sumOverSumBound80(!1,usFmt),"Sum as Fraction of Total":tpl.fractionOf(tpl.sum(),"total",usFmtPct),"Sum as Fraction of Rows":tpl.fractionOf(tpl.sum(),"row",usFmtPct),"Sum as Fraction of Columns":tpl.fractionOf(tpl.sum(),"col",usFmtPct),"Count as Fraction of Total":tpl.fractionOf(tpl.count(),"total",usFmtPct),"Count as Fraction of Rows":tpl.fractionOf(tpl.count(),"row",usFmtPct),"Count as Fraction of Columns":tpl.fractionOf(tpl.count(),"col",usFmtPct)}}(aggregatorTemplates),renderers={Table:function(data,opts){return pivotTableRenderer(data,opts)},"Table Barchart":function(data,opts){return $(pivotTableRenderer(data,opts)).barchart()},Heatmap:function(data,opts){return $(pivotTableRenderer(data,opts)).heatmap("heatmap",opts)},"Row Heatmap":function(data,opts){return $(pivotTableRenderer(data,opts)).heatmap("rowheatmap",opts)},"Col Heatmap":function(data,opts){return $(pivotTableRenderer(data,opts)).heatmap("colheatmap",opts)}},locales={en:{aggregators:aggregators,renderers:renderers,localeStrings:{renderError:"An error occurred rendering the PivotTable results.",computeError:"An error occurred computing the PivotTable results.",uiRenderError:"An error occurred rendering the PivotTable UI.",selectAll:"Select All",selectNone:"Select None",tooMany:"(too many to list)",filterResults:"Filter values",apply:"Apply",cancel:"Cancel",totals:"Totals",vs:"vs",by:"by"}}},mthNamesEn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNamesEn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],zeroPad=function(number){return("0"+number).substr(-2,2)},derivers={bin:function(col,binWidth){return function(record){return record[col]-record[col]%binWidth}},dateFormat:function(col,formatString,utcOutput,mthNames,dayNames){var utc;return null==utcOutput&&(utcOutput=!1),null==mthNames&&(mthNames=mthNamesEn),null==dayNames&&(dayNames=dayNamesEn),utc=utcOutput?"UTC":"",function(record){var date;return date=new Date(Date.parse(record[col])),isNaN(date)?"":formatString.replace(/%(.)/g,function(m,p){switch(p){case"y":return date["get"+utc+"FullYear"]();case"m":return zeroPad(date["get"+utc+"Month"]()+1);case"n":return mthNames[date["get"+utc+"Month"]()];case"d":return zeroPad(date["get"+utc+"Date"]());case"w":return dayNames[date["get"+utc+"Day"]()];case"x":return date["get"+utc+"Day"]();case"H":return zeroPad(date["get"+utc+"Hours"]());case"M":return zeroPad(date["get"+utc+"Minutes"]());case"S":return zeroPad(date["get"+utc+"Seconds"]());default:return"%"+p}})}}},rx=/(\d+)|(\D+)/g,rd=/\d/,rz=/^0/,naturalSort=function(){return function(as,bs){var a,a1,b,b1,nas,nbs;if(null!=bs&&null==as)return-1;if(null!=as&&null==bs)return 1;if("number"==typeof as&&isNaN(as))return-1;if("number"==typeof bs&&isNaN(bs))return 1;if(nas=+as,nbs=+bs,nbs>nas)return-1;if(nas>nbs)return 1;if("number"==typeof as&&"number"!=typeof bs)return-1;if("number"==typeof bs&&"number"!=typeof as)return 1;if("number"==typeof as&&"number"==typeof bs)return 0;if(isNaN(nbs)&&!isNaN(nas))return-1;if(isNaN(nas)&&!isNaN(nbs))return 1;if(a=String(as),b=String(bs),a===b)return 0;if(!rd.test(a)||!rd.test(b))return a>b?1:-1;for(a=a.match(rx),b=b.match(rx);a.length&&b.length;)if(a1=a.shift(),b1=b.shift(),a1!==b1)return rd.test(a1)&&rd.test(b1)?a1.replace(rz,".0")-b1.replace(rz,".0"):a1>b1?1:-1;return a.length-b.length}}(this),sortAs=function(order){var i,l_mapping,mapping,x;mapping={},l_mapping={};for(i in order)x=order[i],mapping[x]=i,"string"==typeof x&&(l_mapping[x.toLowerCase()]=i);return function(a,b){return null!=mapping[a]&&null!=mapping[b]?mapping[a]-mapping[b]:null!=mapping[a]?-1:null!=mapping[b]?1:null!=l_mapping[a]&&null!=l_mapping[b]?l_mapping[a]-l_mapping[b]:null!=l_mapping[a]?-1:null!=l_mapping[b]?1:naturalSort(a,b)}},getSort=function(sorters,attr){var sort;if(null!=sorters)if($.isFunction(sorters)){if(sort=sorters(attr),$.isFunction(sort))return sort}else if(null!=sorters[attr])return sorters[attr];return naturalSort},PivotData=function(){function PivotData(input,opts){var ref,ref1,ref2,ref3,ref4,ref5,ref6,ref7,ref8,ref9;null==opts&&(opts={}),this.getAggregator=bind(this.getAggregator,this),this.getRowKeys=bind(this.getRowKeys,this),this.getColKeys=bind(this.getColKeys,this),this.sortKeys=bind(this.sortKeys,this),this.arrSort=bind(this.arrSort,this),this.input=input,this.aggregator=null!=(ref=opts.aggregator)?ref:aggregatorTemplates.count()(),this.aggregatorName=null!=(ref1=opts.aggregatorName)?ref1:"Count",this.colAttrs=null!=(ref2=opts.cols)?ref2:[],this.rowAttrs=null!=(ref3=opts.rows)?ref3:[],this.valAttrs=null!=(ref4=opts.vals)?ref4:[],this.sorters=null!=(ref5=opts.sorters)?ref5:{},this.rowOrder=null!=(ref6=opts.rowOrder)?ref6:"key_a_to_z",this.colOrder=null!=(ref7=opts.colOrder)?ref7:"key_a_to_z",this.derivedAttributes=null!=(ref8=opts.derivedAttributes)?ref8:{},this.filter=null!=(ref9=opts.filter)?ref9:function(){return!0},this.tree={},this.rowKeys=[],this.colKeys=[],this.rowTotals={},this.colTotals={},this.allTotal=this.aggregator(this,[],[]),this.sorted=!1,PivotData.forEachRecord(this.input,this.derivedAttributes,function(_this){return function(record){return _this.filter(record)?_this.processRecord(record):void 0}}(this))}return PivotData.forEachRecord=function(input,derivedAttributes,f){var addRecord,compactRecord,i,j,k,l,len1,record,ref,results,results1,tblCols;if(addRecord=$.isEmptyObject(derivedAttributes)?f:function(record){var k,ref,v;for(k in derivedAttributes)v=derivedAttributes[k],record[k]=null!=(ref=v(record))?ref:record[k];return f(record)},$.isFunction(input))return input(addRecord);if($.isArray(input)){if($.isArray(input[0])){results=[];for(i in input)if(hasProp.call(input,i)&&(compactRecord=input[i],i>0)){record={},ref=input[0];for(j in ref)hasProp.call(ref,j)&&(k=ref[j],record[k]=compactRecord[j]);results.push(addRecord(record))}return results}for(results1=[],l=0,len1=input.length;len1>l;l++)record=input[l],results1.push(addRecord(record));return results1}if(input instanceof $)return tblCols=[],$("thead > tr > th",input).each(function(){return tblCols.push($(this).text())}),$("tbody > tr",input).each(function(){return record={},$("td",this).each(function(j){return record[tblCols[j]]=$(this).text()}),addRecord(record)});throw new Error("unknown input format")},PivotData.prototype.forEachMatchingRecord=function(criteria,callback){return PivotData.forEachRecord(this.input,this.derivedAttributes,function(_this){return function(record){var k,ref,v;if(_this.filter(record)){for(k in criteria)if(v=criteria[k],v!==(null!=(ref=record[k])?ref:"null"))return;return callback(record)}}}(this))},PivotData.prototype.arrSort=function(attrs){var a,sortersArr;return sortersArr=function(){var l,len1,results;for(results=[],l=0,len1=attrs.length;len1>l;l++)a=attrs[l],results.push(getSort(this.sorters,a));return results}.call(this),function(a,b){var comparison,i,sorter;for(i in sortersArr)if(hasProp.call(sortersArr,i)&&(sorter=sortersArr[i],comparison=sorter(a[i],b[i]),0!==comparison))return comparison;return 0}},PivotData.prototype.sortKeys=function(){var v;if(!this.sorted){switch(this.sorted=!0,v=function(_this){return function(r,c){return _this.getAggregator(r,c).value()}}(this),this.rowOrder){case"value_a_to_z":this.rowKeys.sort(function(){return function(a,b){return naturalSort(v(a,[]),v(b,[]))}}(this));break;case"value_z_to_a":this.rowKeys.sort(function(){return function(a,b){return-naturalSort(v(a,[]),v(b,[]))}}(this));break;default:this.rowKeys.sort(this.arrSort(this.rowAttrs))}switch(this.colOrder){case"value_a_to_z":return this.colKeys.sort(function(){return function(a,b){return naturalSort(v([],a),v([],b))}}(this));case"value_z_to_a":return this.colKeys.sort(function(){return function(a,b){return-naturalSort(v([],a),v([],b))}}(this));default:return this.colKeys.sort(this.arrSort(this.colAttrs))}}},PivotData.prototype.getColKeys=function(){return this.sortKeys(),this.colKeys},PivotData.prototype.getRowKeys=function(){return this.sortKeys(),this.rowKeys},PivotData.prototype.processRecord=function(record){var colKey,flatColKey,flatRowKey,l,len1,len2,n,ref,ref1,ref2,ref3,rowKey,x;for(colKey=[],rowKey=[],ref=this.colAttrs,l=0,len1=ref.length;len1>l;l++)x=ref[l],colKey.push(null!=(ref1=record[x])?ref1:"null");for(ref2=this.rowAttrs,n=0,len2=ref2.length;len2>n;n++)x=ref2[n],rowKey.push(null!=(ref3=record[x])?ref3:"null");return flatRowKey=rowKey.join(String.fromCharCode(0)),flatColKey=colKey.join(String.fromCharCode(0)),this.allTotal.push(record),0!==rowKey.length&&(this.rowTotals[flatRowKey]||(this.rowKeys.push(rowKey),this.rowTotals[flatRowKey]=this.aggregator(this,rowKey,[])),this.rowTotals[flatRowKey].push(record)),0!==colKey.length&&(this.colTotals[flatColKey]||(this.colKeys.push(colKey),this.colTotals[flatColKey]=this.aggregator(this,[],colKey)),this.colTotals[flatColKey].push(record)),0!==colKey.length&&0!==rowKey.length?(this.tree[flatRowKey]||(this.tree[flatRowKey]={}),this.tree[flatRowKey][flatColKey]||(this.tree[flatRowKey][flatColKey]=this.aggregator(this,rowKey,colKey)),this.tree[flatRowKey][flatColKey].push(record)):void 0},PivotData.prototype.getAggregator=function(rowKey,colKey){var agg,flatColKey,flatRowKey;return flatRowKey=rowKey.join(String.fromCharCode(0)),flatColKey=colKey.join(String.fromCharCode(0)),agg=0===rowKey.length&&0===colKey.length?this.allTotal:0===rowKey.length?this.colTotals[flatColKey]:0===colKey.length?this.rowTotals[flatRowKey]:this.tree[flatRowKey][flatColKey],null!=agg?agg:{value:function(){return null},format:function(){return""}}},PivotData}(),$.pivotUtilities={aggregatorTemplates:aggregatorTemplates,aggregators:aggregators,renderers:renderers,derivers:derivers,locales:locales,naturalSort:naturalSort,numberFormat:numberFormat,sortAs:sortAs,PivotData:PivotData},pivotTableRenderer=function(pivotData,opts){var aggregator,c,colAttrs,colKey,colKeys,defaults,getClickHandler,i,j,r,result,rowAttrs,rowKey,rowKeys,spanSize,tbody,td,th,thead,totalAggregator,tr,txt,val,x;defaults={table:{clickCallback:null,rowTotals:!0,colTotals:!0},localeStrings:{totals:"Totals"}},opts=$.extend(!0,{},defaults,opts),colAttrs=pivotData.colAttrs,rowAttrs=pivotData.rowAttrs,rowKeys=pivotData.getRowKeys(),colKeys=pivotData.getColKeys(),opts.table.clickCallback&&(getClickHandler=function(value,rowValues,colValues){var attr,filters,i;filters={};for(i in colAttrs)hasProp.call(colAttrs,i)&&(attr=colAttrs[i],null!=colValues[i]&&(filters[attr]=colValues[i]));for(i in rowAttrs)hasProp.call(rowAttrs,i)&&(attr=rowAttrs[i],null!=rowValues[i]&&(filters[attr]=rowValues[i]));return function(e){return opts.table.clickCallback(e,value,filters,pivotData)}}),result=document.createElement("table"),result.className="pvtTable",spanSize=function(arr,i,j){var l,len,n,noDraw,ref,ref1,stop,x;if(0!==i){for(noDraw=!0,x=l=0,ref=j;ref>=0?ref>=l:l>=ref;x=ref>=0?++l:--l)arr[i-1][x]!==arr[i][x]&&(noDraw=!1);if(noDraw)return-1}for(len=0;i+len<arr.length;){for(stop=!1,x=n=0,ref1=j;ref1>=0?ref1>=n:n>=ref1;x=ref1>=0?++n:--n)arr[i][x]!==arr[i+len][x]&&(stop=!0);if(stop)break;len++}return len},thead=document.createElement("thead");for(j in colAttrs)if(hasProp.call(colAttrs,j)){c=colAttrs[j],tr=document.createElement("tr"),0===parseInt(j)&&0!==rowAttrs.length&&(th=document.createElement("th"),th.setAttribute("colspan",rowAttrs.length),th.setAttribute("rowspan",colAttrs.length),tr.appendChild(th)),th=document.createElement("th"),th.className="pvtAxisLabel",th.textContent=c,tr.appendChild(th);for(i in colKeys)hasProp.call(colKeys,i)&&(colKey=colKeys[i],x=spanSize(colKeys,parseInt(i),parseInt(j)),-1!==x&&(th=document.createElement("th"),th.className="pvtColLabel",th.textContent=colKey[j],th.setAttribute("colspan",x),parseInt(j)===colAttrs.length-1&&0!==rowAttrs.length&&th.setAttribute("rowspan",2),tr.appendChild(th)));0===parseInt(j)&&opts.table.rowTotals&&(th=document.createElement("th"),th.className="pvtTotalLabel pvtRowTotalLabel",th.innerHTML=opts.localeStrings.totals,th.setAttribute("rowspan",colAttrs.length+(0===rowAttrs.length?0:1)),tr.appendChild(th)),thead.appendChild(tr)}if(0!==rowAttrs.length){tr=document.createElement("tr");for(i in rowAttrs)hasProp.call(rowAttrs,i)&&(r=rowAttrs[i],th=document.createElement("th"),th.className="pvtAxisLabel",th.textContent=r,tr.appendChild(th));th=document.createElement("th"),0===colAttrs.length&&(th.className="pvtTotalLabel pvtRowTotalLabel",th.innerHTML=opts.localeStrings.totals),tr.appendChild(th),thead.appendChild(tr)}result.appendChild(thead),tbody=document.createElement("tbody");for(i in rowKeys)if(hasProp.call(rowKeys,i)){rowKey=rowKeys[i],tr=document.createElement("tr");for(j in rowKey)hasProp.call(rowKey,j)&&(txt=rowKey[j],x=spanSize(rowKeys,parseInt(i),parseInt(j)),-1!==x&&(th=document.createElement("th"),th.className="pvtRowLabel",th.textContent=txt,th.setAttribute("rowspan",x),parseInt(j)===rowAttrs.length-1&&0!==colAttrs.length&&th.setAttribute("colspan",2),tr.appendChild(th)));for(j in colKeys)hasProp.call(colKeys,j)&&(colKey=colKeys[j],aggregator=pivotData.getAggregator(rowKey,colKey),val=aggregator.value(),td=document.createElement("td"),td.className="pvtVal row"+i+" col"+j,td.textContent=aggregator.format(val),td.setAttribute("data-value",val),null!=getClickHandler&&(td.onclick=getClickHandler(val,rowKey,colKey)),tr.appendChild(td));(opts.table.rowTotals||0===colAttrs.length)&&(totalAggregator=pivotData.getAggregator(rowKey,[]),val=totalAggregator.value(),td=document.createElement("td"),td.className="pvtTotal rowTotal",td.textContent=totalAggregator.format(val),td.setAttribute("data-value",val),null!=getClickHandler&&(td.onclick=getClickHandler(val,rowKey,[])),td.setAttribute("data-for","row"+i),tr.appendChild(td)),tbody.appendChild(tr)}if(opts.table.colTotals||0===rowAttrs.length){tr=document.createElement("tr"),(opts.table.colTotals||0===rowAttrs.length)&&(th=document.createElement("th"),th.className="pvtTotalLabel pvtColTotalLabel",th.innerHTML=opts.localeStrings.totals,th.setAttribute("colspan",rowAttrs.length+(0===colAttrs.length?0:1)),tr.appendChild(th));for(j in colKeys)hasProp.call(colKeys,j)&&(colKey=colKeys[j],totalAggregator=pivotData.getAggregator([],colKey),val=totalAggregator.value(),td=document.createElement("td"),td.className="pvtTotal colTotal",td.textContent=totalAggregator.format(val),td.setAttribute("data-value",val),null!=getClickHandler&&(td.onclick=getClickHandler(val,[],colKey)),td.setAttribute("data-for","col"+j),tr.appendChild(td));(opts.table.rowTotals||0===colAttrs.length)&&(totalAggregator=pivotData.getAggregator([],[]),val=totalAggregator.value(),td=document.createElement("td"),td.className="pvtGrandTotal",td.textContent=totalAggregator.format(val),td.setAttribute("data-value",val),null!=getClickHandler&&(td.onclick=getClickHandler(val,[],[])),tr.appendChild(td)),tbody.appendChild(tr)}return result.appendChild(tbody),result.setAttribute("data-numrows",rowKeys.length),result.setAttribute("data-numcols",colKeys.length),result},$.fn.pivot=function(input,inputOpts,locale){var defaults,e,localeDefaults,localeStrings,opts,pivotData,result,x;null==locale&&(locale="en"),null==locales[locale]&&(locale="en"),defaults={cols:[],rows:[],vals:[],rowOrder:"key_a_to_z",colOrder:"key_a_to_z",dataClass:PivotData,filter:function(){return!0},aggregator:aggregatorTemplates.count()(),aggregatorName:"Count",sorters:{},derivedAttributes:{},renderer:pivotTableRenderer},localeStrings=$.extend(!0,{},locales.en.localeStrings,locales[locale].localeStrings),localeDefaults={rendererOptions:{localeStrings:localeStrings},localeStrings:localeStrings},opts=$.extend(!0,{},localeDefaults,$.extend({},defaults,inputOpts)),result=null;try{pivotData=new opts.dataClass(input,opts);try{result=opts.renderer(pivotData,opts.rendererOptions)}catch(error){e=error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),result=$("<span>").html(opts.localeStrings.renderError)}}catch(error){e=error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),result=$("<span>").html(opts.localeStrings.computeError)}for(x=this[0];x.hasChildNodes();)x.removeChild(x.lastChild);return this.append(result)},$.fn.pivotUI=function(input,inputOpts,overwrite,locale){var a,aggregator,attr,attrLength,attrValues,c,colOrderArrow,defaults,e,existingOpts,fn1,i,initialRender,l,len1,len2,len3,localeDefaults,localeStrings,materializedInput,n,o,opts,ordering,pivotTable,recordsProcessed,ref,ref1,ref2,ref3,refresh,refreshDelayed,renderer,rendererControl,rowOrderArrow,shownAttributes,shownInAggregators,shownInDragDrop,tr1,tr2,uiTable,unused,unusedAttrsVerticalAutoCutoff,unusedAttrsVerticalAutoOverride,x;null==overwrite&&(overwrite=!1),null==locale&&(locale="en"),null==locales[locale]&&(locale="en"),defaults={derivedAttributes:{},aggregators:locales[locale].aggregators,renderers:locales[locale].renderers,hiddenAttributes:[],hiddenFromAggregators:[],hiddenFromDragDrop:[],menuLimit:500,cols:[],rows:[],vals:[],rowOrder:"key_a_to_z",colOrder:"key_a_to_z",dataClass:PivotData,exclusions:{},inclusions:{},unusedAttrsVertical:85,autoSortUnusedAttrs:!1,onRefresh:null,showUI:!0,filter:function(){return!0},sorters:{}},localeStrings=$.extend(!0,{},locales.en.localeStrings,locales[locale].localeStrings),localeDefaults={rendererOptions:{localeStrings:localeStrings},localeStrings:localeStrings},existingOpts=this.data("pivotUIOptions"),opts=null==existingOpts||overwrite?$.extend(!0,{},localeDefaults,$.extend({},defaults,inputOpts)):existingOpts;try{attrValues={},materializedInput=[],recordsProcessed=0,PivotData.forEachRecord(input,opts.derivedAttributes,function(record){var attr,base,ref,value;if(opts.filter(record)){materializedInput.push(record);for(attr in record)hasProp.call(record,attr)&&null==attrValues[attr]&&(attrValues[attr]={},recordsProcessed>0&&(attrValues[attr]["null"]=recordsProcessed));for(attr in attrValues)value=null!=(ref=record[attr])?ref:"null",null==(base=attrValues[attr])[value]&&(base[value]=0),attrValues[attr][value]++;return recordsProcessed++}}),uiTable=$("<table>",{"class":"pvtUi"}).attr("cellpadding",5),rendererControl=$("<td>").addClass("pvtUiCell"),renderer=$("<select>").addClass("pvtRenderer").appendTo(rendererControl).bind("change",function(){return refresh()}),ref=opts.renderers;for(x in ref)hasProp.call(ref,x)&&$("<option>").val(x).html(x).appendTo(renderer);if(unused=$("<td>").addClass("pvtAxisContainer pvtUnused pvtUiCell"),shownAttributes=function(){var results;results=[];for(a in attrValues)indexOf.call(opts.hiddenAttributes,a)<0&&results.push(a);return results}(),shownInAggregators=function(){var l,len1,results;for(results=[],l=0,len1=shownAttributes.length;len1>l;l++)c=shownAttributes[l],indexOf.call(opts.hiddenFromAggregators,c)<0&&results.push(c);return results}(),shownInDragDrop=function(){var l,len1,results;for(results=[],l=0,len1=shownAttributes.length;len1>l;l++)c=shownAttributes[l],indexOf.call(opts.hiddenFromDragDrop,c)<0&&results.push(c);return results}(),unusedAttrsVerticalAutoOverride=!1,unusedAttrsVerticalAutoCutoff="auto"===opts.unusedAttrsVertical?120:parseInt(opts.unusedAttrsVertical),!isNaN(unusedAttrsVerticalAutoCutoff)){for(attrLength=0,l=0,len1=shownInDragDrop.length;len1>l;l++)a=shownInDragDrop[l],attrLength+=a.length;unusedAttrsVerticalAutoOverride=attrLength>unusedAttrsVerticalAutoCutoff}unused.addClass(opts.unusedAttrsVertical===!0||unusedAttrsVerticalAutoOverride?"pvtVertList":"pvtHorizList"),fn1=function(attr){var attrElem,checkContainer,closeFilterBox,controls,filterItem,filterItemExcluded,finalButtons,hasExcludedItem,len2,n,placeholder,ref1,sorter,triangleLink,v,value,valueCount,valueList,values;if(values=function(){var results;results=[];for(v in attrValues[attr])results.push(v);return results}(),hasExcludedItem=!1,valueList=$("<div>").addClass("pvtFilterBox").hide(),valueList.append($("<h4>").append($("<span>").text(attr),$("<span>").addClass("count").text("("+values.length+")"))),values.length>opts.menuLimit)valueList.append($("<p>").html(opts.localeStrings.tooMany));else for(values.length>5&&(controls=$("<p>").appendTo(valueList),sorter=getSort(opts.sorters,attr),placeholder=opts.localeStrings.filterResults,$("<input>",{type:"text"}).appendTo(controls).attr({placeholder:placeholder,"class":"pvtSearch"}).bind("keyup",function(){var accept,accept_gen,filter;return filter=$(this).val().toLowerCase().trim(),accept_gen=function(prefix,accepted){return function(v){var real_filter,ref1;return real_filter=filter.substring(prefix.length).trim(),0===real_filter.length?!0:(ref1=Math.sign(sorter(v.toLowerCase(),real_filter)),indexOf.call(accepted,ref1)>=0)}},accept=0===filter.indexOf(">=")?accept_gen(">=",[1,0]):0===filter.indexOf("<=")?accept_gen("<=",[-1,0]):0===filter.indexOf(">")?accept_gen(">",[1]):0===filter.indexOf("<")?accept_gen("<",[-1]):0===filter.indexOf("~")?function(v){return 0===filter.substring(1).trim().length?!0:v.toLowerCase().match(filter.substring(1))}:function(v){return-1!==v.toLowerCase().indexOf(filter)},valueList.find(".pvtCheckContainer p label span.value").each(function(){return accept($(this).text())?$(this).parent().parent().show():$(this).parent().parent().hide()})}),controls.append($("<br>")),$("<button>",{type:"button"}).appendTo(controls).html(opts.localeStrings.selectAll).bind("click",function(){return valueList.find("input:visible:not(:checked)").prop("checked",!0).toggleClass("changed"),!1}),$("<button>",{type:"button"}).appendTo(controls).html(opts.localeStrings.selectNone).bind("click",function(){return valueList.find("input:visible:checked").prop("checked",!1).toggleClass("changed"),!1})),checkContainer=$("<div>").addClass("pvtCheckContainer").appendTo(valueList),ref1=values.sort(getSort(opts.sorters,attr)),n=0,len2=ref1.length;len2>n;n++)value=ref1[n],valueCount=attrValues[attr][value],filterItem=$("<label>"),filterItemExcluded=!1,opts.inclusions[attr]?filterItemExcluded=indexOf.call(opts.inclusions[attr],value)<0:opts.exclusions[attr]&&(filterItemExcluded=indexOf.call(opts.exclusions[attr],value)>=0),hasExcludedItem||(hasExcludedItem=filterItemExcluded),$("<input>").attr("type","checkbox").addClass("pvtFilter").attr("checked",!filterItemExcluded).data("filter",[attr,value]).appendTo(filterItem).bind("change",function(){return $(this).toggleClass("changed")}),filterItem.append($("<span>").addClass("value").text(value)),filterItem.append($("<span>").addClass("count").text("("+valueCount+")")),checkContainer.append($("<p>").append(filterItem));return closeFilterBox=function(){return valueList.find("[type='checkbox']").length>valueList.find("[type='checkbox']:checked").length?attrElem.addClass("pvtFilteredAttribute"):attrElem.removeClass("pvtFilteredAttribute"),valueList.find(".pvtSearch").val(""),valueList.find(".pvtCheckContainer p").show(),valueList.hide()},finalButtons=$("<p>").appendTo(valueList),values.length<=opts.menuLimit&&$("<button>",{type:"button"}).text(opts.localeStrings.apply).appendTo(finalButtons).bind("click",function(){return valueList.find(".changed").removeClass("changed").length&&refresh(),closeFilterBox()}),$("<button>",{type:"button"}).text(opts.localeStrings.cancel).appendTo(finalButtons).bind("click",function(){return valueList.find(".changed:checked").removeClass("changed").prop("checked",!1),valueList.find(".changed:not(:checked)").removeClass("changed").prop("checked",!0),closeFilterBox()}),triangleLink=$("<span>").addClass("pvtTriangle").html(" &#x25BE;").bind("click",function(e){var left,ref2,top;return ref2=$(e.currentTarget).position(),left=ref2.left,top=ref2.top,valueList.css({left:left+10,top:top+10}).show()}),attrElem=$("<li>").addClass("axis_"+i).append($("<span>").addClass("pvtAttr").text(attr).data("attrName",attr).append(triangleLink)),hasExcludedItem&&attrElem.addClass("pvtFilteredAttribute"),unused.append(attrElem).append(valueList)};for(i in shownInDragDrop)hasProp.call(shownInDragDrop,i)&&(attr=shownInDragDrop[i],fn1(attr));tr1=$("<tr>").appendTo(uiTable),aggregator=$("<select>").addClass("pvtAggregator").bind("change",function(){return refresh()}),ref1=opts.aggregators;for(x in ref1)hasProp.call(ref1,x)&&aggregator.append($("<option>").val(x).html(x));for(ordering={key_a_to_z:{rowSymbol:"&varr;",colSymbol:"&harr;",next:"value_a_to_z"},value_a_to_z:{rowSymbol:"&darr;",colSymbol:"&rarr;",next:"value_z_to_a"},value_z_to_a:{rowSymbol:"&uarr;",colSymbol:"&larr;",next:"key_a_to_z"}},rowOrderArrow=$("<a>",{role:"button"}).addClass("pvtRowOrder").data("order",opts.rowOrder).html(ordering[opts.rowOrder].rowSymbol).bind("click",function(){return $(this).data("order",ordering[$(this).data("order")].next),$(this).html(ordering[$(this).data("order")].rowSymbol),refresh()}),colOrderArrow=$("<a>",{role:"button"}).addClass("pvtColOrder").data("order",opts.colOrder).html(ordering[opts.colOrder].colSymbol).bind("click",function(){return $(this).data("order",ordering[$(this).data("order")].next),$(this).html(ordering[$(this).data("order")].colSymbol),refresh()
}),$("<td>").addClass("pvtVals pvtUiCell").appendTo(tr1).append(aggregator).append(rowOrderArrow).append(colOrderArrow).append($("<br>")),$("<td>").addClass("pvtAxisContainer pvtHorizList pvtCols pvtUiCell").appendTo(tr1),tr2=$("<tr>").appendTo(uiTable),tr2.append($("<td>").addClass("pvtAxisContainer pvtRows pvtUiCell").attr("valign","top")),pivotTable=$("<td>").attr("valign","top").addClass("pvtRendererArea").appendTo(tr2),opts.unusedAttrsVertical===!0||unusedAttrsVerticalAutoOverride?(uiTable.find("tr:nth-child(1)").prepend(rendererControl),uiTable.find("tr:nth-child(2)").prepend(unused)):uiTable.prepend($("<tr>").append(rendererControl).append(unused)),this.html(uiTable),ref2=opts.cols,n=0,len2=ref2.length;len2>n;n++)x=ref2[n],this.find(".pvtCols").append(this.find(".axis_"+$.inArray(x,shownInDragDrop)));for(ref3=opts.rows,o=0,len3=ref3.length;len3>o;o++)x=ref3[o],this.find(".pvtRows").append(this.find(".axis_"+$.inArray(x,shownInDragDrop)));null!=opts.aggregatorName&&this.find(".pvtAggregator").val(opts.aggregatorName),null!=opts.rendererName&&this.find(".pvtRenderer").val(opts.rendererName),opts.showUI||this.find(".pvtUiCell").hide(),initialRender=!0,refreshDelayed=function(_this){return function(){var exclusions,inclusions,len4,newDropdown,numInputsToProcess,pivotUIOptions,pvtVals,ref4,ref5,subopts,t,u,unusedAttrsContainer,vals;if(subopts={derivedAttributes:opts.derivedAttributes,localeStrings:opts.localeStrings,rendererOptions:opts.rendererOptions,sorters:opts.sorters,cols:[],rows:[],dataClass:opts.dataClass},numInputsToProcess=null!=(ref4=opts.aggregators[aggregator.val()]([])().numInputs)?ref4:0,vals=[],_this.find(".pvtRows li span.pvtAttr").each(function(){return subopts.rows.push($(this).data("attrName"))}),_this.find(".pvtCols li span.pvtAttr").each(function(){return subopts.cols.push($(this).data("attrName"))}),_this.find(".pvtVals select.pvtAttrDropdown").each(function(){return 0===numInputsToProcess?$(this).remove():(numInputsToProcess--,""!==$(this).val()?vals.push($(this).val()):void 0)}),0!==numInputsToProcess)for(pvtVals=_this.find(".pvtVals"),x=t=0,ref5=numInputsToProcess;ref5>=0?ref5>t:t>ref5;x=ref5>=0?++t:--t){for(newDropdown=$("<select>").addClass("pvtAttrDropdown").append($("<option>")).bind("change",function(){return refresh()}),u=0,len4=shownInAggregators.length;len4>u;u++)attr=shownInAggregators[u],newDropdown.append($("<option>").val(attr).text(attr));pvtVals.append(newDropdown)}return initialRender&&(vals=opts.vals,i=0,_this.find(".pvtVals select.pvtAttrDropdown").each(function(){return $(this).val(vals[i]),i++}),initialRender=!1),subopts.aggregatorName=aggregator.val(),subopts.vals=vals,subopts.aggregator=opts.aggregators[aggregator.val()](vals),subopts.renderer=opts.renderers[renderer.val()],subopts.rowOrder=rowOrderArrow.data("order"),subopts.colOrder=colOrderArrow.data("order"),exclusions={},_this.find("input.pvtFilter").not(":checked").each(function(){var filter;return filter=$(this).data("filter"),null!=exclusions[filter[0]]?exclusions[filter[0]].push(filter[1]):exclusions[filter[0]]=[filter[1]]}),inclusions={},_this.find("input.pvtFilter:checked").each(function(){var filter;return filter=$(this).data("filter"),null!=exclusions[filter[0]]?null!=inclusions[filter[0]]?inclusions[filter[0]].push(filter[1]):inclusions[filter[0]]=[filter[1]]:void 0}),subopts.filter=function(record){var excludedItems,k,ref6,ref7;if(!opts.filter(record))return!1;for(k in exclusions)if(excludedItems=exclusions[k],ref6=""+(null!=(ref7=record[k])?ref7:"null"),indexOf.call(excludedItems,ref6)>=0)return!1;return!0},pivotTable.pivot(materializedInput,subopts),pivotUIOptions=$.extend({},opts,{cols:subopts.cols,rows:subopts.rows,colOrder:subopts.colOrder,rowOrder:subopts.rowOrder,vals:vals,exclusions:exclusions,inclusions:inclusions,inclusionsInfo:inclusions,aggregatorName:aggregator.val(),rendererName:renderer.val()}),_this.data("pivotUIOptions",pivotUIOptions),opts.autoSortUnusedAttrs&&(unusedAttrsContainer=_this.find("td.pvtUnused.pvtAxisContainer"),$(unusedAttrsContainer).children("li").sort(function(a,b){return naturalSort($(a).text(),$(b).text())}).appendTo(unusedAttrsContainer)),pivotTable.css("opacity",1),null!=opts.onRefresh?opts.onRefresh(pivotUIOptions):void 0}}(this),refresh=function(){return function(){return pivotTable.css("opacity",.5),setTimeout(refreshDelayed,10)}}(this),refresh(),this.find(".pvtAxisContainer").sortable({update:function(e,ui){return null==ui.sender?refresh():void 0},connectWith:this.find(".pvtAxisContainer"),items:"li",placeholder:"pvtPlaceholder"})}catch(error){e=error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),this.html(opts.localeStrings.uiRenderError)}return this},$.fn.heatmap=function(scope,opts){var colorScaleGenerator,heatmapper,i,j,l,n,numCols,numRows,ref,ref1,ref2;switch(null==scope&&(scope="heatmap"),numRows=this.data("numrows"),numCols=this.data("numcols"),colorScaleGenerator=null!=opts&&null!=(ref=opts.heatmap)?ref.colorScaleGenerator:void 0,null==colorScaleGenerator&&(colorScaleGenerator=function(values){var max,min;return min=Math.min.apply(Math,values),max=Math.max.apply(Math,values),function(x){var nonRed;return nonRed=255-Math.round(255*(x-min)/(max-min)),"rgb(255,"+nonRed+","+nonRed+")"}}),heatmapper=function(_this){return function(scope){var colorScale,forEachCell,values;return forEachCell=function(f){return _this.find(scope).each(function(){var x;return x=$(this).data("value"),null!=x&&isFinite(x)?f(x,$(this)):void 0})},values=[],forEachCell(function(x){return values.push(x)}),colorScale=colorScaleGenerator(values),forEachCell(function(x,elem){return elem.css("background-color",colorScale(x))})}}(this),scope){case"heatmap":heatmapper(".pvtVal");break;case"rowheatmap":for(i=l=0,ref1=numRows;ref1>=0?ref1>l:l>ref1;i=ref1>=0?++l:--l)heatmapper(".pvtVal.row"+i);break;case"colheatmap":for(j=n=0,ref2=numCols;ref2>=0?ref2>n:n>ref2;j=ref2>=0?++n:--n)heatmapper(".pvtVal.col"+j)}return heatmapper(".pvtTotal.rowTotal"),heatmapper(".pvtTotal.colTotal"),this},$.fn.barchart=function(){var barcharter,i,l,numCols,numRows,ref;for(numRows=this.data("numrows"),numCols=this.data("numcols"),barcharter=function(_this){return function(scope){var forEachCell,max,min,range,scaler,values;return forEachCell=function(f){return _this.find(scope).each(function(){var x;return x=$(this).data("value"),null!=x&&isFinite(x)?f(x,$(this)):void 0})},values=[],forEachCell(function(x){return values.push(x)}),max=Math.max.apply(Math,values),0>max&&(max=0),range=max,min=Math.min.apply(Math,values),0>min&&(range=max-min),scaler=function(x){return 100*x/(1.4*range)},forEachCell(function(x,elem){var bBase,bgColor,text,wrapper;return text=elem.text(),wrapper=$("<div>").css({position:"relative",height:"55px"}),bgColor="gray",bBase=0,0>min&&(bBase=scaler(-min)),0>x&&(bBase+=scaler(x),bgColor="darkred",x=-x),wrapper.append($("<div>").css({position:"absolute",bottom:bBase+"%",left:0,right:0,height:scaler(x)+"%","background-color":bgColor})),wrapper.append($("<div>").text(text).css({position:"relative","padding-left":"5px","padding-right":"5px"})),elem.css({padding:0,"padding-top":"5px","text-align":"center"}).html(wrapper)})}}(this),i=l=0,ref=numRows;ref>=0?ref>l:l>ref;i=ref>=0?++l:--l)barcharter(".pvtVal.row"+i);return barcharter(".pvtTotal.colTotal"),this}})}).call(this);
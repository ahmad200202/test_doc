!function(angular){var attMapping=angular.module(window.AppName+".attMapping",[]);attMapping.factory(composeConsts.Srvcs.MappingDirectiveService,["$filter","$templateCache","locale",function($filter,$templateCache,locale){var MappingDirectiveService={data:{},actions:[],callback_edit_expression:null,callback_edit_lookup:null,callback_change_aggregation_type:null,callback_reset_mappings:null,callback_try_defaults_mappings:null,callback_before_change_mapping:null,callback_before_remove_mapping:null,callback_null_updates:null,mappingTypes:{DIRECT:"DIRECT",EXPRESSION:"EXPRESSION",LOOKUP:"LOOKUP"},try_default_settings:{casesensitive:!1,replace_special_chars:!0,check_data_type:!0},landing_search_prefix:"Landing: ",staging_search_prefix:"Staging: ",INIT:function(data){data&&(MappingDirectiveService.data=data,MappingDirectiveService.callback_edit_expression=data.callback_edit_expression,MappingDirectiveService.callback_edit_lookup=data.callback_edit_lookup,MappingDirectiveService.callback_change_aggregation_type=data.callback_change_aggregation_type,MappingDirectiveService.callback_reset_mappings=data.callback_reset_mappings,MappingDirectiveService.callback_null_updates=data.callback_null_updates,MappingDirectiveService.callback_try_defaults_mappings=data.callback_try_defaults_mappings,MappingDirectiveService.callback_before_change_mapping=data.callback_before_change_mapping,MappingDirectiveService.callback_before_remove_mapping=data.callback_before_remove_mapping,MappingDirectiveService.data.api=MappingDirectiveService.data.api||{},MappingDirectiveService.data.api.handleActionBarButton=MappingDirectiveService.handleActionBarButton,MappingDirectiveService.data.api.isExpressionExits=MappingDirectiveService.isExpressionExits,MappingDirectiveService.data.api.isMappingExists=MappingDirectiveService.isMappingExists,MappingDirectiveService.try_default_settings.check_data_type=!0,null==data.actions&&(data.actions=[]),MappingDirectiveService.AddDefaultActions(data.actions),data.actions=$filter("orderBy")(data.actions,"order")),MappingDirectiveService.attachMappingToStaging()},AddDefaultActions:function(current_actions){current_actions=current_actions||[];var exists=function(id,actions){return actions.filter(function(it){return it.id==id}).length>0};exists("reset",current_actions)||current_actions.push({id:"reset",name:locale.getString("etl.Reset_Dots"),title:locale.getString("etl.Reset_Dots"),show_name:!0,order:5,glyph_class:"att-glyph icon-gl-SQL_Update",css_class:"mappingBtn",action:MappingDirectiveService.onResetMapping,isDisabled:function(){return!MappingDirectiveService.data.allow_drag_drop}}),exists("autoMap",current_actions)||current_actions.push({id:"autoMap",name:locale.getString("etl.AutoMap"),title:locale.getString("etl.AutoMap"),show_name:!0,order:6,glyph_class:"att-glyph icon-gl-default_mapping",css_class:"mappingBtn",action:MappingDirectiveService.onTryDefaults,isDisabled:function(){return!MappingDirectiveService.data.allow_drag_drop}}),exists("changeView",current_actions)||current_actions.push({id:"changeView",name:locale.getString("etl.ChangeView"),title:locale.getString("etl.ChangeView"),show_name:!0,order:7,glyph_class:"att-glyph icon-gl-change_view",css_class:"mappingBtn",action:MappingDirectiveService.onChangeViewType,isDisabled:function(){return!1}})},handleActionBarButton:function(btn_id,disabled){$(".mappingBtn#"+btn_id).attr("disabled",disabled)},getColumnDataTypeDisplayName:function(col_name,col_length,col_scale){return $filter("columnTypeDisplayFilterByProps")(col_name,col_length,col_scale)},onChangeViewType:function(){MappingDirectiveService.data.mapping_view_type=1==MappingDirectiveService.data.mapping_view_type?2:1},onResetMappingCallbackHandlerIntern:function(options){if(0==options.resetMappings&&0==options.resetExpressions&&0==options.resetLookup)return void(MappingDirectiveService.data.api.on_action_bar_loaded&&MappingDirectiveService.data.api.on_action_bar_loaded());if(1==options.resetMappings){var existing_maps_with_expression=[],existing_maps_with_lookup=[];0==options.resetExpressions&&angular.forEach(MappingDirectiveService.data.fields_mapping,function(mapping){null!=mapping.expression&&""!=mapping.expression.expression_statement&&existing_maps_with_expression.push(mapping)}),0==options.resetLookup&&angular.forEach(MappingDirectiveService.data.fields_mapping,function(mapping){null!=mapping.lookup&&mapping.lookup.lookup_expression&&""!=mapping.lookup.lookup_expression.expression_statement&&existing_maps_with_lookup.push(mapping)}),MappingDirectiveService.data.fields_mapping.splice(0,MappingDirectiveService.data.fields_mapping.length),0==options.resetExpressions&&Array.prototype.push.apply(MappingDirectiveService.data.fields_mapping,existing_maps_with_expression),0==options.resetLookup&&Array.prototype.push.apply(MappingDirectiveService.data.fields_mapping,existing_maps_with_lookup)}if(options.resetExpressions){if(0==options.resetMappings){var existing_map_with_expressions=[];angular.forEach(MappingDirectiveService.data.fields_mapping,function(mapping){(null==mapping.expression||""==mapping.expression.expression_statement)&&existing_map_with_expressions.push(mapping)})}MappingDirectiveService.data.fields_mapping.splice(0,MappingDirectiveService.data.fields_mapping.length),0==options.resetMappings&&Array.prototype.push.apply(MappingDirectiveService.data.fields_mapping,existing_map_with_expressions),angular.forEach(MappingDirectiveService.data.target_columns,function(item){item.mapping_data={}})}if(options.resetLookup){if(0==options.resetMappings){var existing_map_with_lookup=[];angular.forEach(MappingDirectiveService.data.fields_mapping,function(mapping){(null==mapping.lookup||null==mapping.lookup.lookup_expression||""==mapping.lookup.lookup_expression.expression_statement)&&existing_map_with_lookup.push(mapping)})}MappingDirectiveService.data.fields_mapping.splice(0,MappingDirectiveService.data.fields_mapping.length),0==options.resetMappings&&Array.prototype.push.apply(MappingDirectiveService.data.fields_mapping,existing_map_with_lookup),angular.forEach(MappingDirectiveService.data.target_columns,function(item){item.mapping_data={}})}MappingDirectiveService.data.api.on_action_bar_loaded&&MappingDirectiveService.data.api.on_action_bar_loaded()},onResetMapping:function(){if(null!=MappingDirectiveService.callback_reset_mappings&&angular.isFunction(MappingDirectiveService.callback_reset_mappings)){var resetOptions={resetMappings:!1,resetFilter:!1,resetExpressions:!1,resetValidationRules:!1,resetCleansingRules:!1,resetFilterDisabled:!1,resetMappingsDisabled:null!=MappingDirectiveService.data.fields_mapping&&0==MappingDirectiveService.data.fields_mapping.length,resetExpressionsDisabled:null!=MappingDirectiveService.data.fields_mapping&&null==ArrayUtils.find(MappingDirectiveService.data.fields_mapping,function(it){return null!=it.expression&&null!=it.expression.expression_statement&&""!=it.expression.expression_statement}),resetValidationRulesDisabled:!1,resetCleansingRulesDisabled:!1,resetLookupDisabled:null!=MappingDirectiveService.data.fields_mapping&&null==ArrayUtils.find(MappingDirectiveService.data.fields_mapping,function(it){return null!=it.lookup&&null!=it.lookup.lookup_expression&&null!=it.lookup.lookup_expression.expression_statement&&""!=it.lookup.lookup_expression.expression_statement})};MappingDirectiveService.callback_reset_mappings(resetOptions,MappingDirectiveService.onResetMappingCallbackHandlerIntern)}},oNullUpdatesMappingCallbackHandlerIntern:function(){},onNullUpdatesMapping:function(){null!=MappingDirectiveService.callback_null_updates&&angular.isFunction(MappingDirectiveService.callback_null_updates)&&MappingDirectiveService.callback_null_updates(MappingDirectiveService.oNullUpdatesMappingCallbackHandlerIntern)},onTryDefaults:function(finishCallback){var options={resetMappings:!1,resetFilter:!1,resetExpressions:!1,resetValidationRules:!1,resetCleansingRules:!1,resetLookup:!1};MappingDirectiveService.onResetMappingCallbackHandlerIntern(options),null!=MappingDirectiveService.callback_try_defaults_mappings&&angular.isFunction(MappingDirectiveService.callback_try_defaults_mappings)&&MappingDirectiveService.callback_try_defaults_mappings(function(res){if(1==res&&null!=MappingDirectiveService.data.target_columns&&null!=MappingDirectiveService.data.source_columns){for(var i=0;i<MappingDirectiveService.data.target_columns.length;i++)for(var k=0;k<MappingDirectiveService.data.source_columns.length;k++){var trgCol=MappingDirectiveService.data.target_columns[i],srcCol=MappingDirectiveService.data.source_columns[k],src_col_name=MappingDirectiveService.try_default_settings.casesensitive?srcCol.name:angular.lowercase(srcCol.name),trg_col_name=MappingDirectiveService.try_default_settings.casesensitive?trgCol.name:angular.lowercase(trgCol.name);src_col_name=MappingDirectiveService.try_default_settings.replace_special_chars?src_col_name.replaceAll("_",""):src_col_name,trg_col_name=MappingDirectiveService.try_default_settings.replace_special_chars?trg_col_name.replaceAll("_",""):trg_col_name;var src_col_type=angular.lowercase(srcCol.data_type),trg_col_type=angular.lowercase(trgCol.data_type),name_match=src_col_name==trg_col_name,type_match=src_col_type==trg_col_type,should_add=!1;if(should_add=name_match?MappingDirectiveService.try_default_settings.check_data_type&&type_match:!1){var expression_obj=null,mapping_type=MappingDirectiveService.mappingTypes.DIRECT;trgCol.mapping_data&&(trgCol.mapping_data.mapping_type==MappingDirectiveService.mappingTypes.EXPRESSION?(expression_obj=trgCol.mapping_data.expression,mapping_type=MappingDirectiveService.mappingTypes.EXPRESSION):trgCol.mapping_data.mapping_type==MappingDirectiveService.mappingTypes.LOOKUP&&(expression_obj=trgCol.mapping_data.lookup,mapping_type=MappingDirectiveService.mappingTypes.LOOKUP)),MappingDirectiveService.addNewMapping(mapping_type,srcCol,trgCol,expression_obj,!1)}}angular.isDefined(finishCallback)&&angular.isFunction(finishCallback)&&finishCallback()}})},onAggregatedMapping:function(){var self=this;null!=MappingDirectiveService.callback_change_aggregation_type&&angular.isFunction(MappingDirectiveService.callback_change_aggregation_type)&&MappingDirectiveService.callback_change_aggregation_type(function(is_aggregated){is_aggregated?$(self).addClass("aggregationBtn"):$(self).removeClass("aggregationBtn"),MappingDirectiveService.data.is_aggregated=is_aggregated})},findItemInMappingFields:function(col_name_intern){var retItem=null;return""==col_name_intern||null==col_name_intern?null:(angular.forEach(MappingDirectiveService.data.fields_mapping,function(item){item.staging_col_name_int==col_name_intern&&(retItem=item)}),retItem)},findItemInSource:function(item_name){if(null==MappingDirectiveService.data||0==MappingDirectiveService.data.source_columns.length)return null;var ret;return angular.forEach(MappingDirectiveService.data.source_columns,function(item){angular.lowercase(item[DO.Column.name])==angular.lowercase(item_name)&&(ret=item)}),ret},findItemInStaging:function(col_name_intern){if(null==MappingDirectiveService.data||0==MappingDirectiveService.data.target_columns.length)return null;var ret;return angular.forEach(MappingDirectiveService.data.target_columns,function(item){angular.lowercase(item[DO.StagingColumn.name_intern])==angular.lowercase(col_name_intern)&&(ret=item)}),ret},editExpressionCallback:function(staging_col){null!=MappingDirectiveService.callback_edit_expression&&angular.isFunction(MappingDirectiveService.callback_edit_expression)&&MappingDirectiveService.callback_edit_expression(staging_col,function(expression_obj){MappingDirectiveService.addNewMapping(MappingDirectiveService.mappingTypes.EXPRESSION,null,staging_col,expression_obj,!1)})},editLookupCallback:function(staging_col){null!=MappingDirectiveService.callback_edit_lookup&&angular.isFunction(MappingDirectiveService.callback_edit_lookup)&&MappingDirectiveService.callback_edit_lookup(staging_col,function(lookup_obj){MappingDirectiveService.addNewMapping(MappingDirectiveService.mappingTypes.LOOKUP,null,staging_col,lookup_obj,!1)})},canEditExpression:function(){return angular.isDefined(MappingDirectiveService.callback_edit_expression)&&angular.isFunction(MappingDirectiveService.callback_edit_expression)},canEditLookup:function(){return angular.isDefined(MappingDirectiveService.callback_edit_lookup)&&angular.isFunction(MappingDirectiveService.callback_edit_lookup)},addNewMappingIntern:function(mapping_type,src,stg,expression_obj){var mapping_item=null;if(stg){switch(mapping_item=MappingDirectiveService.findItemInMappingFields(stg.name_intern),mapping_item&&(MappingDirectiveService.data.fields_mapping.splice(MappingDirectiveService.data.fields_mapping.indexOf(mapping_item),1),mapping_item=null),null==mapping_item&&(mapping_item=angular.copy(DO.MappingField_Defaults),null!=MappingDirectiveService.data.fields_mapping&&MappingDirectiveService.data.fields_mapping.push(mapping_item)),mapping_item.staging_col_name_int=stg.name_intern,mapping_item.mapping_type=mapping_type,mapping_type){case MappingDirectiveService.mappingTypes.DIRECT:src&&(mapping_item.source_col_name=src.name);break;case MappingDirectiveService.mappingTypes.EXPRESSION:null==mapping_item.expression&&(mapping_item.expression={},mapping_item.expression=Utils.mergeValuedObjToDefaultValuedObj(mapping_item.expression,DO.Objects.Expression)),stg.mapping_data&&stg.mapping_data.lookup&&(stg.mapping_data.lookup=null),mapping_item.expression=expression_obj;break;case MappingDirectiveService.mappingTypes.LOOKUP:null==mapping_item.lookup&&(mapping_item.lookup={},mapping_item.lookup=Utils.mergeValuedObjToDefaultValuedObj(mapping_item.lookup,DO.Objects.LookupField)),stg.mapping_data&&stg.mapping_data.expression&&(stg.mapping_data.expression=null),mapping_item.lookup=expression_obj}MappingDirectiveService.attachMappingToStaging(),null!=MappingDirectiveService.data.api&&MappingDirectiveService.data.api.on_action_bar_loaded&&MappingDirectiveService.data.api.on_action_bar_loaded()}},confirmAddMapping:function(stg){var modalPromise=null;return null!=MappingDirectiveService.callback_before_change_mapping&&angular.isFunction(MappingDirectiveService.callback_before_change_mapping)?(modalPromise=MappingDirectiveService.callback_before_change_mapping(stg))?modalPromise:void 0:!0},confirmRemoveMapping:function(stg){var modalPromise=null;return null!=MappingDirectiveService.callback_before_remove_mapping&&angular.isFunction(MappingDirectiveService.callback_before_remove_mapping)?(modalPromise=MappingDirectiveService.callback_before_remove_mapping(stg))?modalPromise:void 0:!0},addNewMapping:function(mapping_type,src,stg,expression_obj,show_confirm){show_confirm?MappingDirectiveService.confirmAddMapping(stg).then(function(){MappingDirectiveService.addNewMappingIntern(mapping_type,src,stg,expression_obj)}):MappingDirectiveService.addNewMappingIntern(mapping_type,src,stg,expression_obj)},removeMapping:function(col_name_intern){var removed=!1,to_remove=MappingDirectiveService.findItemInMappingFields(col_name_intern);if(to_remove){var lowerCaseNames=MappingDirectiveService.data.fields_mapping.map(function(value){return value.staging_col_name_int.toLowerCase()}),idx=lowerCaseNames.indexOf(angular.lowercase(col_name_intern));-1!=idx&&MappingDirectiveService.data.fields_mapping.splice(idx,1)}return MappingDirectiveService.data.api.on_action_bar_loaded(),removed},removeExpression:function(col_name_intern,type){var removed=!1,to_remove=MappingDirectiveService.findItemInMappingFields(col_name_intern);if(to_remove){var lowerCaseNames=MappingDirectiveService.data.fields_mapping.map(function(value){return value.staging_col_name_int.toLowerCase()}),idx=lowerCaseNames.indexOf(angular.lowercase(col_name_intern));if(-1!=idx){var stg=MappingDirectiveService.findItemInStaging(col_name_intern);stg&&MappingDirectiveService.confirmRemoveMapping(stg).then(function(){var field=MappingDirectiveService.data.fields_mapping[idx];stg&&(stg.mapping_data={}),field&&(removed=!0,type==MappingDirectiveService.mappingTypes.EXPRESSION&&(field.expression=null),type==MappingDirectiveService.mappingTypes.LOOKUP&&(field.lookup=null),-1!=idx&&MappingDirectiveService.data.fields_mapping.splice(idx,1)),MappingDirectiveService.data.api.on_action_bar_loaded()})}}return removed},getDragMessage:function(src,stg){if(null!=src&&src.hasOwnProperty("name")&&null!=stg&&stg.hasOwnProperty("data_type")){var src_data_type=src.data_type,stg_data_type=stg.data_type;return MappingDirectiveService.try_default_settings.check_data_type?angular.lowercase(src_data_type)==angular.lowercase(stg_data_type)?{message:"",color:"green"}:{message:"Data types mismatch.",color:"red"}:{message:"",color:"silver"}}return{message:"Drag to a staging column.",color:"silver"}},attachMappingToStaging:function(){angular.forEach(MappingDirectiveService.data.target_columns,function(item){item.mapping_data=MappingDirectiveService.findItemInMappingFields(item.name_intern)||{}})},getExpressionFormStagingCol:function(staging_col){return staging_col&&staging_col.mapping_data&&staging_col.mapping_data.expression&&MappingDirectiveService.checkStagingColHasExpressionInMappingFields(staging_col)&&staging_col.mapping_data?staging_col.mapping_data.expression.expression_statement:null},getLookExpressionFormStagingCol:function(staging_col){return staging_col&&staging_col.mapping_data&&staging_col.mapping_data.lookup&&MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(staging_col)&&staging_col.mapping_data?staging_col.mapping_data.lookup.lookup_expression.expression_statement:null},checkStagingColHasExpression:function(staging_col){return null!=staging_col&&null!=staging_col.mapping_data&&null!=staging_col.mapping_data.expression&&""!=staging_col.mapping_data.expression.expression_statement},checkStagingColHasExpressionInMappingFields:function(staging_col){if(null==staging_col)return!1;var map_item=MappingDirectiveService.findItemInMappingFields(staging_col.name_intern);return map_item&&null!=map_item.expression&&""!=map_item.expression.expression_statement},checkStagingColHasLookupExpressionInMappingFields:function(staging_col){if(null==staging_col)return!1;var map_item=MappingDirectiveService.findItemInMappingFields(staging_col.name_intern);return map_item&&null!=map_item.lookup&&null!=map_item.lookup.lookup_expression&&""!=map_item.lookup.lookup_expression.expression_statement},getLookupAliasParameterNameClean:function(alias_parameter){var landing_prefix=String.format(composeConsts.LookupInternalTableTypes.STRING_FORMAT,composeConsts.LookupInternalTableTypes.LANDING,"");return alias_parameter.indexOf("$")>-1&&-1!=alias_parameter.indexOf(landing_prefix.trim())?alias_parameter.replace(landing_prefix.trim(),"").trim():alias_parameter},isAggregated:function(){return MappingDirectiveService.data.is_aggregated},isMappingExists:function(){return null!=MappingDirectiveService.data.fields_mapping&&MappingDirectiveService.data.fields_mapping.length>0},isExpressionExits:function(){return null!=MappingDirectiveService.data.fields_mapping&&MappingDirectiveService.data.fields_mapping.filter(function(field){return null!=field&&null!=field.expression&&""!=field.expression.expression_statement.trim()}).length>0},getMappingTypeDisplayName:function(type){var ret="";switch(type){case MappingDirectiveService.mappingTypes.DIRECT:ret="Link";break;case MappingDirectiveService.mappingTypes.EXPRESSION:ret="Expression";break;case MappingDirectiveService.mappingTypes.LOOKUP:ret="Lookup"}return ret}};return MappingDirectiveService}]),attMapping.directive("mappingTableDirective",["$compile","$rootScope","$http","$q","$templateCache","mappingDirectiveService",function($compile,$rootScope,$http,$q,$templateCache,MappingDirectiveService){return{restrict:"E",scope:{data:"=","class":"@",id:"@"},replace:!0,templateUrl:"views/directives/mappingDirectiveTableTemplate.html",link:function(scope,element){function BUILD_TABLE_DATA(){null==scope.tableScope&&(scope.tableScope=$rootScope.$new(),scope.tableScope.getColumnType=function(data_type,length,scale){return MappingDirectiveService.getColumnDataTypeDisplayName(data_type,length,scale)},scope.tableScope.onRemoveColumn=function(rowData){rowData&&rowData.mapping_data&&(MappingDirectiveService.removeMapping(rowData.name_intern),BUILD_TABLE_DATA())}),scope.tableScope.target_entity_name=MappingDirectiveService.data.target_entity_name,scope.tableScope.table_data=[],null==scope.tableScope.tableApi&&(scope.tableScope.tableApi={}),scope.isInExpressionParams=function(col){if(null==scope.tableScope||null==scope.tableScope.tableApi||null==scope.tableScope.tableApi.getSelection||0==scope.tableScope.tableApi.getSelection().length)return!1;var expression=null,expressionObj=null,selection=scope.tableScope.tableApi.getSelection()[0],hasExpression=MappingDirectiveService.checkStagingColHasExpressionInMappingFields(selection),hasLookup=MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(selection);hasExpression?(expression=MappingDirectiveService.getExpressionFormStagingCol(selection),expressionObj=selection.mapping_data.expression):hasLookup&&(expression=MappingDirectiveService.getLookExpressionFormStagingCol(selection),expressionObj=selection.mapping_data.lookup.lookup_expression);var sourceItemData=MappingDirectiveService.findItemInSource(col.name);return expression&&expressionObj?null!=sourceItemData&&null!=ArrayUtils.find(expressionObj.alias,function(it){return MappingDirectiveService.getLookupAliasParameterNameClean(it.alias_parameter)==sourceItemData.name}):col.name==selection.name},scope.tableScope.allow_drag_drop=MappingDirectiveService.data.allow_drag_drop;var table_data=[];table_data=angular.copy(scope.data.target_columns),MappingDirectiveService.attachMappingToStaging(),scope.tableScope.table_data.splice(0,scope.tableScope.table_data.length),Array.prototype.push.apply(scope.tableScope.table_data,table_data)}scope.$on("$destroy",function(){ArrayUtils.emptyArray(scope.actionBarActions)}),scope.tableScope=null,MappingDirectiveService.INIT(scope.data),scope.isDlProject=$rootScope.isDlProject,scope.actionBarActions=angular.copy(scope.data.actions),$http.get("../views/directives/mappingTableViewTemplate.html").then(function(resp){var html=resp.data;BUILD_TABLE_DATA(),scope.tableScope.can_edit_expression=MappingDirectiveService.canEditExpression(),scope.tableScope.can_edit_lookup=MappingDirectiveService.canEditLookup(),scope.tableScope.onDropItem=function(event){element.find(".mappingTableListContainer").attr("style","overflow-x:auto;");var rowData=angular.element(event.target).scope().$parent.rowData;rowData.isOverCell=!0;var src=MappingDirectiveService.findItemInSource(rowData.mapping_data);MappingDirectiveService.addNewMapping(MappingDirectiveService.mappingTypes.DIRECT,src,rowData,null,!1)},scope.tableScope.onBeforeDropItem=function(){var deferred=$q.defer(),has_exp=MappingDirectiveService.checkStagingColHasExpressionInMappingFields(this.rowData),has_lookup=MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(this.rowData);if(has_exp||has_lookup){var promise=MappingDirectiveService.confirmAddMapping(this.rowData);promise.then(function(){deferred.resolve()},function(){deferred.reject()})}else deferred.resolve();return deferred.promise},scope.tableScope.onOverItem=function(event,ui){var rowData=angular.element(event.target).scope().$parent.rowData;rowData.isOverCell=!0,null==scope.drag_info&&(scope.drag_info={}),scope.drag_info.message="",scope.drag_info.color="",scope.tableScope.$apply();var dragMsg=MappingDirectiveService.getDragMessage(ui.helper.data().$scope.col,this.rowData);scope.drag_info.message=dragMsg.message,scope.drag_info.color=dragMsg.color},scope.tableScope.onOutItem=function(event){var rowData=angular.element(event.target).scope().$parent.rowData;rowData.isOverCell=!1,scope.drag_info.message="",scope.drag_info.color=""},scope.tableScope.onEditExpression=function(rowData){MappingDirectiveService.editExpressionCallback(rowData)},scope.tableScope.onEditLookup=function(rowData){MappingDirectiveService.editLookupCallback(rowData)},scope.tableScope.getDisplayText=function(rowData){if(null!=rowData.mapping_data){if(rowData.mapping_data.mapping_type==MappingDirectiveService.mappingTypes.DIRECT)return rowData.mapping_data.source_col_name;if(rowData.mapping_data.mapping_type==MappingDirectiveService.mappingTypes.EXPRESSION)return MappingDirectiveService.getExpressionFormStagingCol(rowData);if(rowData.mapping_data.mapping_type==MappingDirectiveService.mappingTypes.LOOKUP)return MappingDirectiveService.getLookExpressionFormStagingCol(rowData)}},scope.tableScope.getExpressionExistsOrLookupExists=function(rowData){return null!=rowData.mapping_data&&rowData.mapping_data.mapping_type},scope.onDragItem=function(){element.find(".mappingTableListContainer").attr("style","")},scope.onDragStop=function(){element.find(".mappingTableListContainer").attr("style","overflow-x:auto;"),null==scope.drag_info&&(scope.drag_info={}),scope.drag_info.message="",scope.drag_info.color=""},scope.getColumnType=function(col_type_name,col_type_size,col_scale){return MappingDirectiveService.getColumnDataTypeDisplayName(col_type_name,col_type_size,col_scale)};var newElement=$compile(html)(scope.tableScope),tablePlaceHolder=element.find(".tablePlaceHolder");tablePlaceHolder.append(newElement[0])}),scope.$watch("data.source_columns",BUILD_TABLE_DATA,!0),scope.$watch("data.target_columns",BUILD_TABLE_DATA,!0),scope.$watch("data.fields_mapping",BUILD_TABLE_DATA,!0)}}}]),attMapping.directive("mappingDiagramDirective",["mappingDirectiveService","$templateCache","locale",function(MappingDirectiveService){return{restrict:"E",scope:{data:"=","class":"@",id:"@"},replace:!0,templateUrl:"views/directives/mappingDirectiveDiagramTemplate.html",link:function(scope,element){function build_search_data(){ArrayUtils.emptyArray(scope.search_array),angular.forEach(scope.data.source_columns,function(it){scope.search_array.push(MappingDirectiveService.landing_search_prefix+it.name)}),angular.forEach(scope.data.target_columns,function(it){scope.search_array.push(MappingDirectiveService.staging_search_prefix+it.name)})}function onSearch(){null!=scope.svg&&scope.svg.selectAll("rect").each(""==scope.search_text?function(){d3.select(this).attr("stroke","lightgray")}:function(d){angular.lowercase(d.name).indexOf(angular.lowercase(scope.search_text))>-1?d3.select(this).attr("stroke","rgba(52, 182, 228 , 1)"):d3.select(this).attr("stroke","lightgray")})}function getPathClassName(d){var ret=scope.settings.linkClassName;return d.source.link_type==MappingDirectiveService.mappingTypes.DIRECT?ret+" "+scope.settings.linkMapClassName+(scope.data.allow_drag_drop?"":" disabled"):ret+" "+d.target.link_name+" "+scope.settings.linkExpressionClassName+(scope.data.allow_drag_drop?"":" disabled")}function onMouseOverPath(d){var exp_params=null;if(d.source.link_type==MappingDirectiveService.mappingTypes.EXPRESSION?exp_params=d.target.data.mapping_data.expression:d.source.link_type==MappingDirectiveService.mappingTypes.LOOKUP&&(exp_params=d.target.data.mapping_data.lookup.lookup_expression),exp_params){scope.svg.selectAll("."+scope.settings.mapItem).attr("filter","url(#blur)"),scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).attr("filter","url(#blur)"),scope.linksGroup.selectAll("."+scope.settings.linkClassName).attr("filter","url(#blur)"),scope.linksGroup.selectAll("."+scope.settings.linkClassName).classed("hovered1",!0),scope.linksGroup.selectAll("."+scope.settings.linkClassName+"."+d.target.link_name).attr("filter",null),angular.forEach(exp_params.alias,function(exp){var alias_name=MappingDirectiveService.getLookupAliasParameterNameClean(exp.alias_parameter),sourceMapItem=scope.sourceMapping.select("#"+scope.settings.sourceMappingItemIdName+alias_name);sourceMapItem&&(sourceMapItem.attr("filter",null),sourceMapItem.select("rect").classed("hovered1",!0))});var targetMapItem=scope.stagingMapping.select("#"+scope.settings.stagingMappingItemIdName+d.target.data.name);targetMapItem&&(targetMapItem.attr("filter",null),targetMapItem.select("rect").classed("hovered1",!0))}}function onMouseLeavePath(d){var exp_params=null;(d.source.link_type==MappingDirectiveService.mappingTypes.EXPRESSION||d.source.link_type==MappingDirectiveService.mappingTypes.LOOKUP)&&(scope.linksGroup.selectAll("."+scope.settings.linkClassName).attr("filter",null),scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).attr("filter",null),scope.linksGroup.selectAll("."+scope.settings.linkClassName).classed("hovered1",!1),d.source.link_type==MappingDirectiveService.mappingTypes.EXPRESSION?exp_params=d.target.data.mapping_data.expression:d.source.link_type==MappingDirectiveService.mappingTypes.LOOKUP&&(exp_params=d.target.data.mapping_data.lookup.lookup_expression),exp_params&&(scope.svg.selectAll("."+scope.settings.mapItem).attr("filter",null),angular.forEach(exp_params.alias,function(exp){var alias_name=MappingDirectiveService.getLookupAliasParameterNameClean(exp.alias_parameter);alias_name&&scope.sourceMapping.select("#"+scope.settings.sourceMappingItemIdName+alias_name).select("rect").classed("hovered1",!1)}),scope.stagingMapping.select("#"+scope.settings.stagingMappingItemIdName+d.target.data.name).select("rect").classed("hovered1",!1)))}function onMouseOver(d){d.isSource&&d3.select("#"+scope.settings.stagingMappingItemIdName+d.name).select("rect").classed("hovered",!0),d.isStaging&&d3.select("#"+scope.settings.sourceMappingItemIdName+d.name).select("rect").classed("hovered",!0)}function onMouseLeave(d){d.isSource&&d3.select("#"+scope.settings.stagingMappingItemIdName+d.name).select("rect").classed("hovered",!1),d.isStaging&&d3.select("#"+scope.settings.sourceMappingItemIdName+d.name).select("rect").classed("hovered",!1)}function onItemClick(theSvgEl,d){removeAllSelection(d.isSource),d3.select(theSvgEl).classed("selected",!d3.select(theSvgEl).classed("selected"));var selected_source=getSelectedItem(!0),selected_target=getSelectedItem(!1);if(null!=selected_source&&null!=selected_target){var has_exp=MappingDirectiveService.checkStagingColHasExpressionInMappingFields(selected_target),has_lookup=MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(selected_target);MappingDirectiveService.addNewMapping(MappingDirectiveService.mappingTypes.DIRECT,selected_source,selected_target,null,has_exp||has_lookup),removeAllSelection(!0),removeAllSelection(!1)}}function addExpressionBuilderIndication(theSvgEl,d){if(MappingDirectiveService.canEditExpression()){var expression_img=null;expression_img=d3.select(theSvgEl).select("."+scope.settings.editExpressionClass),null==expression_img.node()&&(expression_img=d3.select(theSvgEl).append("image").attr("xlink:href","shared/images/expression_builder.svg").attr("class",scope.settings.editExpressionClass).attr("x",scope.settings.rectWidth-25).attr("y",3).attr("width",scope.settings.rectHeight-10).attr("height",scope.settings.rectHeight-10));var expression_title=expression_img.select("."+scope.settings.editExpressionTitleClass);null==expression_title.node()&&(expression_title=expression_img.append("title").attr("class",scope.settings.editExpressionTitleClass));var exp=MappingDirectiveService.getExpressionFormStagingCol(d),exp_title=null!=exp&&""!=exp?exp:"Create Expression";expression_img.classed("exists",null!=exp&&""!=exp),expression_title.text(exp_title),expression_img.on("click",function(d){MappingDirectiveService.editExpressionCallback(d)})}}function addLookupIndication(theSvgEl,d){if(MappingDirectiveService.canEditLookup()){var lookup_img=null;lookup_img=d3.select(theSvgEl).select("."+scope.settings.editLookupClass),null==lookup_img.node()&&(lookup_img=d3.select(theSvgEl).append("image").attr("xlink:href","shared/images/lookup.svg").attr("class",scope.settings.editLookupClass).attr("x",scope.settings.rectWidth-50).attr("y",3).attr("width",scope.settings.rectHeight-12).attr("height",scope.settings.rectHeight-12));
var lookup_title=lookup_img.select("."+scope.settings.editLookupTitleClass);null==lookup_title.node()&&(lookup_title=lookup_img.append("title").attr("class",scope.settings.editLookupTitleClass));var lookup=MappingDirectiveService.getLookExpressionFormStagingCol(d),look_title=null!=lookup&&""!=lookup?lookup:"Create Lookup";lookup_img.classed("exists",null!=lookup&&""!=lookup),lookup_title.text(look_title),lookup_img.on("click",function(d){MappingDirectiveService.editLookupCallback(d)})}}function addAggregationIndication(theSvgEl){var editAggregation_img=null;editAggregation_img=d3.select(theSvgEl).select("."+scope.settings.editAggregationClass),MappingDirectiveService.isAggregated()?(null==editAggregation_img.node()&&(editAggregation_img=d3.select(theSvgEl).append("image").attr("xlink:href","../images/common/arrows/down_arrow.svg").attr("class",scope.settings.editAggregationClass).attr("x",scope.settings.rectWidth/2).attr("y",3).attr("width",scope.settings.rectHeight-10).attr("height",scope.settings.rectHeight-10).attr("title","Click to edit expression")),editAggregation_img.on("click",function(){})):editAggregation_img&&editAggregation_img.remove()}function addColumnTypeTooltip(){}function addNodeToolTip(nodeEl,text){if(null!=nodeEl&&""!=text&&Utils.shortenText(text,scope.settings.max_text_length,!0).length>scope.settings.max_text_length){var node_tooltip=d3.select(nodeEl).select(scope.settings.colNameToolTipClass);null==node_tooltip.node()&&d3.select(nodeEl).append("title").text(text)}}function onChangeAggregate(){d3.selectAll("."+scope.settings.mapItem+"."+scope.settings.targetMap).each(function(d){addAggregationIndication(this,d)})}function addItem(theSvgEl,d,scope,isSourceNode){var portClass=(isSourceNode?scope.settings.rectWidth:0,"port "+(isSourceNode?"outPort":"inPort"));d3.select(theSvgEl).append("rect").attr("stroke","lightgray").attr("fill","transparent").attr("width",scope.settings.rectWidth).attr("height",scope.settings.rectHeight-1).on("click",function(d,i){scope.data.allow_drag_drop&&onItemClick(this,d,i)}).on("mouseover",onMouseOver).on("mouseout",onMouseLeave);var node_text=d3.select(theSvgEl).append("text").attr("x",20).attr("y",scope.settings.rectHeight/3).attr("dy",".35em").attr("class",scope.settings.colNameClass).text(function(d){var name=Utils.shortenText(isSourceNode?d[DO.Column.name]:d[DO.StagingColumn.name],scope.settings.max_text_length,!0);return name}).on("click",function(d,i){null!=this.parentNode&&onItemClick(d3.select(this.parentNode).select("rect").node(),d,i)});if(addNodeToolTip(node_text.node(),isSourceNode?d[DO.Column.name]:d[DO.StagingColumn.name]),d3.select(theSvgEl).append("text").attr("x",20).attr("y",scope.settings.rectHeight/1.5+3).attr("dy",".35em").attr("class",scope.settings.colNameTypeClass).attr("fill","#808080").attr("font-size","10px").text(function(d){return getColumnType(d,isSourceNode)}),0==isSourceNode&&1==d[DO.StagingColumn.is_primary]&&d3.select(theSvgEl).append("image").attr("xlink:href","../shared/images/primary_key.png").attr("x",0).attr("y",3).attr("width",20).attr("height",20),0==isSourceNode&&(addExpressionBuilderIndication(theSvgEl,d),addLookupIndication(theSvgEl,d)),addColumnTypeTooltip(theSvgEl,d,scope,isSourceNode),isSourceNode&&scope.data.allow_drag_drop){var circleGrabber=(d3.select(theSvgEl).append("image").attr("class",portClass).attr("xlink:href","../images/default_port.svg").attr("x",isSourceNode?scope.settings.rectWidth+scope.settings.portMargin:0).attr("y",scope.settings.portSize/2+scope.settings.portMargin).attr("width",scope.settings.portSize).attr("height",scope.settings.portSize).style("visibility","hidden"),d3.select(theSvgEl).append("circle").attr("fill","transparent").attr("cursor","pointer").attr("stroke","transparent").attr("r","15").attr("class",scope.settings.draggerClass).attr("cx",scope.settings.rectWidth).attr("cy",scope.settings.portSize/2));circleGrabber.call(scope.drag)}}function dragstart(dragged,scope){var line=scope.svg.select(".temp.line");line.node()&&line.style("visibility","visible")}function dragmove(dragged,scope){onDragging(!0);var stagingMouse=d3.mouse(scope.svg.node()),dragItemData=d3.select(dragged).data()[0],sourcePos={x:dragItemData.x,y:dragItemData.y},stagingPos={x:stagingMouse[0],y:stagingMouse[1]},dragMsg=null;if(d3.event&&d3.event.sourceEvent&&d3.event.sourceEvent.toElement){var stagingItemData=d3.select(d3.event.sourceEvent.toElement).data()[0];dragMsg=MappingDirectiveService.getDragMessage(dragItemData,stagingItemData)}else dragMsg=MappingDirectiveService.getDragMessage(null,null);scope.svg.select(".temp.line").attr("stroke",scope.drag_info.color),scope.drag_info.message=dragMsg.message,scope.drag_info.color=dragMsg.color;var line=scope.svg.select(".temp.line");line.node()&&line.attr("d",scope.diagonal({source:sourcePos,target:stagingPos}))}function dragEnd(dragged,scope){scope.drag_info.color="silver",scope.drag_info.message="",onDragging(!1);var line=scope.svg.select(".temp.line"),dragItemData=d3.select(dragged).data()[0],dropItemData=d3.select(d3.event.sourceEvent.target).data()[0];if(dragItemData&&dropItemData&&dropItemData[DO.StagingColumn.name]){var has_exp=MappingDirectiveService.checkStagingColHasExpressionInMappingFields(dropItemData),has_lookup=MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(dropItemData);MappingDirectiveService.addNewMapping(MappingDirectiveService.mappingTypes.DIRECT,dragItemData,dropItemData,null,has_exp||has_lookup)}line.style("visibility","hidden"),line.attr("d",null)}function BUILD_LINKS_DATA(){scope.Links.splice(0,scope.Links.length);var temp_links=[];angular.forEach(scope.data.fields_mapping,function(item){var sourceItemData=MappingDirectiveService.findItemInSource(item.source_col_name),targetItemData=MappingDirectiveService.findItemInStaging(item.staging_col_name_int),hasExpression=MappingDirectiveService.checkStagingColHasExpressionInMappingFields(targetItemData),hasLookup=MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(targetItemData);sourceItemData&&targetItemData&&!hasExpression&&!hasLookup&&temp_links.push({source:{link_name:item.staging_col_name_int,link_type:MappingDirectiveService.mappingTypes.DIRECT,data:sourceItemData},target:{link_name:targetItemData.name_intern,link_type:MappingDirectiveService.mappingTypes.DIRECT,data:targetItemData}})}),angular.forEach(MappingDirectiveService.data.target_columns,function(trgCol){var expression=null,link_type=MappingDirectiveService.mappingTypes.DIRECT;if(MappingDirectiveService.checkStagingColHasExpressionInMappingFields(trgCol)?(expression=trgCol.mapping_data.expression,link_type=MappingDirectiveService.mappingTypes.EXPRESSION):MappingDirectiveService.checkStagingColHasLookupExpressionInMappingFields(trgCol)&&(expression=trgCol.mapping_data.lookup.lookup_expression,link_type=MappingDirectiveService.mappingTypes.LOOKUP),expression){var staging=trgCol;angular.forEach(expression.alias,function(item){var alias_name=MappingDirectiveService.getLookupAliasParameterNameClean(item.alias_parameter),sourceItemData=MappingDirectiveService.findItemInSource(alias_name);sourceItemData&&staging&&temp_links.push({source:{link_name:alias_name,link_type:link_type,data:sourceItemData},target:{link_name:staging.name_intern,link_type:link_type,data:staging}})})}}),Array.prototype.push.apply(scope.Links,temp_links),BUILD_LINKS(),MappingDirectiveService.data.api.on_action_bar_loaded&&MappingDirectiveService.data.api.on_action_bar_loaded()}scope.search_array=[],scope.$on("$destroy",function(){ArrayUtils.emptyArray(scope.actionBarActions),ArrayUtils.emptyArray(scope.search_array)}),MappingDirectiveService.INIT(scope.data),scope.INIT=function(){MappingDirectiveService.data.api.render=scope.onResize},build_search_data(),scope.actionBarActions=angular.copy(scope.data.actions);var rectWidth=.3*element.width();scope.search_text="",scope.drag_info={message:"",color:""},scope.Links=[],scope.isDragging=!1,scope.idCounter=0,scope.settings={max_text_length:34,rectHeight:32,rectWidth:rectWidth,portSize:20,portMargin:-10,rectMargin:0,mapItem:"mapItem",sourceMap:"sourceMap",targetMap:"targetMap",sourceMappingClassName:"sourceMapping",sourceMappingItemIdName:"source_",stagingMappingClassName:"stagingMapping",stagingMappingItemIdName:"staging_",linksGroupClassName:"linksGroup",linkClassName:"Link",linkMapClassName:"mapLink",linkExpressionClassName:"expressionLink",linkRemoveClassName:"mapLinkRemove",linkRemoveTitleClassName:"mapLinkRemoveTitle",colNameClass:"colName",colNameToolTipClass:"colToolTipName",colNameTypeClass:"colNameType",draggerClass:"dragger",editExpressionClass:"editExpression",editLookupClass:"editLookup",editExpressionTitleClass:"editExpressionTitle",editLookupTitleClass:"editExpressionTitle",editAggregationClass:"editAggregation",margin:{left:15,right:20,top:15,bottom:15}};var getColumnType=function(d,isSourceNode){var name=isSourceNode?d[DO.Column.data_type]:d[DO.StagingColumn.data_type],length=isSourceNode?d[DO.Column.size]:d[DO.StagingColumn.size],scale=isSourceNode?d[DO.Column.scale]:d[DO.StagingColumn.scale];return MappingDirectiveService.getColumnDataTypeDisplayName(name,length,scale)},INIT_SVG=function(scope){null==scope.svg&&(scope.svg=d3.select(element.find("svg")[0])),null==scope.svg.select("#blur").node()&&scope.svg.append("defs").append("filter").attr("id","blur").append("feGaussianBlur").attr("stdDeviation",2.5),scope.svg.node()&&null==scope.svg.select(".temp.line").node()&&scope.svg.append("path").attr("class","temp line").attr("fill","none").attr("stroke","silver").style("stroke-width","2").style("stroke-dasharray","5, 5"),null==scope.diagonal&&(scope.diagonal=d3.svg.diagonal().source(function(d){return{x:d.source.y,y:d.source.x}}).target(function(d){return{x:d.target.y,y:d.target.x}}).projection(function(d){return[d.y,d.x]})),scope.data.allow_drag_drop&&null==scope.drag&&(scope.drag=d3.behavior.drag().on("dragstart",function(){dragstart(this,scope)}).on("drag",function(){dragmove(this,scope)}).on("dragend",function(){dragEnd(this,scope)}))},BUILD_SOURCE=function(newVal){INIT_SVG(scope),null==scope.sourceMapping&&(scope.sourceMapping=scope.svg.append("g").attr("class",scope.settings.sourceMappingClassName).attr("transform","translate("+[scope.settings.margin.left,0]+") scale(1)"));var sourceNodes=scope.sourceMapping.selectAll("."+scope.settings.mapItem).data(newVal,function(d){return d.id||(d.id=++scope.idCounter)});sourceNodes.exit().remove();var sourceNodeEnter=sourceNodes.enter().append("g").attr("class",scope.settings.mapItem+" "+scope.settings.sourceMap).attr("id",function(d){return scope.settings.sourceMappingItemIdName+d.name}).attr("transform",function(d,i){d.isStaging=!1,d.isSource=!0,d.y=scope.settings.margin.top+i*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.rectHeight/2,d.x=scope.settings.margin.left+scope.settings.rectWidth;var translate=[0,i*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.margin.top];return"translate("+translate+")"}).on("mouseover",null).on("mouseover",function(){d3.select(this).select(".port").style("visibility","visible")}).on("mouseleave",null).on("mouseleave",function(){d3.select(this).select(".port").style("visibility","hidden")});sourceNodeEnter.each(function(d){addItem(this,d,scope,!0)}),calc_height()},BUILD_STAGING_TARGET=function(newVal){INIT_SVG(scope),null==scope.stagingMapping&&(scope.stagingMapping=scope.svg.append("g").attr("class",scope.settings.stagingMappingClassName).attr("transform","translate("+[element.width()-scope.settings.rectWidth-scope.settings.margin.right,0]+") scale(1)"));var stagingNodes=scope.stagingMapping.selectAll("."+scope.settings.mapItem).data(newVal,function(d){return d.id||(d.id=++scope.idCounter)}),stagingNodeEnter=stagingNodes.enter().append("g").attr("class",scope.settings.mapItem+" "+scope.settings.targetMap).attr("id",function(d){return scope.settings.stagingMappingItemIdName+d.name}).attr("transform",function(d,i){d.isStaging=!0,d.isSource=!1,d.y=scope.settings.margin.top+i*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.rectHeight/2,d.x=element.width()-scope.settings.rectWidth-scope.settings.margin.right;var translate=[0,i*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.margin.top];return"translate("+translate+")"});stagingNodes.exit().remove(),stagingNodeEnter.each(function(d){addItem(this,d,scope,!1)});var nodeUpdate=stagingNodes.transition().duration(0).attr("",function(){});nodeUpdate.each(function(d){addExpressionBuilderIndication(this,d),addLookupIndication(this,d)}),calc_height()},BUILD_LINKS=function(){INIT_SVG(scope),null==scope.linksGroup&&(scope.linksGroup=scope.svg.append("g").attr("class",scope.settings.linksGroupClassName).attr("transform","translate("+[0,0]+") scale(1)"));var link=scope.linksGroup.selectAll("path."+scope.settings.linkClassName).data(scope.Links.reverse());scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).remove();var link_remove=scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).data(scope.Links.reverse());0==scope.Links.length&&scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).remove(),link.attr("d",function(d){return scope.diagonal({source:d.source.data,target:d.target.data})});var linkUpdate=link.transition().duration(0).attr("",function(){});linkUpdate.each(function(){d3.select(this).attr("class",getPathClassName)});link.enter().append("path").attr("class",getPathClassName).attr("d",function(d){return scope.diagonal({source:d.source.data,target:d.target.data})}).on("mouseover",onMouseOverPath).on("mouseleave",onMouseLeavePath);angular.forEach(scope.Links,function(item){var img=null;if(item.source.link_type==MappingDirectiveService.mappingTypes.DIRECT)img=addDeleteImage(item),img.attr("id",function(){return item.source.link_name});else{var expressionDelete=scope.linksGroup.select("#"+item.target.link_name);null==expressionDelete.node()&&(img=addDeleteImage(item),img.attr("id",function(){return item.target.link_name}))}img&&null!=img.node()&&img.on("click",function(){if(scope.data.allow_drag_drop){var removed=!1;removed=item.source.link_type==MappingDirectiveService.mappingTypes.DIRECT?MappingDirectiveService.removeMapping(item.target.data.name_intern):MappingDirectiveService.removeExpression(item.target.data.name_intern,item.source.link_type),removed&&d3.select(this).remove()}})}),link.exit().remove(),link_remove.exit(function(){}).remove()},addDeleteImage=function(item){var img=scope.linksGroup.append("image").attr("cursor","pointer").attr("class",scope.settings.linkRemoveClassName).attr("xlink:href",function(){return scope.data.allow_drag_drop?"shared/images/close_x.svg":""}).attr("x",function(){return item.target.data.x-15}).attr("y",function(){return item.target.data.y-8}).attr("d",item).attr("width",15).attr("height",15).style("visibility","visible").style("opacity","0.7"),img_title=img.select("."+scope.settings.linkRemoveTitleClassName),link_type_display_name=MappingDirectiveService.getMappingTypeDisplayName(item.source.link_type);return null==img_title.node()&&(img_title=img.append("title").attr("class",scope.settings.linkRemoveTitleClassName),img_title.text("Delete "+link_type_display_name)),img},calc_height=function(){var s=0,t=0;s=null!=scope.sourceMapping?scope.sourceMapping.node().getBBox().height:0,t=null!=scope.stagingMapping?scope.stagingMapping.node().getBBox().height:0,scope.svg&&scope.svg.node()&&scope.svg.attr("height",Math.max(s,t)+30)},removeAllSelection=function(source){source?null!=scope.sourceMapping&&(scope.sourceMapping.selectAll("."+scope.settings.mapItem+" > rect.selected").classed("selected",!1),scope.sourceMapping.selectAll("."+scope.settings.mapItem+" > rect.selected2").classed("selected2",!1)):null!=scope.stagingMapping&&(scope.stagingMapping.selectAll("."+scope.settings.mapItem+" > rect.selected").classed("selected",!1),scope.stagingMapping.selectAll("."+scope.settings.mapItem+" > rect.selected2").classed("selected2",!1))},getSelectedItem=function(from_source){var item=null,node=null;if(from_source?null!=scope.sourceMapping&&(node=scope.sourceMapping.selectAll("."+scope.settings.mapItem+" > rect.selected")):null!=scope.stagingMapping&&(node=scope.stagingMapping.selectAll("."+scope.settings.mapItem+" > rect.selected")),node&&node.node&&node.node()){var temp=node.data();angular.isArray(temp)&&temp.length>0&&(item=temp[0])}return item},onDragging=function(isDragging){isDragging?scope.stagingMapping.selectAll(".port").style("visibility","visible"):scope.stagingMapping.selectAll(".port").style("visibility","hidden")};scope.onDiagramSearchItemChanged=function(){""==scope.search_text&&(removeAllSelection(!0),removeAllSelection(!1))},scope.onDiagramSearchItemSelected=function(item){removeAllSelection(!0),removeAllSelection(!1);var is_landing=-1!=item.indexOf(MappingDirectiveService.landing_search_prefix),item_name=item.replace(MappingDirectiveService.landing_search_prefix,"").replace(MappingDirectiveService.staging_search_prefix,""),el=null;el=is_landing?d3.select("#"+scope.settings.sourceMappingItemIdName+item_name).node():d3.select("#"+scope.settings.stagingMappingItemIdName+item_name).node(),el&&(el.scrollIntoView(),d3.select(el).select("rect").classed("selected2",!0))},scope.onResize=function(isMaximize){if(0!=element.width()){var rectWidth=isMaximize?.3*element.width():scope.settings.rectWidth,maxTextLength=isMaximize?1.5*scope.settings.max_text_length:scope.settings.max_text_length;null!=scope.sourceMapping&&(scope.sourceMapping.selectAll("rect").attr("width",rectWidth),scope.sourceMapping.selectAll("image").attr("x",rectWidth+scope.settings.portMargin),scope.sourceMapping.selectAll("."+scope.settings.colNameClass).text(function(d){return Utils.shortenText(d.name,maxTextLength,!0)}),scope.sourceMapping.selectAll("."+scope.settings.colNameTypeClass).text(function(d){return getColumnType(d,!0)}),scope.sourceMapping.selectAll("."+scope.settings.colNameClass).each(function(d){addNodeToolTip(this,d.name)})),null!=scope.stagingMapping&&(scope.stagingMapping.attr("transform","translate("+[element.width()-rectWidth-scope.settings.margin.right,0]+") scale(1)"),scope.stagingMapping.selectAll("rect").attr("width",rectWidth),scope.stagingMapping.selectAll("."+scope.settings.colNameClass).text(function(d){return Utils.shortenText(d.name,maxTextLength,!0)}),scope.stagingMapping.selectAll("."+scope.settings.colNameTypeClass).text(function(d){return getColumnType(d,!1)}),scope.stagingMapping.selectAll("."+scope.settings.colNameClass).each(function(d){addNodeToolTip(this,d.name)}),scope.stagingMapping.selectAll("."+scope.settings.editExpressionClass).attr("x",rectWidth-25),scope.stagingMapping.selectAll("."+scope.settings.editLookupClass).attr("x",rectWidth-50)),null!=scope.linksGroup&&(scope.linksGroup.selectAll("."+scope.settings.linkRemoveClassName).remove(),scope.linksGroup.selectAll("."+scope.settings.linkClassName).remove()),angular.forEach(scope.data.target_columns,function(item,idx){item.y=scope.settings.margin.top+idx*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.rectHeight/2,item.x=element.width()-rectWidth-scope.settings.margin.right}),angular.forEach(scope.data.source_columns,function(item,idx){item.y=scope.settings.margin.top+idx*(scope.settings.rectHeight+scope.settings.rectMargin)+scope.settings.rectHeight/2,item.x=scope.settings.margin.left+rectWidth}),scope.data.allow_drag_drop&&scope.svg.selectAll("."+scope.settings.draggerClass).attr("cx",rectWidth),BUILD_LINKS_DATA()}},scope.INIT(),scope.$watch("data.source_columns",function(newVal,oldVal){null==newVal||0==newVal.length?(BUILD_LINKS_DATA(),BUILD_LINKS(),BUILD_SOURCE(newVal,oldVal)):BUILD_SOURCE(newVal,oldVal)},!0),scope.$watch("data.target_columns",BUILD_STAGING_TARGET,!0),scope.$watch("data.fields_mapping",BUILD_LINKS_DATA,!0),scope.$watch("data.is_aggregated",onChangeAggregate,!0),scope.$watch("search_text",onSearch,!0),scope.$watch(function(){return element.width()},function(newValue,oldValue){newValue!=oldValue&&scope.onResize(newValue>oldValue)})}}}])}(angular);
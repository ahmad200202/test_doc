describe("collapse directive",function(){function initCallbacks(){scope.collapsing=jasmine.createSpy("scope.collapsing"),scope.collapsed=jasmine.createSpy("scope.collapsed"),scope.expanding=jasmine.createSpy("scope.expanding"),scope.expanded=jasmine.createSpy("scope.expanded")}function assertCallbacks(expected){["collapsing","collapsed","expanding","expanded"].forEach(function(cbName){expected[cbName]?expect(scope[cbName]).toHaveBeenCalled():expect(scope[cbName]).not.toHaveBeenCalled()})}var element,compileFn,scope,$compile,$animate,$q;beforeEach(module("ui.bootstrap.collapse")),beforeEach(module("ngAnimateMock")),beforeEach(inject(function(_$rootScope_,_$compile_,_$animate_,_$q_){scope=_$rootScope_,$compile=_$compile_,$animate=_$animate_,$q=_$q_})),beforeEach(function(){element=angular.element('<div uib-collapse="isCollapsed" expanding="expanding()" expanded="expanded()" collapsing="collapsing()" collapsed="collapsed()">Some Content</div>'),compileFn=$compile(element),angular.element(document.body).append(element)}),afterEach(function(){element.remove()}),it("should be hidden on initialization if isCollapsed = true",function(){initCallbacks(),scope.isCollapsed=!0,compileFn(scope),scope.$digest(),expect(element.height()).toBe(0),assertCallbacks({collapsed:!0})}),it("should not trigger any animation on initialization if isCollapsed = true",function(){var wrapperFn=function(){$animate.flush()};scope.isCollapsed=!0,compileFn(scope),scope.$digest(),expect(wrapperFn).toThrowError(/No pending animations ready to be closed or flushed/)}),it("should collapse if isCollapsed = true on subsequent use",function(){scope.isCollapsed=!1,compileFn(scope),scope.$digest(),initCallbacks(),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),expect(element.height()).toBe(0),assertCallbacks({collapsing:!0,collapsed:!0})}),it("should show after toggled from collapsed",function(){initCallbacks(),scope.isCollapsed=!0,compileFn(scope),scope.$digest(),expect(element.height()).toBe(0),assertCallbacks({collapsed:!0}),scope.collapsed.calls.reset(),scope.isCollapsed=!1,scope.$digest(),$animate.flush(),expect(element.height()).not.toBe(0),assertCallbacks({expanding:!0,expanded:!0})}),it("should not trigger any animation on initialization if isCollapsed = false",function(){var wrapperFn=function(){$animate.flush()};scope.isCollapsed=!1,compileFn(scope),scope.$digest(),expect(wrapperFn).toThrowError(/No pending animations ready to be closed or flushed/)}),it("should expand if isCollapsed = false on subsequent use",function(){scope.isCollapsed=!1,compileFn(scope),scope.$digest(),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),initCallbacks(),scope.isCollapsed=!1,scope.$digest(),$animate.flush(),expect(element.height()).not.toBe(0),assertCallbacks({expanding:!0,expanded:!0})}),it("should collapse if isCollapsed = true on subsequent uses",function(){scope.isCollapsed=!1,compileFn(scope),scope.$digest(),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),scope.isCollapsed=!1,scope.$digest(),$animate.flush(),initCallbacks(),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),expect(element.height()).toBe(0),assertCallbacks({collapsing:!0,collapsed:!0})}),it("should change aria-expanded attribute",function(){scope.isCollapsed=!1,compileFn(scope),scope.$digest(),expect(element.attr("aria-expanded")).toBe("true"),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),expect(element.attr("aria-expanded")).toBe("false")}),it("should change aria-hidden attribute",function(){scope.isCollapsed=!1,compileFn(scope),scope.$digest(),expect(element.attr("aria-hidden")).toBe("false"),scope.isCollapsed=!0,scope.$digest(),$animate.flush(),expect(element.attr("aria-hidden")).toBe("true")}),describe("dynamic content",function(){var element;beforeEach(function(){element=angular.element('<div uib-collapse="isCollapsed"><p>Initial content</p><div ng-show="exp">Additional content</div></div>'),$compile(element)(scope),angular.element(document.body).append(element)}),afterEach(function(){element.remove()}),it("should grow accordingly when content size inside collapse increases",function(){scope.exp=!1,scope.isCollapsed=!1,scope.$digest();var collapseHeight=element.height();scope.exp=!0,scope.$digest(),expect(element.height()).toBeGreaterThan(collapseHeight)}),it("should shrink accordingly when content size inside collapse decreases",function(){scope.exp=!0,scope.isCollapsed=!1,scope.$digest();var collapseHeight=element.height();scope.exp=!1,scope.$digest(),expect(element.height()).toBeLessThan(collapseHeight)})}),describe("expanding callback returning a promise",function(){var defer,collapsedHeight;beforeEach(function(){defer=$q.defer(),scope.isCollapsed=!0,scope.expanding=function(){return defer.promise},compileFn(scope),scope.$digest(),collapsedHeight=element.height(),scope.isCollapsed=!1,scope.$digest(),expect(element.attr("aria-expanded")).not.toBe("true"),expect(element.height()).toBe(collapsedHeight)}),it("should wait for it to resolve before animating",function(){defer.resolve(),scope.$digest(),$animate.flush(),expect(element.attr("aria-expanded")).toBe("true"),expect(element.height()).toBeGreaterThan(collapsedHeight)}),it("should not animate if it rejects",function(){defer.reject(),scope.$digest(),expect(element.attr("aria-expanded")).not.toBe("true"),expect(element.height()).toBe(collapsedHeight)})}),describe("collapsing callback returning a promise",function(){var defer,expandedHeight;beforeEach(function(){defer=$q.defer(),scope.isCollapsed=!1,scope.collapsing=function(){return defer.promise},compileFn(scope),scope.$digest(),expandedHeight=element.height(),scope.isCollapsed=!0,scope.$digest(),expect(element.attr("aria-expanded")).not.toBe("false"),expect(element.height()).toBe(expandedHeight)}),it("should wait for it to resolve before animating",function(){defer.resolve(),scope.$digest(),$animate.flush(),expect(element.attr("aria-expanded")).toBe("false"),expect(element.height()).toBeLessThan(expandedHeight)}),it("should not animate if it rejects",function(){defer.reject(),scope.$digest(),expect(element.attr("aria-expanded")).not.toBe("false"),expect(element.height()).toBe(expandedHeight)})})});
!function(angular){var attDisplayModel=angular.module(window.AppName+".attDisplayModel",[]),MIN_GRAPH_ZOOM=.075,MAX_GRAPH_ZOOM=2.5;attDisplayModel.directive("attDisplayModel",["$timeout",function($timeout){return{restrict:"E",scope:{data:"=",options:"=?",api:"=?",recreateOnChange:"=?"},templateUrl:"views/common/diagramTemplate.html",link:function(scope,element){var xtrace=null;scope.$on("$destroy",function(){xtrace&&xtrace.onDestrory&&xtrace.onDestrory(),xtrace=null});var initGraph=function(){element.find("#graphWrapper").addClass("att_display_model"),null==scope.api&&(scope.api={}),null==scope.options&&(scope.options={}),null==scope.recreateOnChange&&(scope.recreateOnChange=!1),scope.selected_node=null,scope.search_data=[],scope.date_model_exists=!1,scope.add_resize_listener=!1,scope.isInZoom=!1,scope.add_resize_listener&&addResizeListener(element.find("#graphWrapper")[0],function(){scope.onResize()}),scope.directions=[{name:"Right to Left",value:"LR"},{name:"Left to Right",value:"RL"},{name:"Top to Bottom",value:"BT"},{name:"Bottom to Top",value:"TB"}],scope.direction=scope.directions[1],scope.minZoomVal=MIN_GRAPH_ZOOM,scope.maxZoomVal=MAX_GRAPH_ZOOM,scope.sliderStep=(scope.maxZoomVal-scope.minZoomVal)/10,scope.slider={sliderStep:scope.sliderStep,slider_data:{slider_val:1,options:{slide:function(){$(this).attr("previous-val",$(this).slider("value"))},start:function(){},stop:function(event,ui){xtrace&&xtrace.fnOnZoom(ui.value>$(this).attr("previous-val"),ui.value,!0,null)}}}}};initGraph();var isReferenceEntity=function(item){return item&&item.is_reference_entity},isDateTimeModelEntity=function(item){return item&&0!=item.time_model_entity_id&&isReferenceEntity(item)};null!=scope.data&&angular.isDefined(scope.data)&&(scope.date_model_exists=scope.data.filter(function(item){return isDateTimeModelEntity(item)}).length>0),scope.onResize=function(){xtrace&&xtrace.onResize()},scope.buildSearchData=function(){scope.search_data.splice(0,scope.search_data.length),angular.forEach(scope.data,function(item){scope.search_data.indexOf(item.node_id)<0&&scope.search_data.push(item.node_id),item.children&&item.children.length>0&&angular.forEach(item.children,function(child){scope.search_data.indexOf(child)<0&&scope.search_data.push(child)})})},scope.updateSelectedNode=function(){if(null!=scope.selected_node){var filtered=scope.data.filter(function(node){return scope.selected_node.report.node_id==node.node_id&&scope.selected_node.report.item_id==node.item_id});scope.selected_node.report=filtered[0]}},scope.onSearchChange=function(){xtrace&&(""==scope.options.search_term&&xtrace.fnCenterGraph(!0,!0,!0),xtrace.fnSelectNode(scope.options.search_term,!0,!1))},scope.onSearchItemSelected=function($item){xtrace&&xtrace.fnSelectNode($item,!0,!0)},scope.onZoom=function(zoomIn){zoomIn?scope.slider.slider_data.slider_val+=scope.slider.sliderStep:scope.slider.slider_data.slider_val-=scope.slider.sliderStep,xtrace.fnOnZoom(zoomIn,scope.slider.slider_data.slider_val,!0,null)},scope.onResetZoomPan=function(){xtrace&&(xtrace.fnCenterGraph(!0,!0,!0),scope.slider.slider_data.slider_val=xtrace.fnGetScale())},scope.onHandleFKPKKeys=function(){xtrace&&xtrace.handlePkFk(scope.options.show_fk,scope.options.show_pk)},scope.onHandleChangeDirection=function(dir){xtrace&&xtrace.changeDirection(dir.value)},scope.onHandleTooltips=function(){xtrace&&xtrace.handleToolTips(scope.options.show_tooltips)},scope.onHideDateModel=function(){xtrace&&xtrace.onHideItemsByProp(scope.options.show_date_model,function(item){return isDateTimeModelEntity(item.report)})},scope.onAttributePanelMouseEnter=function(attr){xtrace&&attr&&attr.is_fk&&xtrace.fnSelectNode(attr.entity.name,!0,!1)},scope.onAttributePanelMouseLeave=function(){xtrace&&xtrace.fnSelectNode("",!0,!1)},scope.onAttributePanelMouseClick=function(attr){xtrace&&attr&&attr.is_fk&&xtrace.fnSelectNode(attr.entity.name,!0,!0)},scope.api.selectNode=function(node_name){xtrace&&xtrace.fnSelectNode(node_name,!1,!0)},scope.getAttributeName=function(attr,full){var ret="",prefix=attr.prefix||"";return ret=attr.is_fk?"("+composeConsts.FK_Prefix+") "+prefix+attr.entity.name:""!=attr.attribute_name?full?"Attribute Name: "+attr.attribute_name+"\r\nAttribute Domain: "+attr.domainAttribute.name:prefix+" "+attr.attribute_name:full?"Domain Attribute: "+attr.domainAttribute.name:prefix+attr.domainAttribute.name};var graph_params={lightweight:null==scope.options.lightweight?!1:scope.options.lightweight,minZoomVal:scope.minZoomVal,maxZoomVal:scope.maxZoomVal,allow_selection:scope.options.allow_selection,allow_drag_drop:scope.options.allow_drag_drop,show_tooltips:scope.options.allow_tooltips,date_model_title:scope.options.date_model_title,date_time_node_ids:[composeConsts.DATE_TIME_ENTITY_IDS.DATE.id,composeConsts.DATE_TIME_ENTITY_IDS.TIME.id],direction:scope.direction.value,allow_context_menu:scope.options.allow_context_menu,show_minimap:null==scope.options.show_minimap?!0:scope.options.show_minimap,show_console_logs:1==window.dbg,max_scale:1.5,onNodeClick:function(node){scope.selected_node=node,scope.options.onNodeClick&&scope.options.onNodeClick(node)},onNodeDbClick:function(items){scope.options.onNodeDbClick&&scope.options.onNodeDbClick(items,function(nodes){scope.data.splice(0,scope.data.length),Array.prototype.push.apply(scope.data,nodes)})},onMenuAddRelation:function(node,referredEntity){scope.options.onMenuAddRelation&&scope.options.onMenuAddRelation(node,referredEntity,function(nodes){scope.relation_node=node,scope.data.splice(0,scope.data.length),Array.prototype.push.apply(scope.data,nodes)})},onMenuDeleteRelation:function(source,target){scope.options.onMenuDeleteRelation&&scope.options.onMenuDeleteRelation(source,target,function(nodes){scope.data.splice(0,scope.data.length),Array.prototype.push.apply(scope.data,nodes)})},onMenuEntityLineage:scope.options.onMenuEntityLineage,onZoomStartFunc:function(){scope.isInZoom=!0,scope.$applyAsync()},onZoomEndFunc:function(translateVal,zoomVal){scope.isInZoom=!1,scope.$applyAsync(),scope.slider.slider_data.slider_val=zoomVal}},createXTraceDAGGraph=function(){return new XTraceDAG(element.find("#graphWrapper")[0],scope.data,graph_params)};scope.BUILD_GRAPH=function(){if(scope.buildSearchData(),scope.updateSelectedNode(),scope.recreateOnChange)xtrace&&(xtrace.onDestrory(),xtrace=null,element.find("#graphWrapper").addClass("att_display_model"),element.find("#graphWrapper").find("svg").remove()),xtrace=createXTraceDAGGraph();else if(xtrace){xtrace.updateGraphData(scope.data,scope.options.show_fk,scope.options.show_pk);var node_name=scope.relation_node?scope.relation_node.node_name:"";xtrace.fnSelectNodeNoScale(node_name,!0,!0),scope.relation_node=null,scope.onHideDateModel()}else element.find("#graphWrapper").addClass("att_display_model"),element.find("#graphWrapper").find("svg").remove(),xtrace=createXTraceDAGGraph();$timeout(function(){(scope.options.show_fk||scope.options.show_pk)&&scope.onHandleFKPKKeys(),scope.onHideDateModel()},300)},scope.$watchCollection("data",function(newVal){null!=newVal&&scope.BUILD_GRAPH()})}}}])}(angular);
!function(angular){var MIN_GRAPH_ZOOM=.075,MAX_GRAPH_ZOOM=4,attStarSchema=angular.module(window.AppName+".attStarSchema",[]);attStarSchema.directive("attStarSchema",["$timeout",function($timeout){return{restrict:"E",replace:!0,scope:{data:"=",options:"=?",onNodeClick:"&",onNodeDblClick:"&",api:"=?"},templateUrl:"views/common/diagramTemplate.html",link:function(scope,element){scope.angleOffsetFromCenter=0,scope.$on("$destroy",function(){scope.data.nodes=null,theGraph&&theGraph.destroy(),element.find("#graphWrapper").empty(),removeResizeListener(element[0],scope.onResize)}),scope.onResize=function(){theGraph.fnCenterGraph()},addResizeListener(element[0],scope.onResize);var theGraph=null,getLinkMinLength=function(newVal){var linkMinLength=500,itemsCount=newVal.length;return 11>=itemsCount&&(linkMinLength=300),scope.angleOffsetFromCenter=11==itemsCount?0:0,linkMinLength};null==scope.options&&(scope.options={}),null==scope.api&&(scope.api={}),scope.default_translate=[40,0],scope.default_scale=1,scope.isWorking=null,scope.isInZoom=!1,scope.minZoomVal=MIN_GRAPH_ZOOM,scope.maxZoomVal=MAX_GRAPH_ZOOM,scope.slider={sliderStep:(scope.maxZoomVal-scope.minZoomVal)/10,slider_data:{slider_val:1,options:{slide:function(){},start:function(){},stop:function(event,ui){theGraph&&theGraph.fnSetZoomScale(null,ui.value,!0,scope.onZoomStartFunc,scope.onZoomEndFunc)}}}},scope.onZoomStartFunc=function(){scope.isInZoom=!0,scope.$applyAsync()},scope.onZoomEndFunc=function(translateVal,zoomVal){scope.options.allow_zoom&&(scope.isInZoom=!1,scope.$applyAsync(),scope.slider.slider_data.slider_val=zoomVal)},scope.onZoom=function(zoomIn){var zoomAllowed=!0;zoomIn?scope.slider.slider_data.slider_val+scope.slider.sliderStep<=scope.maxZoomVal?scope.slider.slider_data.slider_val+=scope.slider.sliderStep:zoomAllowed=!1:scope.slider.slider_data.slider_val-scope.slider.sliderStep>=scope.minZoomVal?scope.slider.slider_data.slider_val-=scope.slider.sliderStep:zoomAllowed=!1,theGraph&&zoomAllowed&&theGraph.onZoomManual(zoomIn,!0,scope.onZoomStartFunc,scope.onZoomEndFunc)},scope.onResetZoomPan=function(){theGraph&&(scope.slider.slider_data.slider_val=scope.default_scale,theGraph.fnCenterGraph())};var graph_options={zoomPanEnabled:scope.options.allow_zoom,zoom_duration:scope.options.zoom_duration,dynamic:!1,minZoomVal:scope.minZoomVal,maxZoomVal:scope.maxZoomVal,onZoomEnd:function(translate,scale){scope.isInZoom=!1,scope.slider.slider_data.slider_val=scale},nodeEvents:{dblclick:function(node){scope.onNodeDblClick({node:node})},click:function(node){scope.options.allow_selection&&(angular.forEach(element.find(".node"),function(el){d3.select(el).classed("selected",!1)}),d3.select(this).classed("selected",!0)),scope.onNodeClick({node:node})}}};scope.api.selectNode=function(node){if(theGraph){var filtered_nodes=scope.data.nodes.filter(function(node_item){return node_item.data.id==node.id});filtered_nodes.length>0&&theGraph.selectNode(filtered_nodes[0])}},scope.isFirstRender=!0,scope.graghData={nodes:[],edges:[]},scope.createStarSchema=function(newVal){scope.graghData.nodes.splice(0,scope.graghData.nodes.length),scope.graghData.edges.splice(0,scope.graghData.edges.length),Array.prototype.push.apply(scope.graghData.nodes,scope.data.nodes),Array.prototype.push.apply(scope.graghData.edges,scope.data.edges),graph_options.layout=new AttuGraph.layouts.starSchema({r:getLinkMinLength(newVal),angleOffsetFromCenter:scope.angleOffsetFromCenter}),null==theGraph?(element.find("#graphWrapper").addClass("att_star_schema"),theGraph=new AttuGraph.GraphComponent(element.find("#graphWrapper")[0],scope.graghData,graph_options)):theGraph.draw(),$timeout(function(){if(scope.isFirstRender){var scaleLimit=(element.find("#graphWrapper").height()-60)/2/300;theGraph.fnCenterGraph(!0,!0),scope.slider.slider_data.slider_val=theGraph.state.scale-.15,scope.slider.slider_data.slider_val=Math.min(scope.slider.slider_data.slider_val,scaleLimit),theGraph.fnSetZoomScale(theGraph.state.translate,scope.slider.slider_data.slider_val,scope.onZoomStartFunc,scope.onZoomEndFunc),theGraph.fnCenterGraph(!0,!1),scope.isFirstRender=!1}})},scope.$watchCollection("data.nodes",function(newVal){null!=newVal&&(scope.isWorking=null,scope.createStarSchema(newVal))})}}}])}(angular);
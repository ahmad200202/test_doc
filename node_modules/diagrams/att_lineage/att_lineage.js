!function(angular){var attLineage=angular.module(window.AppName+".attLineage",[]),MIN_GRAPH_ZOOM=.075,MAX_GRAPH_ZOOM=4;attLineage.directive("attLineage",["$timeout",function($timeout){return{restrict:"E",scope:{id:"@","class":"@",data:"=",options:"=?",onClick:"&"},templateUrl:"views/common/diagramTemplate.html",link:function(scope,element){element.find("#graphWrapper").addClass("att_lineage");var theGraph=null,theGraphEL=null;scope.default_translate=[40,180],scope.default_scale=1;var NODE_SEP=50,EDGE_SEP=12,RANK_SEP=100;scope.isInZoom=!1,scope.search_data=[],scope.minZoomVal=MIN_GRAPH_ZOOM,scope.maxZoomVal=MAX_GRAPH_ZOOM,scope.sliderStep=(scope.maxZoomVal-scope.minZoomVal)/10,scope.slider={sliderStep:scope.sliderStep,slider_data:{slider_val:1,options:{slide:function(){},start:function(){},stop:function(event,ui){theGraph&&theGraph.fnSetZoomScale(null,ui.value,!0,scope.onZoomStartFunc,scope.onZoomEndFunc)}}}},scope.onSearchChange=function(){scope.highlightNode(!1)},scope.onSearchItemSelected=function(){scope.highlightNode(!0)},scope.onZoomStartFunc=function(){scope.isInZoom=!0,scope.$applyAsync()},scope.onZoomEndFunc=function(translateVal,zoomVal){scope.onResize(),scope.options.allow_zoom&&(scope.isInZoom=!1,scope.$applyAsync(),scope.slider.slider_data.slider_val=zoomVal)},scope.onZoom=function(zoomIn){var zoomAllowed=!0;zoomIn?scope.slider.slider_data.slider_val+scope.slider.sliderStep<=scope.maxZoomVal?scope.slider.slider_data.slider_val+=scope.slider.sliderStep:zoomAllowed=!1:scope.slider.slider_data.slider_val-scope.slider.sliderStep>=scope.minZoomVal?scope.slider.slider_data.slider_val-=scope.slider.sliderStep:zoomAllowed=!1,theGraph&&zoomAllowed&&theGraph.onZoomManual(zoomIn,!0,scope.onZoomStartFunc,scope.onZoomEndFunc)},scope.onResetZoomPan=function(){theGraph&&(scope.slider.slider_data.slider_val=scope.default_scale,theGraph.fnSetZoomScale(scope.default_translate,scope.default_scale,!0,scope.onZoomStartFunc,scope.onZoomEndFunc))},angular.forEach(scope.data.nodes,function(item){scope.search_data.indexOf(item.display_name)<0&&scope.search_data.push(item.display_name)}),scope.getSectionCount=function(){var all_nodes=[];all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.ReplicateSource.type})),all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.ReplicateTask.type})),all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.Mappings.type})),all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.DataMarts.type})),all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.DataMarts.Entity})),all_nodes.push(ArrayUtils.find(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.Landing.type})),all_nodes=ArrayUtils.clean(all_nodes,void 0);var mapping_nodes=ArrayUtils.filter(scope.data.nodes,function(item){return item.type==Lineage.LineageTypes.Landing.type});return all_nodes.length>4&&(RANK_SEP=50),mapping_nodes.length>10&&(NODE_SEP=25),all_nodes.length},scope.getSectionCount(),scope.layout=new AttuGraph.layouts.dagreLayout({nodeSep:NODE_SEP,edgeSep:EDGE_SEP,rankSep:RANK_SEP,rankDir:"LR"}),theGraph=new AttuGraph.GraphComponent(element.find("#graphWrapper")[0],{nodes:scope.data.nodes,edges:scope.data.edges},{layout:scope.layout,zoomPanEnabled:scope.options.allow_zoom,zoom_duration:scope.options.zoom_duration,minZoomVal:scope.minZoomVal,maxZoomVal:scope.maxZoomVal,onZoomEnd:function(translate,scale){scope.slider.slider_data.slider_val=scale},nodeEvents:{click:function(node){d3.event&&d3.event.srcElement&&"tspan"==d3.event.srcElement.nodeName&&scope.onClick({node:node})},dblclick:function(){}},edgeEvents:{click:function(){}},graphEvents:{},dynamic:!1}),scope.INIT=function(){d3.select(element.find("#graphWrapper .rootSVG")[0]).attr("height","99%"),scope.svg=element.find("#graphWrapper .graph-attach"),theGraphEL=d3.select(element.find("#graphWrapper .graph")[0]),scope.addSections(),scope.addSectionsText(),scope.onResize(!1),$timeout(function(){scope.getSectionCount()>=2?theGraph.fnCenterGraph():theGraph.fnSetZoomScale(scope.default_translate,scope.default_scale,!0,null,null)},100)},scope.height=function(){var graph_height=d3.select(element.find("#graphWrapper .graph")[0]).node().getBBox().height+150,container_height=$("#graphWrapper").height()-30;return Math.max(graph_height,container_height)},scope.width=function(){return d3.select(element.find("#graphWrapper .graph-attach")[0]).node().getBBox().width+100},scope.addSections=function(){var nodes=[];nodes.push(ArrayUtils.find(theGraph.nodesList,function(item){return item.type==Lineage.LineageTypes.ReplicateTask.type})),nodes.push(ArrayUtils.find(theGraph.nodesList,function(item){return item.type==Lineage.LineageTypes.Mappings.type})),nodes.push(ArrayUtils.find(theGraph.nodesList,function(item){return item.type==Lineage.LineageTypes.DataMarts.type})),nodes=ArrayUtils.clean(nodes,void 0),d3.select(element.find("#graphWrapper .graph")[0]).selectAll(".section").remove();for(var i=0;i<nodes.length;i++){var curr_item=nodes[i],curr_itemPos=0;if(curr_item.type==Lineage.LineageTypes.Mappings.type||curr_item.type==Lineage.LineageTypes.ReplicateTask.type)curr_itemPos=curr_item.x+curr_item.width/2;else if(curr_item.type==Lineage.LineageTypes.DataMarts.type){var entityNode=ArrayUtils.find(theGraph.nodesList,function(item){return item.type==Lineage.LineageTypes.Entity.type});curr_itemPos=entityNode.x+entityNode.width+(curr_item.x-(entityNode.x+entityNode.width))/2}else curr_itemPos=curr_item.x-curr_item.width/2;d3.select(element.find("#graphWrapper .graph")[0]).insert("svg:line",":first-child").attr("type",curr_item.type).attr("class","section").attr("x1",curr_itemPos).attr("x2",curr_itemPos).attr("y1",0).attr("y2",d3.select(element.find("#graphWrapper .graph")[0]).node().getBBox().height)}},scope.addSectionsText=function(){d3.select(element.find("#graphWrapper .graph")[0]).selectAll(".section_text").remove();var text_map_to_node_type=[{name:Lineage.LineageTypes.ReplicateSource.display_name,node_type:Lineage.LineageTypes.ReplicateSource.type,x_pos_factor:70,y_pos_factor:-10},{name:Lineage.LineageTypes.Landing.display_name,node_type:Lineage.LineageTypes.Landing.type,x_pos_factor:80,y_pos_factor:-10},{name:Lineage.LineageTypes.Entity.display_name,node_type:Lineage.LineageTypes.Entity.type,x_pos_factor:-100,y_pos_factor:-10},{name:Lineage.LineageTypes.DataMarts.display_name,node_type:Lineage.LineageTypes.DataMarts.type,x_pos_factor:30,y_pos_factor:-10}];ArrayUtils.each(text_map_to_node_type,function(item_map){var first_node=ArrayUtils.find(theGraph.nodesList,function(item){return item.type==item_map.node_type});first_node&&d3.select(element.find("#graphWrapper .graph")[0]).insert("svg:text",":first-child").attr("class","section_text").attr("y",item_map.y_pos_factor).attr("x",first_node.x+item_map.x_pos_factor).text(item_map.name.replace("_"," "))})},scope.onResize=function(){scope.options.allow_zoom?element.find("#graphWrapper .rootSVG").attr("height","100%").attr("width","100%"):element.find("#graphWrapper .rootSVG").attr("height",scope.height()).attr("width",scope.width())},scope.highlightNode=function(set_selected){theGraphEL&&theGraphEL.selectAll(".node").each(function(d){""==scope.options.search_term?(d3.select(this).classed("selected",!1),d3.select(this).classed("hovered",!1),theGraph&&theGraph.fnSetZoomScale(scope.default_translate,scope.default_scale,!0,function(){scope.isInZoom=!0},function(){scope.isInZoom=!1,scope.onResize()})):set_selected?d.display_name.toLowerCase()==scope.options.search_term.toLowerCase()?(d3.select(this).classed("selected",!0),theGraph.fnCenterNode(d)):(d3.select(this).classed("selected",!1),d3.select(this).classed("hovered",!1)):d.display_name.toLowerCase().indexOf(scope.options.search_term.toLowerCase())>-1?d3.select(this).classed("hovered",!0):d3.select(this).classed("hovered",!1)})},scope.onChangeSearch=function(){scope.highlightNode(!1)},scope.onTypeaheadSelect=function(){scope.highlightNode(!0)},scope.INIT(),scope.$watch(function(){return element.find("#graphWrapper").width()},function(newValue,oldValue){}),scope.$watch(function(){return element.find("#graphWrapper").height()},function(newValue,oldValue){newValue!=oldValue&&scope.onResize(newValue>oldValue)})}}}])}(angular);
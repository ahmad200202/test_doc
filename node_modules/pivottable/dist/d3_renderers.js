(function(){var callWithJQuery;(callWithJQuery=function(pivotModule){return"object"==typeof exports&&"object"==typeof module?pivotModule(require("jquery"),require("d3")):"function"==typeof define&&define.amd?define(["jquery","d3"],pivotModule):pivotModule(jQuery,d3)})(function($,d3){return $.pivotUtilities.d3_renderers={Treemap:function(pivotData,opts){var addToTree,color,defaults,height,i,len,ref,result,rowKey,tree,treemap,value,width;for(defaults={localeStrings:{},d3:{width:function(){return $(window).width()/1.4},height:function(){return $(window).height()/1.4}}},opts=$.extend(!0,{},defaults,opts),result=$("<div>").css({width:"100%",height:"100%"}),tree={name:"All",children:[]},addToTree=function(tree,path,value){var child,i,len,newChild,ref,x;if(0===path.length)return void(tree.value=value);for(null==tree.children&&(tree.children=[]),x=path.shift(),ref=tree.children,i=0,len=ref.length;len>i;i++)if(child=ref[i],child.name===x)return void addToTree(child,path,value);return newChild={name:x},addToTree(newChild,path,value),tree.children.push(newChild)},ref=pivotData.getRowKeys(),i=0,len=ref.length;len>i;i++)rowKey=ref[i],value=pivotData.getAggregator(rowKey,[]).value(),null!=value&&addToTree(tree,rowKey,value);return color=d3.scale.category10(),width=opts.d3.width(),height=opts.d3.height(),treemap=d3.layout.treemap().size([width,height]).sticky(!0).value(function(d){return d.size}),d3.select(result[0]).append("div").style("position","relative").style("width",width+"px").style("height",height+"px").datum(tree).selectAll(".node").data(treemap.padding([15,0,0,0]).value(function(d){return d.value}).nodes).enter().append("div").attr("class","node").style("background",function(d){return null!=d.children?"lightgrey":color(d.name)}).text(function(d){return d.name}).call(function(){this.style("left",function(d){return d.x+"px"}).style("top",function(d){return d.y+"px"}).style("width",function(d){return Math.max(0,d.dx-1)+"px"}).style("height",function(d){return Math.max(0,d.dy-1)+"px"})}),result}}})}).call(this);